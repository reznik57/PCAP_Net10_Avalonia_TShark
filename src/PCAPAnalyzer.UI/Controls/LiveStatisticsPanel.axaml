<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels.Capture"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             x:Class="PCAPAnalyzer.UI.Controls.LiveStatisticsPanel"
             x:DataType="vm:LiveStatisticsViewModel"
             Background="{DynamicResource BackgroundDark}">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="16" Margin="16">
            <!-- Header -->
            <TextBlock Text="Live Statistics"
                       FontSize="{StaticResource FontSizeLarge}"
                       FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimary}"/>

            <!-- Session Duration -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="SESSION DURATION"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"/>
                    <TextBlock Text="{Binding SessionDuration}"
                               FontSize="{StaticResource FontSizeXL}"
                               FontWeight="Bold"
                               Foreground="{DynamicResource AccentCyan}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- Total Packets -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="TOTAL PACKETS"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"/>
                    <TextBlock Text="{Binding TotalPacketsFormatted}"
                               FontSize="{StaticResource FontSizeXL}"
                               FontWeight="Bold"
                               Foreground="{DynamicResource AccentBlue}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- Total Bytes -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="TOTAL BYTES"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"/>
                    <TextBlock Text="{Binding TotalBytesFormatted}"
                               FontSize="{StaticResource FontSizeXL}"
                               FontWeight="Bold"
                               Foreground="{DynamicResource AccentGreen}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- Packet Rate -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="PACKET RATE"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"/>
                    <TextBlock Text="{Binding PacketRateFormatted}"
                               FontSize="{StaticResource FontSizeXL}"
                               FontWeight="Bold"
                               Foreground="{DynamicResource AccentOrange}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- Bandwidth -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="BANDWIDTH"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"/>
                    <TextBlock Text="{Binding BandwidthFormatted}"
                               FontSize="{StaticResource FontSizeXL}"
                               FontWeight="Bold"
                               Foreground="{DynamicResource AccentPurple}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- Drops -->
            <Border Classes="card" Padding="12" IsVisible="{Binding PacketsDropped}">
                <StackPanel>
                    <TextBlock Text="PACKETS DROPPED"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"/>
                    <TextBlock FontSize="{StaticResource FontSizeXL}" FontWeight="Bold" Margin="0,4,0,0">
                        <TextBlock.Foreground>
                            <SolidColorBrush Color="{Binding DropPercentage, Converter={StaticResource DropPercentageToColorConverter}}"/>
                        </TextBlock.Foreground>
                        <Run Text="{Binding PacketsDropped}"/>
                        <Run Text="(" FontSize="{StaticResource FontSizeInput}"/>
                        <Run Text="{Binding DropPercentage, StringFormat='{}{0:F2}%'}" FontSize="{StaticResource FontSizeInput}"/>
                        <Run Text=")" FontSize="{StaticResource FontSizeInput}"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Packet Rate Chart -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="PACKET RATE OVER TIME"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"
                               Margin="0,0,0,8"/>
                    <!-- LiveCharts CartesianChart with axes configured in code-behind -->
                    <!-- Axis types DateTimeAxis and Axis must be configured in ViewModel/code-behind -->
                    <!-- XAML type resolution doesn't work with LiveChartsCore.SkiaSharpView.Avalonia v2.0.0-rc4.5 -->
                    <lvc:CartesianChart Series="{Binding PacketRateSeries}"
                                        XAxes="{Binding PacketRateXAxes}"
                                        YAxes="{Binding PacketRateYAxes}"
                                        Height="150"
                                        LegendPosition="Hidden"/>
                </StackPanel>
            </Border>

            <!-- Protocol Distribution -->
            <Border Classes="card" Padding="12">
                <StackPanel>
                    <TextBlock Text="PROTOCOL DISTRIBUTION"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"
                               Margin="0,0,0,8"/>

                    <!-- Pie Chart -->
                    <lvc:PieChart Series="{Binding ProtocolPieSeries}"
                                  Height="180"
                                  LegendPosition="Bottom"
                                  IsVisible="{Binding !!ProtocolDistribution.Count}"/>

                    <!-- No Data Message -->
                    <TextBlock Text="Waiting for packets..."
                               FontSize="{StaticResource FontSizeBase}"
                               Foreground="{DynamicResource TextMuted}"
                               HorizontalAlignment="Center"
                               Margin="0,20"
                               IsVisible="{Binding !ProtocolDistribution.Count}"/>

                    <!-- Protocol List -->
                    <ItemsControl ItemsSource="{Binding ProtocolDistribution}"
                                  Margin="0,8,0,0">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Protocol}"
                                               FontSize="{StaticResource FontSizeSmall}"
                                               Foreground="{DynamicResource TextPrimary}"/>
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding Count, StringFormat='{}{0:N0}'}"
                                               FontSize="{StaticResource FontSizeSmall}"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource AccentBlue}"
                                               Margin="8,0"/>
                                    <TextBlock Grid.Column="2"
                                               Text="{Binding Percentage, StringFormat='({0:F1}%)'}"
                                               FontSize="{StaticResource FontSizeXS}"
                                               Foreground="{DynamicResource TextSecondary}"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Top Talkers (if available) -->
            <Border Classes="card" Padding="12" IsVisible="{Binding !!TopTalkers.Count}">
                <StackPanel>
                    <TextBlock Text="TOP TALKERS"
                               FontSize="{StaticResource FontSizeXS}"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextMuted}"
                               Margin="0,0,0,8"/>
                    <ItemsControl ItemsSource="{Binding TopTalkers}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource BackgroundMedium}"
                                        BorderBrush="{DynamicResource BorderPrimary}"
                                        BorderThickness="1"
                                        CornerRadius="4"
                                        Padding="8"
                                        Margin="0,4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding IpAddress}"
                                                       FontSize="{StaticResource FontSizeSmall}"
                                                       FontWeight="Medium"
                                                       FontFamily="Consolas,Courier New,monospace"
                                                       Foreground="{DynamicResource AccentBlue}"/>
                                            <TextBlock Text="{Binding PacketCount, StringFormat='{}{0:N0} packets'}"
                                                       FontSize="{StaticResource FontSizeXS}"
                                                       Foreground="{DynamicResource TextSecondary}"/>
                                        </StackPanel>
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding BytesFormatted}"
                                                   FontSize="{StaticResource FontSizeBase}"
                                                   FontWeight="Bold"
                                                   Foreground="{DynamicResource AccentGreen}"
                                                   VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>
