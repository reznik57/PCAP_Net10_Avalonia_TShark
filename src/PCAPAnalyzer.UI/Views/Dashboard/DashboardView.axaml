<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             xmlns:converters="using:PCAPAnalyzer.UI.Converters"
             xmlns:controls="using:PCAPAnalyzer.UI.Controls"
             xmlns:ctrl="using:PCAPAnalyzer.UI.Views.Controls"
             xmlns:components="using:PCAPAnalyzer.UI.Views.Components"
             mc:Ignorable="d" d:DesignWidth="1400" d:DesignHeight="900"
             x:Class="PCAPAnalyzer.UI.Views.DashboardView"
             x:DataType="vm:DashboardViewModel">

    <UserControl.Resources>
        <converters:ByteFormatConverter x:Key="ByteFormatConverter"/>
        <converters:BoolToViewModeConverter x:Key="BoolToViewModeConverter"/>
        <converters:PercentageToGradientConverter x:Key="PercentageToGradientConverter"/>
        <converters:PercentageToWidthConverter x:Key="PercentageToWidthConverter"/>
        <converters:TrafficIntensityColorConverter x:Key="TrafficIntensityColorConverter"/>
        <converters:TrafficIntensityGradientConverter x:Key="TrafficIntensityGradientConverter"/>
        <converters:PercentageToScaleConverter x:Key="PercentageToScaleConverter"/>
        <converters:PortTimelineCountConverter x:Key="PortTimelineCountConverter"/>
        <converters:PortTableCountConverter x:Key="PortTableCountConverter"/>
        <converters:OtherTableCountConverter x:Key="OtherTableCountConverter"/>
        <converters:ConnectionTableCountConverter x:Key="ConnectionTableCountConverter"/>
        <converters:ThroughputModeConverter x:Key="ThroughputModeConverter"/>
        <converters:PortActivityModeConverter x:Key="PortActivityModeConverter"/>

        <!-- Port/Protocol Row Template - SLACK STYLE -->
        <DataTemplate x:Key="PortRowTemplate">
            <Border Classes="ranked-table-row">
                <Grid>
                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                    <StackPanel Grid.Column="1" Orientation="Horizontal"><TextBlock Text="{Binding Port}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/><TextBlock Text="/" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="2,0"/><TextBlock Text="{Binding Protocol}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}"/></StackPanel>
                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding ServiceName}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                    <Grid Grid.Column="3" Margin="8,0">
                        <Border Classes="percentage-track">
                            <Grid>
                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                            </Grid>
                        </Border>
                    </Grid>
                    <TextBlock Grid.Column="4" Text="{Binding DataContext.MetricText, RelativeSource={RelativeSource AncestorType=Border}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{Binding DataContext.MetricColor, RelativeSource={RelativeSource AncestorType=Border}}" HorizontalAlignment="Right"/>
                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowPortDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- IP Endpoint Row Template - SLACK STYLE -->
        <DataTemplate x:Key="EndpointRowTemplate">
            <Border Classes="ranked-table-row">
                <Grid>
                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                    <Grid Grid.Column="3" Margin="8,0">
                        <Border Classes="percentage-track">
                            <Grid>
                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                            </Grid>
                        </Border>
                    </Grid>
                    <TextBlock Grid.Column="4" Text="{Binding DataContext.MetricText, RelativeSource={RelativeSource AncestorType=Border}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{Binding DataContext.MetricColor, RelativeSource={RelativeSource AncestorType=Border}}" HorizontalAlignment="Right"/>
                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Connection Row Template - SLACK STYLE -->
        <DataTemplate x:Key="ConnectionRowTemplate">
            <Border Classes="ranked-table-row">
                <Grid>
                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="150"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                    <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="2">
                        <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0}:{1}"><Binding Path="SourceIP"/><Binding Path="SourcePort"/></MultiBinding></TextBlock.Text></TextBlock>
                        <TextBlock FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"><TextBlock.Text><MultiBinding StringFormat="â†’ {0}:{1}"><Binding Path="DestinationIP"/><Binding Path="DestinationPort"/></MultiBinding></TextBlock.Text></TextBlock>
                    </StackPanel>
                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Protocol}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                    <Grid Grid.Column="3" Margin="8,0">
                        <Border Classes="percentage-track">
                            <Grid>
                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                            </Grid>
                        </Border>
                    </Grid>
                    <TextBlock Grid.Column="4" Text="{Binding DataContext.MetricText, RelativeSource={RelativeSource AncestorType=Border}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{Binding DataContext.MetricColor, RelativeSource={RelativeSource AncestorType=Border}}" HorizontalAlignment="Right"/>
                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowConnectionDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <!-- Styles now centralized in UnifiedDarkTheme.axaml -->

    <Grid Background="{DynamicResource BackgroundDark}" ClipToBounds="True">
        <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>

        <!-- Export Status Bar - SLACK STYLE -->
        <Border Grid.Row="0" Background="{DynamicResource BackgroundPanel}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,0,0,1" Padding="16,8" IsVisible="{Binding ExportStatusMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Grid>
                <Grid.ColumnDefinitions><ColumnDefinition Width="Auto"/><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="ðŸ“Š" FontSize="{StaticResource FontSizeLarge}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <TextBlock Grid.Column="1" Text="{Binding ExportStatusMessage}" FontSize="{StaticResource FontSizeMedium}" FontWeight="Medium" Foreground="{Binding ExportStatusColor}" VerticalAlignment="Center"/>
                <ProgressBar Grid.Column="2" IsIndeterminate="True" Width="120" Height="4" Foreground="{Binding ExportStatusColor}" IsVisible="{Binding IsExporting}" VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Filter Progress Bar - SLACK STYLE -->
        <Border Grid.Row="0" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource AccentPrimary}" BorderThickness="0,0,0,2" Padding="16,10" IsVisible="{Binding IsFilteringInProgress}">
            <Grid>
                <Grid.ColumnDefinitions><ColumnDefinition Width="Auto"/><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/><ColumnDefinition Width="200"/></Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="ðŸ”" FontSize="{StaticResource FontSizeLarge}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <TextBlock Grid.Column="1" Text="Applying filters..." FontSize="{StaticResource FontSizeMedium}" FontWeight="Medium" Foreground="{DynamicResource AccentPrimary}" VerticalAlignment="Center"/>
                <TextBlock Grid.Column="2" Text="{Binding FilterProgress, StringFormat='{}{0:P0}'}" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <ProgressBar Grid.Column="3" Value="{Binding FilterProgress}" Minimum="0" Maximum="1" Height="6" Foreground="{DynamicResource AccentPrimary}" Background="{DynamicResource BorderSubtleBrush}" VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="24,24,24,24" Spacing="24" MaxWidth="{Binding $parent[Grid].Bounds.Width}">

                <!-- UnifiedFilterPanelControl for sophisticated filtering -->
                <ctrl:UnifiedFilterPanelControl x:Name="UnifiedFilterPanel" Margin="0,0,0,10" />

                <!-- Sampling Indicator Banner (shown for large captures) -->
                <Border IsVisible="{Binding UsingStatisticsSample}"
                        Background="{StaticResource WarningPanelBg}" BorderBrush="{DynamicResource SlackWarning}" BorderThickness="1"
                        CornerRadius="8" Padding="16,12" Margin="0,0,0,10">
                    <Grid ColumnDefinitions="Auto,*">
                        <TextBlock Grid.Column="0" Text="âš ï¸" FontSize="{StaticResource FontSizeXL}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="4">
                            <TextBlock Text="Large Capture - Statistics Sampled" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource SlackWarning}"/>
                            <TextBlock Foreground="{StaticResource WarningPanelText}" FontSize="{StaticResource FontSizeSmall}" TextWrapping="Wrap">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}This capture exceeds 1M packets. Dashboard statistics are calculated from a representative sample of {0:N0} packets for performance. Values shown are approximate.">
                                        <Binding Path="StatisticsSampleSize"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Network Statistics - Using unified StatsBarControl -->
                <ctrl:StatsBarControl DataContext="{Binding NetworkStatsBar}"/>

                <!-- Traffic Over Time Chart - SLACK STYLE -->
                <Border Classes="modern-card-unified" MinHeight="400">
                    <Grid>
                        <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/><RowDefinition Height="Auto"/></Grid.RowDefinitions>
                        <Border Grid.Row="0" Classes="table-header-unified">
                            <Grid Margin="20,0">
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{DynamicResource AccentPrimary}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Traffic Over Time" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                    <Button x:Name="TrafficZoomInButton" Click="OnTrafficZoomIn" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Zoom In"><TextBlock Text="ðŸ”+" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/></Button>
                                    <Button x:Name="TrafficZoomOutButton" Click="OnTrafficZoomOut" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Zoom Out"><TextBlock Text="ðŸ”-" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/></Button>
                                    <Button x:Name="TrafficZoomResetButton" Click="OnTrafficZoomReset" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Reset Zoom"><TextBlock Text="âŸ²" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/></Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                        <lvc:CartesianChart Grid.Row="1" x:Name="NetworkTrafficChart" Series="{Binding TimelineSeries}" XAxes="{Binding XAxes}" YAxes="{Binding YAxes}" ZoomMode="None" Height="320" Margin="20,20,20,10" TooltipPosition="Hidden" AnimationsSpeed="00:00:00.5" PointerPressed="OnChartPointerPressed" PointerMoved="OnTrafficChartPointerMoved" PointerExited="OnTrafficChartPointerExited"/>
                        <Border Grid.Row="2" Height="35" Margin="20,0,20,10" Background="{DynamicResource BackgroundCard}" CornerRadius="8" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1"><TextBlock x:Name="TrafficTooltipText" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="10,0"/></Border>
                    </Grid>
                </Border>

                <!-- Port Activity Timeline - SLACK STYLE -->
                <Border Classes="modern-card-unified" MinHeight="320">
                    <Grid>
                        <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/><RowDefinition Height="Auto"/></Grid.RowDefinitions>
                        <Border Grid.Row="0" Classes="table-header-unified">
                            <Grid Margin="20,0">
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{DynamicResource AccentSecondary}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Port Activity Over Time" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="0,0,8,0">
                                    <ToggleButton IsChecked="{Binding ShowPortActivityAsThroughput}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6"><TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0}"><Binding Path="ShowPortActivityAsThroughput" Converter="{StaticResource ThroughputModeConverter}"/></MultiBinding></TextBlock.Text></TextBlock></ToggleButton>
                                    <ToggleButton IsChecked="{Binding ShowTop10PortsTimeline}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6"><TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0}"><Binding Path="ShowTop10PortsTimeline" Converter="{StaticResource PortTimelineCountConverter}"/></MultiBinding></TextBlock.Text></TextBlock></ToggleButton>
                                </StackPanel>
                                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                    <Button x:Name="PortZoomInButton" Click="OnPortZoomIn" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Zoom In"><TextBlock Text="ðŸ”+" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/></Button>
                                    <Button x:Name="PortZoomOutButton" Click="OnPortZoomOut" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Zoom Out"><TextBlock Text="ðŸ”-" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/></Button>
                                    <Button x:Name="PortZoomResetButton" Click="OnPortZoomReset" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Reset Zoom"><TextBlock Text="âŸ²" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/></Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                        <lvc:CartesianChart Grid.Row="1" x:Name="PortActivityChart" Series="{Binding PortActivitySeries}" XAxes="{Binding PortActivityXAxes}" YAxes="{Binding PortActivityYAxes}" Height="250" Margin="20,10,20,5" ZoomMode="None" TooltipPosition="Hidden" AnimationsSpeed="00:00:00.5" PointerPressed="OnChartPointerPressed" PointerMoved="OnPortChartPointerMoved" PointerExited="OnPortChartPointerExited"/>
                        <Border Grid.Row="2" Height="35" Margin="20,0,20,10" Background="{DynamicResource BackgroundCard}" CornerRadius="8" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1"><TextBlock x:Name="PortActivityTooltipText" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="10,0"/></Border>
                    </Grid>
                </Border>

                <!-- Top Ports Tables -->
                <Grid>
                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>

                    <!-- By Packets -->
                    <Border Grid.Column="0" Classes="modern-card-unified" Margin="0,0,12,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatBytes}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Ports by Packets" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportPortsByPacketsCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export ports by packets to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopPortsByPacketsExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <StackPanel Grid.Column="1" Orientation="Horizontal"><TextBlock Text="{Binding Port}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/><TextBlock Text="/" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="2,0"/><TextBlock Text="{Binding Protocol}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}"/></StackPanel>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding ServiceName}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatBytes}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowPortDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- By Bytes -->
                    <Border Grid.Column="1" Classes="modern-card-unified" Margin="12,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatPackets}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Ports by Bytes" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportPortsByBytesCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export ports by bytes to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopPortsByBytesExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <StackPanel Grid.Column="1" Orientation="Horizontal"><TextBlock Text="{Binding Port}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/><TextBlock Text="/" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="2,0"/><TextBlock Text="{Binding Protocol}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}"/></StackPanel>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding ServiceName}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding ByteCountFormatted}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatPackets}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowPortDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Top Source IPs Tables -->
                <Grid Margin="0,0,0,0">
                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>

                    <!-- By Packets -->
                    <Border Grid.Column="0" Classes="modern-card-unified" Margin="0,0,12,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatBytes}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Source IPs by Packets" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportSourcesByPacketsCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export source IPs by packets to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopSourcesExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatBytes}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- By Bytes -->
                    <Border Grid.Column="1" Classes="modern-card-unified" Margin="12,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatIPs}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Source IPs by Bytes" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportSourcesByBytesCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export source IPs by bytes to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopSourcesByBytesExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding ByteCount, Converter={StaticResource ByteFormatConverter}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatIPs}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Top Destination IPs Tables -->
                <Grid Margin="0,0,0,0">
                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>

                    <!-- By Packets -->
                    <Border Grid.Column="0" Classes="modern-card-unified" Margin="0,0,12,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatPorts}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Destination IPs by Packets" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportDestinationsByPacketsCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export destination IPs by packets to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopDestinationsExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatPorts}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- By Bytes -->
                    <Border Grid.Column="1" Classes="modern-card-unified" Margin="12,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatPurple}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Destination IPs by Bytes" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportDestinationsByBytesCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export destination IPs by bytes to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopDestinationsByBytesExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding ByteCount, Converter={StaticResource ByteFormatConverter}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatPurple}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Top Total IPs Tables -->
                <Grid Margin="0,0,0,0">
                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>

                    <!-- By Packets -->
                    <Border Grid.Column="0" Classes="modern-card-unified" Margin="0,0,12,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatConversations}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Total IPs by Packets" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportTotalIPsByPacketsCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export total IPs by packets to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopTotalIPsByPacketsExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatConversations}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- By Bytes -->
                    <Border Grid.Column="1" Classes="modern-card-unified" Margin="12,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatTeal}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Total IPs by Bytes" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportTotalIPsByBytesCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export total IPs by bytes to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopTotalIPsByBytesExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="140"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding Address}" FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding Address}"/>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Country}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding ByteCount, Converter={StaticResource ByteFormatConverter}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatTeal}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowIPDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Top Connections Tables -->
                <Grid Margin="0,0,0,24">
                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>

                    <!-- By Packets -->
                    <Border Grid.Column="0" Classes="modern-card-unified" Margin="0,0,12,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatConversations}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Connections by Packets" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportConnectionsByPacketsCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export connections by packets to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopConnectionsExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="150"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="2">
                                                        <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0}:{1}"><Binding Path="SourceIP"/><Binding Path="SourcePort"/></MultiBinding></TextBlock.Text></TextBlock>
                                                        <TextBlock FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"><TextBlock.Text><MultiBinding StringFormat="â†’ {0}:{1}"><Binding Path="DestinationIP"/><Binding Path="DestinationPort"/></MultiBinding></TextBlock.Text></TextBlock>
                                                    </StackPanel>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Protocol}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatConversations}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowConnectionDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- By Bytes -->
                    <Border Grid.Column="1" Classes="modern-card-unified" Margin="12,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0">
                                    <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{StaticResource StatTeal}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Connections by Bytes" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                    <Button Grid.Column="1" Command="{Binding ExportConnectionsByBytesCommand}" IsEnabled="{Binding !IsExporting}" Classes="export-csv" ToolTip.Tip="Export connections by bytes to CSV"><StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{StaticResource FontSizeInput}"/><TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="White"/></StackPanel></Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding TopConnectionsByBytesExtended}" Margin="0,8,0,8">
                                    <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Classes="ranked-table-row">
                                                <Grid>
                                                    <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="150"/><ColumnDefinition Width="70"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                    <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="2">
                                                        <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0}:{1}"><Binding Path="SourceIP"/><Binding Path="SourcePort"/></MultiBinding></TextBlock.Text></TextBlock>
                                                        <TextBlock FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"><TextBlock.Text><MultiBinding StringFormat="â†’ {0}:{1}"><Binding Path="DestinationIP"/><Binding Path="DestinationPort"/></MultiBinding></TextBlock.Text></TextBlock>
                                                    </StackPanel>
                                                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Protocol}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                                    <Grid Grid.Column="3" Margin="8,0">
                                                        <Border Classes="percentage-track">
                                                            <Grid>
                                                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                    <TextBlock Grid.Column="4" Text="{Binding ByteCount, Converter={StaticResource ByteFormatConverter}}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{StaticResource StatTeal}" HorizontalAlignment="Right"/>
                                                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowConnectionDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Packet Size Distribution - SLACK STYLE -->
                <Border Classes="modern-card-unified" MinHeight="420">
                    <Grid>
                        <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/><RowDefinition Height="Auto"/></Grid.RowDefinitions>
                        <Border Grid.Row="0" Classes="table-header-unified">
                            <Grid Margin="20,0">
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{DynamicResource SlackSuccess}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Packet Size Distribution" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                            </Grid>
                        </Border>
                        <lvc:CartesianChart Grid.Row="1" Series="{Binding Charts.PacketSizeSeries}" XAxes="{Binding Charts.PacketSizeXAxes}" YAxes="{Binding Charts.PacketSizeYAxes}" ZoomMode="None" Height="320" Margin="20,20,20,10" TooltipPosition="Hidden" AnimationsSpeed="00:00:00.5"/>
                        <Border Grid.Row="2" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,1,0,0" Padding="20,12">
                            <Grid>
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0"><TextBlock Text="Average Size" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,4"/><TextBlock FontSize="{StaticResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0:F1} bytes"><Binding Path="Statistics.AveragePacketSize"/></MultiBinding></TextBlock.Text></TextBlock></StackPanel>
                                <StackPanel Grid.Column="1"><TextBlock Text="Median Size" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,4"/><TextBlock FontSize="{StaticResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0} bytes"><Binding Path="Statistics.MedianPacketSize"/></MultiBinding></TextBlock.Text></TextBlock></StackPanel>
                                <StackPanel Grid.Column="2"><TextBlock Text="Min / Max" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,4"/><TextBlock FontSize="{StaticResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0} / {1}"><Binding Path="Statistics.MinPacketSize"/><Binding Path="Statistics.MaxPacketSize"/></MultiBinding></TextBlock.Text></TextBlock></StackPanel>
                                <StackPanel Grid.Column="3"><TextBlock Text="Std Deviation" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,4"/><TextBlock FontSize="{StaticResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"><TextBlock.Text><MultiBinding StringFormat="{}{0:F1}"><Binding Path="Statistics.StandardDeviation"/></MultiBinding></TextBlock.Text></TextBlock></StackPanel>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Drill-Down Popup Overlay -->
        <Border Grid.Row="1" Background="{StaticResource OverlayBlack50}" IsVisible="{Binding DrillDown.IsVisible}"
                PointerPressed="OnPopupBackgroundPressed">
            <Border HorizontalAlignment="Center" VerticalAlignment="Center" Margin="50">
                <components:DrillDownPopupView DataContext="{Binding DrillDown}"/>
            </Border>
        </Border>
    </Grid>
</UserControl>
