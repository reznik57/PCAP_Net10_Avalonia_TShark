<Window xmlns="https://github.com/avaloniaui"
        xmlns:ns2="using:PCAPAnalyzer.UI.Converters"
        xmlns:ns3="using:PCAPAnalyzer.UI.Views"
        xmlns:ns4="using:PCAPAnalyzer.UI.Views.Components"
        xmlns:ctrl="using:PCAPAnalyzer.UI.Views.Controls"
        xmlns:vm="using:PCAPAnalyzer.UI.ViewModels"
        xmlns:vmc="using:PCAPAnalyzer.UI.ViewModels.Components"
        xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        x:Class="PCAPAnalyzer.UI.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="PCAP Security Analyzer - Dark Mode"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        Background="{DynamicResource BackgroundDark}">

    <Window.Resources>
        <ns2:SecurityRatingToColorConverter x:Key="SecurityRatingToColorConverter" />
        <ns2:AnalyzeButtonTextConverter x:Key="AnalyzeButtonTextConverter" />
        <ns2:ClearButtonTextConverter x:Key="ClearButtonTextConverter" />
        <ns2:ByteSizeConverter x:Key="ByteSizeConverter" />
        <ns2:StageStateToBrushConverter x:Key="StageStateBrushConverter" />
        <ns2:StageProgressVisibilityConverter x:Key="StageProgressVisibilityConverter" />
        <ns2:BoolToTextConverter x:Key="BoolToTextConverter" />
        <ns2:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
        <ns2:ThroughputModeConverter x:Key="ThroughputModeConverter" />
        <ns2:PortTimelineCountConverter x:Key="PortTimelineCountConverter" />
        <ns2:TrafficIntensityGradientConverter x:Key="TrafficIntensityGradientConverter" />
        <ns2:PercentageToWidthConverter x:Key="PercentageToWidthConverter" />
    </Window.Resources>

    <Window.Styles>
        <Style Selector="TextBlock.title">
            <Setter Property="FontSize" Value="28" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Foreground" Value="White" />
        </Style>
        <Style Selector="TextBlock.subtitle">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
        </Style>
        <Style Selector="TextBlock.stat-label">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}" />
            <Setter Property="FontWeight" Value="Medium" />
        </Style>
        <Style Selector="TextBlock.stat-value">
            <Setter Property="FontSize" Value="32" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Foreground" Value="White" />
        </Style>
        <Style Selector="ScrollViewer.fixed-height-table">
            <Setter Property="Height" Value="440"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
        </Style>
    </Window.Styles>

    <DockPanel>
        <!-- Status Bar - SLACK STYLE -->
        <Border DockPanel.Dock="Bottom" Background="{DynamicResource BackgroundPanel}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,1,0,0" Padding="16,8">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Status Indicator -->
                <Border Grid.Column="0" Padding="12,6" Background="{DynamicResource BackgroundCard}" CornerRadius="6">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Ellipse Width="8" Height="8" Fill="{Binding StatusColor}" VerticalAlignment="Center">
                            <Ellipse.Styles>
                                <Style Selector="Ellipse">
                                    <Style.Animations>
                                        <Animation Duration="0:0:1" IterationCount="INFINITE" PlaybackDirection="Alternate">
                                            <KeyFrame Cue="0%"><Setter Property="Opacity" Value="0.4"/></KeyFrame>
                                            <KeyFrame Cue="100%"><Setter Property="Opacity" Value="1.0"/></KeyFrame>
                                        </Animation>
                                    </Style.Animations>
                                </Style>
                            </Ellipse.Styles>
                        </Ellipse>
                        <TextBlock Text="ANALYZING" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{DynamicResource SlackInfo}" VerticalAlignment="Center" Margin="0,0,6,0" IsVisible="{Binding IsAnalyzing}"/>
                        <TextBlock Text="{Binding Status}" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" IsVisible="{Binding !IsAnalyzing}"/>
                        <TextBlock Text="{Binding PerformanceStatus}" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" IsVisible="{Binding IsAnalyzing}"/>
                        <Border Background="{DynamicResource SlackSuccess}" CornerRadius="4" Padding="8,3" Margin="6,0,0,0" IsVisible="{Binding AnalysisProgress, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Text="{Binding AnalysisProgress, StringFormat='{}{0:F0}%'}" FontSize="{StaticResource FontSizeSmall}" FontWeight="SemiBold" Foreground="White"/>
                        </Border>
                    </StackPanel>
                </Border>

                <!-- Memory + Screenshot -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="12" Margin="12,0,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="Memory:" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding MemoryUsage}" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Medium" VerticalAlignment="Center"/>
                    </StackPanel>
                    <Button Command="{Binding TakeScreenshotCommand}" ToolTip.Tip="Take Screenshot" Padding="12,6" Background="Transparent" BorderBrush="{DynamicResource BorderStrongBrush}" BorderThickness="1" CornerRadius="6" Cursor="Hand" Name="ScreenshotButton">
                        <Button.Styles>
                            <Style Selector="Button:pointerover">
                                <Setter Property="Background" Value="{DynamicResource BackgroundElevated}"/>
                                <Setter Property="BorderBrush" Value="{DynamicResource TextDisabled}"/>
                            </Style>
                            <Style Selector="Button:pressed">
                                <Setter Property="Background" Value="{DynamicResource BackgroundActive}"/>
                            </Style>
                        </Button.Styles>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="ðŸ“¸" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                            <TextBlock Text="Screenshot" FontSize="{StaticResource FontSizeBase}" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content with Progress Overlay -->
        <Grid>
            <!-- TabControl (background layer) - SLACK STYLE -->
            <TabControl Name="MainTabControl" Background="{DynamicResource BackgroundDark}" SelectedIndex="{Binding SelectedTabIndex}">
            <TabControl.Styles>
                <!-- Slack-style tabs: borderless, bottom accent line -->
                <Style Selector="TabItem">
                    <Setter Property="FontSize" Value="13" />
                    <Setter Property="Padding" Value="16,12" />
                    <Setter Property="Margin" Value="0,0,4,0" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}" />
                    <Setter Property="BorderThickness" Value="0,0,0,3" />
                    <Setter Property="BorderBrush" Value="Transparent" />
                    <Setter Property="CornerRadius" Value="8,8,0,0" />
                    <Setter Property="Transitions">
                        <Transitions>
                            <BrushTransition Property="Background" Duration="0:0:0.15" />
                            <BrushTransition Property="BorderBrush" Duration="0:0:0.15" />
                            <BrushTransition Property="Foreground" Duration="0:0:0.15" />
                        </Transitions>
                    </Setter>
                </Style>
                <Style Selector="TabItem:pointerover">
                    <Setter Property="Background" Value="{DynamicResource BackgroundElevated}" />
                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                </Style>
                <Style Selector="TabItem:selected">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Foreground" Value="White" />
                    <Setter Property="FontWeight" Value="Medium" />
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentPrimary}" />
                    <Setter Property="BorderThickness" Value="0,0,0,3" />
                </Style>
                <Style Selector="TabItem:selected:pointerover">
                    <Setter Property="Background" Value="{DynamicResource BackgroundElevated}" />
                    <Setter Property="Foreground" Value="White" />
                    <Setter Property="BorderBrush" Value="{DynamicResource SlackInfo}" />
                </Style>
                <Style Selector="TabItem:disabled">
                    <Setter Property="Foreground" Value="{DynamicResource TextDisabled}" />
                    <Setter Property="Opacity" Value="0.5" />
                </Style>

                <!-- Tab content transition handled in code-behind via OnTabSelectionChanged -->
            </TabControl.Styles>

            <!-- File Manager Tab (FIRST TAB) -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding FileManagerBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸ“‚ File Manager" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:FileManagerView DataContext="{Binding FileManagerViewModel}" />
            </TabItem>

            <!-- Packet Analysis Tab with Badge -->
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding PacketAnalysisBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸ“¦ Packet Analysis" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Background="{DynamicResource BackgroundDarkest}" BringIntoViewOnFocusChange="False">
                    <Grid Margin="24" RowDefinitions="Auto,16,Auto,16,Auto,16,Auto,16,Auto">
                        <!-- âœ… CLEANUP: FileSelectionControl removed (now in File Manager tab with awesome progress panel) -->

                        <!-- Row 0: UnifiedFilterPanelControl (Dashboard pattern) -->
                        <ctrl:UnifiedFilterPanelControl Grid.Row="0" />

                        <!-- Row 2: Statistics Bar UserControl -->
                        <ctrl:StatsBarControl Grid.Row="2" DataContext="{Binding PacketAnalysisStats}" />

                        <!-- Row 4: Packets Over Time Chart (filtered packets only) - SLACK STYLE -->
                        <Border Grid.Row="4" Background="{DynamicResource BackgroundPanel}" CornerRadius="12" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1"
                                MinHeight="340" IsVisible="{Binding Charts.HasPacketData}" BoxShadow="0 2 8 0 #00000026">
                            <Grid RowDefinitions="Auto,Auto,*,Auto">
                                <!-- Chart Header -->
                                <Border Grid.Row="0" Background="{DynamicResource BackgroundCard}" CornerRadius="12,12,0,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,0,0,1" Padding="0">
                                    <Grid Margin="20,12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                            <Border Width="3" Height="20" Background="{DynamicResource AccentPrimary}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                            <TextBlock Text="Packets Over Time" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            <Border Background="{DynamicResource BackgroundElevated}" CornerRadius="12" Padding="10,4" Margin="12,0,0,0" BorderBrush="{DynamicResource BorderStrongBrush}" BorderThickness="1">
                                                <TextBlock Text="{Binding Charts.FilteredPacketCount, StringFormat='{}Filtered: {0:N0}'}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource SlackInfo}" FontWeight="Medium"/>
                                            </Border>
                                        </StackPanel>
                                        <!-- Toggle Buttons: Packets/Throughput and Top5/Top10 -->
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="0,0,12,0" VerticalAlignment="Center">
                                            <ToggleButton IsChecked="{Binding Charts.ShowStreamActivityAsThroughput}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="10,4" CornerRadius="6" ToolTip.Tip="Toggle Packets/Throughput">
                                                <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}">
                                                    <TextBlock.Text>
                                                        <MultiBinding StringFormat="{}{0}">
                                                            <Binding Path="Charts.ShowStreamActivityAsThroughput" Converter="{StaticResource ThroughputModeConverter}"/>
                                                        </MultiBinding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                            </ToggleButton>
                                            <ToggleButton IsChecked="{Binding Charts.ShowTop10Streams}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="10,4" CornerRadius="6" ToolTip.Tip="Toggle Top 5/Top 10">
                                                <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}">
                                                    <TextBlock.Text>
                                                        <MultiBinding StringFormat="{}{0}">
                                                            <Binding Path="Charts.ShowTop10Streams" Converter="{StaticResource PortTimelineCountConverter}"/>
                                                        </MultiBinding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                            </ToggleButton>
                                        </StackPanel>
                                        <!-- Zoom Buttons -->
                                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                            <Button Command="{Binding Charts.ZoomInPacketsTimelineCommand}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Zoom In">
                                                <TextBlock Text="ðŸ”+" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Button>
                                            <Button Command="{Binding Charts.ZoomOutPacketsTimelineCommand}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Zoom Out">
                                                <TextBlock Text="ðŸ”-" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Button>
                                            <Button Command="{Binding Charts.ResetPacketsTimelineZoomCommand}" Background="{DynamicResource BackgroundCard}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" Padding="8,4" CornerRadius="6" ToolTip.Tip="Reset Zoom">
                                                <TextBlock Text="âŸ²" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Custom Interactive Legend (horizontal, above chart) - Two-line format for streams -->
                                <Border Grid.Row="1" Background="{DynamicResource BackgroundCard}" CornerRadius="8" Margin="20,10,20,0" Padding="12,6">
                                    <Grid ColumnDefinitions="Auto,*">
                                        <TextBlock Grid.Column="0" Text="Series:" FontSize="{StaticResource FontSizeSmall}" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                        <ItemsControl Grid.Column="1" ItemsSource="{Binding Charts.LegendItems}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="4,2" Padding="8,5" CornerRadius="4" Cursor="Hand" BorderThickness="1" ToolTip.Tip="{Binding Name}">
                                                        <Border.Background>
                                                            <SolidColorBrush Color="{Binding Color}" Opacity="0.15"/>
                                                        </Border.Background>
                                                        <Border.BorderBrush>
                                                            <SolidColorBrush Color="{Binding Color}" Opacity="0.4"/>
                                                        </Border.BorderBrush>
                                                        <Border.Styles>
                                                            <Style Selector="Border:pointerover">
                                                                <Setter Property="Opacity" Value="0.8"/>
                                                            </Style>
                                                        </Border.Styles>
                                                        <Grid ColumnDefinitions="Auto,Auto,Auto">
                                                            <CheckBox Grid.Column="0" IsChecked="{Binding IsVisible}" Margin="0,0,6,0" VerticalAlignment="Center"/>
                                                            <Border Grid.Column="1" Width="14" Height="3" CornerRadius="1.5" Margin="0,0,8,0" VerticalAlignment="Center">
                                                                <Border.Background>
                                                                    <SolidColorBrush Color="{Binding Color}"/>
                                                                </Border.Background>
                                                            </Border>
                                                            <!-- Two-line layout for streams, single line for Total -->
                                                            <StackPanel Grid.Column="2" Orientation="Vertical" Spacing="1" VerticalAlignment="Center">
                                                                <!-- Line 1: Source IP (or "Total" for non-streams) - colored to match series -->
                                                                <TextBlock Text="{Binding SourceIP, FallbackValue='Total', TargetNullValue='Total'}"
                                                                           FontSize="{StaticResource FontSizeSmall}" FontWeight="SemiBold" Foreground="{Binding ColorBrush}"/>
                                                                <!-- Line 2: Arrow + Dest IP (hidden for Total) - dimmed series color -->
                                                                <TextBlock IsVisible="{Binding IsStream}" FontSize="{StaticResource FontSizeXS}" Foreground="{Binding ColorBrushDimmed}">
                                                                    <Run Text="â†’ "/><Run Text="{Binding DestIP}"/>
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Grid>
                                </Border>

                                <!-- Chart with interactive hover/click -->
                                <lvc:CartesianChart Grid.Row="2"
                                    x:Name="PacketsOverTimeChart"
                                    Series="{Binding Charts.PacketsOverTimeSeries}"
                                    XAxes="{Binding Charts.PacketsOverTimeXAxes}"
                                    YAxes="{Binding Charts.PacketsOverTimeYAxes}"
                                    ZoomMode="None"
                                    Height="200"
                                    Margin="20,8,20,5"
                                    TooltipPosition="Hidden"
                                    AnimationsSpeed="00:00:00.5"
                                    PointerMoved="OnPacketsChartPointerMoved"
                                    PointerExited="OnPacketsChartPointerExited"
                                    PointerPressed="OnPacketsChartPointerPressed"
                                    LegendPosition="Hidden"/>

                                <!-- Tooltip Bar with colored inline text (shows Total + Top 5 streams) -->
                                <Border Grid.Row="3" Height="36" Margin="20,0,20,10" Background="{DynamicResource BackgroundCard}" CornerRadius="8" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                    <TextBlock x:Name="PacketsOverTimeTooltipText" FontSize="{StaticResource FontSizeSmall}" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="10,0" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"/>
                                </Border>
                            </Grid>
                        </Border>

                        <!-- Row 6: Top Streams Tables - SLACK STYLE -->
                        <Grid Grid.Row="6" Margin="0,0,0,24" IsVisible="{Binding Charts.HasPacketData}">
                            <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>

                            <!-- By Packets -->
                            <Border Grid.Column="0" Background="{DynamicResource BackgroundPanel}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" CornerRadius="12" Margin="0,0,12,0" BoxShadow="0 2 8 0 #00000026">
                                <Grid>
                                    <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                                    <Border Grid.Row="0" Background="{DynamicResource BackgroundCard}" CornerRadius="12,12,0,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,0,0,1" Padding="0" Height="48">
                                        <Grid Margin="20,0">
                                            <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{DynamicResource SlackInfo}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Streams by Packets" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                        </Grid>
                                    </Border>
                                    <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                        <ItemsControl ItemsSource="{Binding Charts.TopStreamsByPackets}" Margin="0,8,0,8">
                                            <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Classes="ranked-table-row">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="220"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                            <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                            <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="2">
                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                    <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"><Run Text="{Binding SourceIP}"/><Run Text=":" Foreground="{DynamicResource TextMutedBrush}"/><Run Text="{Binding SourcePort}" Foreground="{DynamicResource SlackInfo}"/></TextBlock>
                                                                    <TextBlock Text="{Binding ServiceName}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource AccentPurpleBrush}" VerticalAlignment="Center" IsVisible="{Binding ServiceName.Length}"/>
                                                                </StackPanel>
                                                                <TextBlock FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"><Run Text="â†” "/><Run Text="{Binding DestinationIP}"/><Run Text=":"/><Run Text="{Binding DestPort}" Foreground="{DynamicResource SlackInfo}"/></TextBlock>
                                                            </StackPanel>
                                                            <Grid Grid.Column="2" Margin="8,0">
                                                                <Border Classes="percentage-track">
                                                                    <Grid>
                                                                        <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                        <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                                    </Grid>
                                                                </Border>
                                                            </Grid>
                                                            <TextBlock Grid.Column="3" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{DynamicResource SlackInfo}" HorizontalAlignment="Right"/>
                                                            <Button Grid.Column="4" Command="{Binding $parent[Window].DataContext.Charts.ShowStreamDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Grid>
                            </Border>

                            <!-- By Bytes - SLACK STYLE -->
                            <Border Grid.Column="1" Background="{DynamicResource BackgroundPanel}" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1" CornerRadius="12" Margin="12,0,0,0" BoxShadow="0 2 8 0 #00000026">
                                <Grid>
                                    <Grid.RowDefinitions><RowDefinition Height="Auto"/><RowDefinition Height="*"/></Grid.RowDefinitions>
                                    <Border Grid.Row="0" Background="{DynamicResource BackgroundCard}" CornerRadius="12,12,0,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,0,0,1" Padding="0" Height="48">
                                        <Grid Margin="20,0">
                                            <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"><Border Width="3" Height="20" Background="{DynamicResource SlackSuccess}" CornerRadius="1.5" Margin="0,0,12,0"/><TextBlock Text="Top Streams by Bytes" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/></StackPanel>
                                        </Grid>
                                    </Border>
                                    <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                        <ItemsControl ItemsSource="{Binding Charts.TopStreamsByBytes}" Margin="0,8,0,8">
                                            <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Classes="ranked-table-row">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions><ColumnDefinition Width="30"/><ColumnDefinition Width="220"/><ColumnDefinition Width="*"/><ColumnDefinition Width="100"/><ColumnDefinition Width="60"/></Grid.ColumnDefinitions>
                                                            <TextBlock Grid.Column="0" Text="{Binding Rank}" Classes="rank-number"/>
                                                            <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="2">
                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                    <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"><Run Text="{Binding SourceIP}"/><Run Text=":" Foreground="{DynamicResource TextMutedBrush}"/><Run Text="{Binding SourcePort}" Foreground="{DynamicResource SlackSuccess}"/></TextBlock>
                                                                    <TextBlock Text="{Binding ServiceName}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource AccentPurpleBrush}" VerticalAlignment="Center" IsVisible="{Binding ServiceName.Length}"/>
                                                                </StackPanel>
                                                                <TextBlock FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"><Run Text="â†” "/><Run Text="{Binding DestinationIP}"/><Run Text=":"/><Run Text="{Binding DestPort}" Foreground="{DynamicResource SlackSuccess}"/></TextBlock>
                                                            </StackPanel>
                                                            <Grid Grid.Column="2" Margin="8,0">
                                                                <Border Classes="percentage-track">
                                                                    <Grid>
                                                                        <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                                                        <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                                                                    </Grid>
                                                                </Border>
                                                            </Grid>
                                                            <TextBlock Grid.Column="3" Text="{Binding ByteCountFormatted}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{DynamicResource SlackSuccess}" HorizontalAlignment="Right"/>
                                                            <Button Grid.Column="4" Command="{Binding $parent[Window].DataContext.Charts.ShowStreamDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- Row 8: Packet Table UserControl -->
                        <ctrl:PacketTableControl Grid.Row="8" DataContext="{Binding}" />
                    </Grid>
                </ScrollViewer>
            </TabItem>


            <!-- Analysis Tabs with Badges -->
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding DashboardBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸ“Š Dashboard" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:DashboardView DataContext="{Binding DashboardViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding CountryTrafficBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸŒ Country Traffic" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:CountryTrafficView DataContext="{Binding CountryTrafficViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding VoiceQoSBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸ“ž Voice / QoS" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:VoiceQoSView DataContext="{Binding VoiceQoSViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding ThreatsBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸ›¡ï¸ Security Threats" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:ThreatsView DataContext="{Binding ThreatsViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding AnomaliesBadge}" FontSize="{StaticResource FontSizeInput}" VerticalAlignment="Center"/>
                        <TextBlock Text="ðŸ”¬ Anomalies" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:AnomaliesView DataContext="{Binding AnomaliesViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸ–¥ï¸ Host Inventory" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:HostInventoryView DataContext="{Binding HostInventoryViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸ” Compare" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:CompareView DataContext="{Binding CompareViewModel}" />
            </TabItem>
            <TabItem IsEnabled="{Binding CanAccessAnalysisTabs}">
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸ“ˆ Reports" FontSize="{StaticResource FontSizeMedium}" VerticalAlignment="Center"/>
                    </StackPanel>
                </TabItem.Header>
                <ns3:ReportView DataContext="{Binding ReportViewModel}" />
            </TabItem>
            </TabControl>

            <!-- âœ… GLOBAL PROGRESS OVERLAY PERMANENTLY REMOVED
                 Progress now handled exclusively by FileSelectionControl in File Manager tab.
                 This prevents the "popup keeps reappearing" bug by eliminating duplicate code paths.
                 See: docs/ARCHITECTURE_REVIEW_2025-01-19.md - Critical Issue C1 -->

            <!-- Stream Analysis Popup Overlay (for Packets Over Time chart click - stream-focused) -->
            <Border Background="{StaticResource OverlayBlack50}" IsVisible="{Binding Charts.IsStreamPopupOpen}"
                    PointerPressed="OnStreamPopupBackgroundPressed">
                <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                        Background="{DynamicResource PopupBgBrush}" CornerRadius="8" BorderBrush="{DynamicResource PopupBorderBrush}" BorderThickness="1"
                        MinWidth="400" MaxWidth="500" Padding="16"
                        DataContext="{Binding Charts.StreamPopupViewModel}">
                    <StackPanel Spacing="16">
                        <!-- Header -->
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="{Binding TimeDisplay, StringFormat='Time: {0}'}"
                                       FontSize="{StaticResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource PopupTextBrush}"/>
                            <Button Grid.Column="1" Command="{Binding CloseCommand}"
                                    Background="Transparent" BorderThickness="0" Foreground="{DynamicResource PopupTextSecondaryBrush}"
                                    FontSize="{StaticResource FontSizeInput}" Padding="4" Cursor="Hand" Content="âœ•">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="Foreground" Value="{StaticResource PopupText}"/>
                                    </Style>
                                </Button.Styles>
                            </Button>
                        </Grid>

                        <!-- Traffic Summary -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="TRAFFIC SUMMARY" FontSize="{StaticResource FontSizeSmall}" FontWeight="SemiBold" Foreground="{DynamicResource PopupTextSecondaryBrush}"/>
                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto">
                                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="Packets:" Foreground="{DynamicResource PopupTextSecondaryBrush}" FontSize="{StaticResource FontSizeBase}"/>
                                    <TextBlock Text="{Binding TotalPackets, StringFormat='{}{0:N0}'}" Foreground="{DynamicResource PopupTextBrush}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold"/>
                                </StackPanel>
                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="Traffic:" Foreground="{DynamicResource PopupTextSecondaryBrush}" FontSize="{StaticResource FontSizeBase}"/>
                                    <TextBlock Text="{Binding TotalBytesDisplay}" Foreground="{DynamicResource PopupTextBrush}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!-- Top Streams -->
                        <StackPanel Spacing="8" IsVisible="{Binding Streams.Count}">
                            <TextBlock Text="TOP STREAMS" FontSize="{StaticResource FontSizeSmall}" FontWeight="SemiBold" Foreground="{DynamicResource PopupTextSecondaryBrush}"/>
                            <ItemsControl ItemsSource="{Binding Streams}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="Transparent" Padding="4,4" Margin="0,2" IsVisible="{Binding IsValid}">
                                            <Grid ColumnDefinitions="Auto,*,80,80">
                                                <!-- Color indicator -->
                                                <Border Grid.Column="0" Width="4" CornerRadius="2" Margin="0,0,10,0" VerticalAlignment="Stretch">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="{Binding Color}"/>
                                                    </Border.Background>
                                                </Border>
                                                <!-- Stream name -->
                                                <TextBlock Grid.Column="1" Text="{Binding DisplayName}" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource PopupLinkBrush}"
                                                           TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                                                <!-- Packet count -->
                                                <TextBlock Grid.Column="2" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}"
                                                           FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource PopupTextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                                <!-- Bytes -->
                                                <TextBlock Grid.Column="3" Text="{Binding DisplayBytes}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource PopupTextSecondaryBrush}"
                                                           HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Action Buttons -->
                        <Border Background="{DynamicResource PopupBgSecondaryBrush}" CornerRadius="4" Padding="8">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <Button Command="{Binding CopyCommand}" Background="{DynamicResource PopupBgTertiaryBrush}" BorderBrush="{DynamicResource PopupBorderBrush}" BorderThickness="1"
                                        CornerRadius="4" Padding="12,6" Cursor="Hand" Content="Copy">
                                    <Button.Styles>
                                        <Style Selector="Button:pointerover">
                                            <Setter Property="Background" Value="{StaticResource PopupBorder}"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                                <Button Command="{Binding CloseCommand}" Background="{DynamicResource PopupSuccessBrush}" BorderThickness="0"
                                        CornerRadius="4" Padding="12,6" Cursor="Hand" Content="Close" Foreground="White">
                                    <Button.Styles>
                                        <Style Selector="Button:pointerover">
                                            <Setter Property="Background" Value="{StaticResource PopupSuccessHover}"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>
            </Border>

            <!-- DrillDown Detail Popup Overlay (for Top Streams Details - Dashboard-style) -->
            <!-- Click on dark overlay closes the popup -->
            <Border Background="{StaticResource OverlayBlack50}" IsVisible="{Binding Charts.DrillDown.IsVisible}"
                    PointerPressed="OnDrillDownOverlayPressed">
                <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                        PointerPressed="OnDrillDownPopupPressed">
                    <ns4:DrillDownPopupView DataContext="{Binding Charts.DrillDown}"/>
                </Border>
            </Border>
        </Grid>
    </DockPanel>
</Window>
