<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels.Components"
             x:Class="PCAPAnalyzer.UI.Views.Controls.FileSelectionControl"
             x:DataType="vm:FileSelectionControlViewModel"
             x:Name="FileSelectionRoot">

    <UserControl.Styles>
        <!-- ==================== THEMED COLORS ==================== -->

        <!-- Main container styles -->
        <Style Selector="Border.FileControlCard">
            <Setter Property="Background" Value="{DynamicResource BackgroundCard}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderSubtleBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BoxShadow" Value="0 2 8 2 #00000040"/>
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Height" Duration="0:0:0.3" Easing="CubicEaseInOut"/>
                    <BrushTransition Property="Background" Duration="0:0:0.2"/>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.2"/>
                </Transitions>
            </Setter>
        </Style>

        <!-- Empty State: Drop Zone Styles -->
        <Style Selector="Border.DropZone">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderSubtleBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="24"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.2"/>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.2"/>
                    <ThicknessTransition Property="Padding" Duration="0:0:0.2"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Border.DropZone:pointerover">
            <Setter Property="Background" Value="{StaticResource BackgroundCard}"/>
            <Setter Property="BorderBrush" Value="{StaticResource TextMutedBrush}"/>
        </Style>

        <!-- Drag-over state (applied via code-behind) -->
        <Style Selector="Border.DropZone.DragOver">
            <Setter Property="Background" Value="{StaticResource BackgroundPanel}"/>
            <Setter Property="BorderBrush" Value="{StaticResource AccentPrimary}"/>
            <Setter Property="BorderThickness" Value="3"/>
            <Setter Property="BoxShadow" Value="0 0 16 4 #89b4fa40"/>
        </Style>

        <!-- Typography Styles -->
        <Style Selector="TextBlock.DropZoneTitle">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>

        <Style Selector="TextBlock.DropZoneSubtitle">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>

        <Style Selector="TextBlock.FormatHint">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,12,0,0"/>
        </Style>

        <Style Selector="TextBlock.FileIcon">
            <Setter Property="FontSize" Value="48"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>

        <!-- Button Styles -->
        <Style Selector="Button.ActionButton">
            <Setter Property="Height" Value="36"/>
            <Setter Property="Padding" Value="16,8"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.15"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Button.ActionButton:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.02)"/>
        </Style>

        <Style Selector="Button.ActionButton.Primary">
            <Setter Property="Background" Value="{DynamicResource AccentPrimary}"/>
            <Setter Property="Foreground" Value="{DynamicResource BackgroundDark}"/>
        </Style>

        <Style Selector="Button.ActionButton.Primary:pointerover">
            <Setter Property="Background" Value="{StaticResource SlackInfo}"/>
        </Style>

        <Style Selector="Button.ActionButton.Secondary">
            <Setter Property="Background" Value="{DynamicResource BorderSubtleBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>

        <Style Selector="Button.ActionButton.Secondary:pointerover">
            <Setter Property="Background" Value="{StaticResource BorderPrimary}"/>
        </Style>

        <Style Selector="Button.ActionButton.Warning">
            <Setter Property="Background" Value="{DynamicResource SlackWarning}"/>
            <Setter Property="Foreground" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>

        <Style Selector="Button.ActionButton.Warning:pointerover">
            <Setter Property="Background" Value="{StaticResource SlackWarning}"/>
            <Setter Property="Opacity" Value="0.8"/>
        </Style>

        <Style Selector="Button.ActionButton.Danger">
            <Setter Property="Background" Value="{DynamicResource SlackDanger}"/>
            <Setter Property="Foreground" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>

        <Style Selector="Button.ActionButton.Danger:pointerover">
            <Setter Property="Background" Value="{StaticResource SlackDanger}"/>
            <Setter Property="Opacity" Value="0.8"/>
        </Style>

        <Style Selector="Button.ActionButton.Minimal">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource AccentPrimary}"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>

        <Style Selector="Button.ActionButton.Minimal:pointerover">
            <Setter Property="Background" Value="{StaticResource BackgroundCard}"/>
        </Style>

        <!-- Metric Card Styles (Complete State) -->
        <Style Selector="Border.MetricCard">
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="MinWidth" Value="140"/>
        </Style>

        <Style Selector="Border.MetricCard.Packets">
            <Setter Property="Background" Value="{StaticResource FileStateSuccess}"/>
            <Setter Property="BorderBrush" Value="{StaticResource FileStateSuccessBorder}"/>
        </Style>

        <Style Selector="Border.MetricCard.Size">
            <Setter Property="Background" Value="{StaticResource FileStateInfo}"/>
            <Setter Property="BorderBrush" Value="{StaticResource FileStateInfoBorder}"/>
        </Style>

        <Style Selector="Border.MetricCard.Duration">
            <Setter Property="Background" Value="{StaticResource FileStatePurple}"/>
            <Setter Property="BorderBrush" Value="{StaticResource FileStatePurpleBorder}"/>
        </Style>

        <Style Selector="TextBlock.MetricValue">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>

        <Style Selector="TextBlock.MetricLabel">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>

        <Style Selector="TextBlock.MetricIcon">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,0,6"/>
        </Style>

        <!-- File Selected State Styles (Countdown) -->
        <Style Selector="Border.FileSelectedBar">
            <Setter Property="Background" Value="{DynamicResource BackgroundCard}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="0"/>
        </Style>

        <!-- Analyzing State Styles -->
        <Style Selector="Border.AnalyzingBar">
            <Setter Property="Background" Value="{DynamicResource BackgroundCard}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="16,12"/>
        </Style>

        <Style Selector="TextBlock.AnalyzingText">
            <Setter Property="Foreground" Value="{DynamicResource SlackWarning}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Collapsed State Styles -->
        <Style Selector="Border.Collapsed">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.15"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Border.Collapsed:pointerover">
            <Setter Property="Background" Value="{StaticResource BackgroundCard}"/>
        </Style>

        <Style Selector="TextBlock.CollapsedText">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
        </Style>

        <!-- Pulsing border animation (Empty state hover) -->
        <Style Selector="Border.DropZone.Pulse">
            <Style.Animations>
                <Animation Duration="0:0:2" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="BorderBrush" Value="{StaticResource BorderSubtleBrush}"/>
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="BorderBrush" Value="{StaticResource TextMutedBrush}"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="BorderBrush" Value="{StaticResource BorderSubtleBrush}"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- Shimmer animation (Analyzing state) -->
        <Style Selector="Border.Shimmer">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="0.6"/>
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="0.6"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>

    <!-- Main container with adaptive height -->
    <Border Classes="FileControlCard"
            Height="{Binding FileControlHeight}"
            DragDrop.AllowDrop="True">

        <!-- Container for all states (only one visible at a time) -->
        <Grid>

            <!-- ==================== STATE 1: EMPTY (Drop zone) ==================== -->
            <Border Classes="DropZone"
                    IsVisible="{Binding IsEmpty}"
                    x:Name="DropZoneBorder"
                    AutomationProperties.Name="File drop zone. Drop PCAP file here or click to browse for a file."
                    AutomationProperties.HelpText="Supported formats: .pcap, .pcapng, .cap"
                    Focusable="True"
                    TabIndex="0"
                    Cursor="Hand"
                    Tapped="OnDropZoneTapped">

                <Grid RowDefinitions="Auto,Auto,Auto,Auto">
                    <!-- File icon -->
                    <TextBlock Text="ðŸ“‚"
                               Classes="FileIcon"
                               Grid.Row="0"/>

                    <!-- Primary text -->
                    <TextBlock Text="Drop or click to select PCAP file"
                               Classes="DropZoneTitle"
                               Grid.Row="1"/>

                    <!-- Secondary text (Browse button removed since entire area is clickable) -->
                    <TextBlock Text="Click anywhere in this area to browse"
                               Classes="DropZoneSubtitle"
                               Grid.Row="2"
                               Margin="0,8,0,0"
                               HorizontalAlignment="Center"/>

                    <!-- Supported formats hint -->
                    <TextBlock Text="Supported: .pcap, .pcapng, .cap"
                               Classes="FormatHint"
                               Grid.Row="3"/>
                </Grid>
            </Border>

            <!-- ==================== STATE 2: FILE SELECTED (Auto-start countdown) ==================== -->
            <Border Classes="FileSelectedBar"
                    IsVisible="{Binding IsFileSelected}"
                    AutomationProperties.Name="File selected, preparing to analyze"
                    AutomationProperties.LiveSetting="Polite">

                <Grid RowDefinitions="Auto,Auto,Auto"
                      Margin="16,12">

                    <!-- Row 0: File name with icon -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                Grid.Row="0"
                                Margin="0,0,0,8">
                        <TextBlock Text="ðŸ“"
                                   FontSize="{StaticResource FontSizeLarge}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding FileName}"
                                   FontSize="{StaticResource FontSizeInput}"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="400"/>
                    </StackPanel>

                    <!-- Row 1: Visual countdown display -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                Spacing="12"
                                Grid.Row="1"
                                Margin="0,0,0,12">

                        <!-- Countdown circle with large number -->
                        <Border Width="60"
                                Height="60"
                                CornerRadius="30"
                                Background="{StaticResource FileStateWarning}"
                                BorderBrush="{DynamicResource SlackWarning}"
                                BorderThickness="3">
                            <TextBlock Text="{Binding CountdownSeconds}"
                                       FontSize="{StaticResource FontSizeDisplay}"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource SlackWarning}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>

                        <!-- Countdown message -->
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Auto-starting in..."
                                       FontSize="{StaticResource FontSizeSmall}"
                                       Foreground="{DynamicResource TextMutedBrush}"
                                       HorizontalAlignment="Left"/>
                            <TextBlock Text="(or click Analyze Now)"
                                       FontSize="{StaticResource FontSizeMedium}"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource SlackWarning}"
                                       HorizontalAlignment="Left"
                                       Margin="0,4,0,0"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Row 2: Action buttons -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                Spacing="12"
                                Grid.Row="2">

                        <!-- Cancel button -->
                        <Button Content="â¹ Cancel"
                                Classes="ActionButton Danger"
                                Command="{Binding CancelCountdownCommand}"
                                AutomationProperties.Name="Cancel file selection and countdown"
                                ToolTip.Tip="Return to file selection"/>

                        <!-- Analyze Now button -->
                        <Button Content="âš¡ Analyze Now"
                                Classes="ActionButton Success"
                                Command="{Binding AnalyzeNowCommand}"
                                AutomationProperties.Name="Skip countdown and start analysis immediately"
                                ToolTip.Tip="Skip countdown and start immediately"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ==================== STATE 3: ANALYZING (Real-time progress) ==================== -->
            <Border Classes="AnalyzingBar"
                    IsVisible="{Binding IsAnalyzing}"
                    AutomationProperties.Name="File analysis in progress"
                    AutomationProperties.LiveSetting="Polite">

                <Grid RowDefinitions="Auto,Auto,Auto">
                    <!-- Row 0: Progress message with percentage -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                Grid.Row="0"
                                Margin="0,0,0,8">
                        <TextBlock Text="âš¡"
                                   FontSize="{StaticResource FontSizeLarge}"
                                   Foreground="{DynamicResource SlackWarning}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding ProgressMessage}"
                                   FontSize="{StaticResource FontSizeInput}"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Row 1: Progress bar -->
                    <ProgressBar Value="{Binding ProgressPercentage}"
                                 Minimum="0"
                                 Maximum="100"
                                 Height="6"
                                 CornerRadius="3"
                                 Background="{DynamicResource BackgroundDark}"
                                 Foreground="{DynamicResource AccentPrimary}"
                                 Grid.Row="1"
                                 Margin="0,0,0,8"
                                 AutomationProperties.Name="Analysis progress"/>

                    <!-- Row 2: Time + Speed + Stop button -->
                    <Grid ColumnDefinitions="*,Auto,*"
                          Grid.Row="2">
                        <!-- Left: Elapsed time -->
                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Left"
                                    Grid.Column="0">
                            <TextBlock Text="â±"
                                       FontSize="{StaticResource FontSizeBase}"
                                       Foreground="{DynamicResource TextMutedBrush}"
                                       VerticalAlignment="Center"
                                       Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding ElapsedTimeFormatted}"
                                       FontSize="{StaticResource FontSizeBase}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text=" â€¢ ETA: "
                                       FontSize="{StaticResource FontSizeBase}"
                                       Foreground="{DynamicResource TextMutedBrush}"
                                       VerticalAlignment="Center"
                                       Margin="8,0,0,0"/>
                            <TextBlock Text="{Binding RemainingTimeFormatted}"
                                       FontSize="{StaticResource FontSizeBase}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Center: Stop button -->
                        <Button Content="â¹ Stop"
                                Classes="ActionButton Danger"
                                Command="{Binding StopCommand}"
                                Grid.Column="1"
                                Margin="16,0"
                                AutomationProperties.Name="Stop file analysis"/>

                        <!-- Right: Packets processed -->
                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Right"
                                    Grid.Column="2">
                            <TextBlock Text="ðŸ“¦"
                                       FontSize="{StaticResource FontSizeBase}"
                                       Foreground="{DynamicResource TextMutedBrush}"
                                       VerticalAlignment="Center"
                                       Margin="0,0,4,0"/>
                            <TextBlock FontSize="{StaticResource FontSizeBase}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0:N0} / {1:N0} packets">
                                        <Binding Path="PacketsProcessed"/>
                                        <Binding Path="TotalPacketsInFile"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>

            <!-- ==================== STATE 4: COMPLETE (4 Metric cards + Stage breakdown + Actions) ==================== -->
            <Grid IsVisible="{Binding IsComplete}"
                  RowDefinitions="Auto,Auto,Auto,Auto"
                  AutomationProperties.Name="File analysis complete">

                <!-- Row 0: File name (subtle, top) -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Grid.Row="0"
                            Margin="0,0,0,10">
                    <TextBlock Text="ðŸ“„"
                               FontSize="{StaticResource FontSizeInput}"
                               VerticalAlignment="Center"
                               Margin="0,0,6,0"/>
                    <TextBlock Text="{Binding FileName}"
                               FontSize="{StaticResource FontSizeMedium}"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Row 1: 4 Metric cards (Packets, Rate, Volume, Time) -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Grid.Row="1"
                            Spacing="8"
                            Margin="0,0,0,10">

                    <!-- Card 1: Total Packets (FULL number) -->
                    <Border Classes="MetricCard Packets"
                            AutomationProperties.Name="Total packets analyzed">
                        <StackPanel>
                            <TextBlock Text="ðŸ“¦" Classes="MetricIcon"/>
                            <TextBlock Text="{Binding PacketCountFullFormatted}"
                                       Classes="MetricValue"
                                       Foreground="{DynamicResource SlackSuccess}"
                                       FontSize="15"/>
                            <TextBlock Text="packets" Classes="MetricLabel"/>
                        </StackPanel>
                    </Border>

                    <!-- Card 2: Processing Rate -->
                    <Border Classes="MetricCard Rate"
                            AutomationProperties.Name="Processing rate">
                        <StackPanel>
                            <TextBlock Text="âš¡" Classes="MetricIcon"/>
                            <TextBlock Text="{Binding ProcessingRateFormatted}"
                                       Classes="MetricValue"
                                       Foreground="{DynamicResource SlackWarning}"
                                       FontSize="{StaticResource FontSizeInput}"
                                       TextWrapping="NoWrap"/>
                            <TextBlock Text="pkts/sec" Classes="MetricLabel"/>
                        </StackPanel>
                    </Border>

                    <!-- Card 3: Traffic Volume -->
                    <Border Classes="MetricCard Volume"
                            AutomationProperties.Name="Traffic volume">
                        <StackPanel>
                            <TextBlock Text="ðŸ’¾" Classes="MetricIcon"/>
                            <TextBlock Text="{Binding FileSizeFormatted}"
                                       Classes="MetricValue"
                                       Foreground="{DynamicResource AccentPrimary}"/>
                            <TextBlock Text="traffic" Classes="MetricLabel"/>
                        </StackPanel>
                    </Border>

                    <!-- Card 4: Total Elapsed Time -->
                    <Border Classes="MetricCard Time"
                            AutomationProperties.Name="Total analysis time">
                        <StackPanel>
                            <TextBlock Text="â±" Classes="MetricIcon"/>
                            <TextBlock Text="{Binding ElapsedTimeFormatted}"
                                       Classes="MetricValue"
                                       Foreground="{DynamicResource AccentPurpleBrush}"/>
                            <TextBlock Text="elapsed" Classes="MetricLabel"/>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Row 2: Stage breakdown summary -->
                <TextBlock Text="{Binding StageBreakdownSummary}"
                           FontSize="{StaticResource FontSizeBase}"
                           Foreground="{DynamicResource TextMutedBrush}"
                           HorizontalAlignment="Center"
                           TextWrapping="Wrap"
                           TextAlignment="Center"
                           Grid.Row="2"
                           Margin="16,0,16,10"
                           MaxWidth="700"
                           AutomationProperties.Name="Analysis stage timing breakdown"/>

                <!-- Row 3: Action buttons -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Grid.Row="3"
                            Margin="0,0,0,0"
                            Spacing="8">
                    <Button Content="ðŸ”„ Reanalyze"
                            Classes="ActionButton Warning"
                            Command="{Binding ReanalyzeCommand}"
                            AutomationProperties.Name="Reanalyze this file"/>
                    <Button Content="ðŸ—‘ Clear"
                            Classes="ActionButton Danger"
                            Command="{Binding ClearCommand}"
                            AutomationProperties.Name="Clear current file"/>
                    <Button Content="â–¼ Hide"
                            Classes="ActionButton Minimal"
                            Command="{Binding CollapseCommand}"
                            AutomationProperties.Name="Collapse file control"/>
                </StackPanel>
            </Grid>

            <!-- ==================== STATE 4: COLLAPSED (Minimal indicator) ==================== -->
            <Border Classes="Collapsed"
                    IsVisible="{Binding IsCollapsed}"
                    Tapped="OnCollapsedBarTapped"
                    AutomationProperties.Name="File control collapsed. Click to expand."
                    Focusable="True"
                    TabIndex="0">
                <StackPanel Orientation="Horizontal"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                    <TextBlock Classes="CollapsedText">
                        <Run Text="ðŸ“„"/>
                        <Run Text="{Binding FileName}"/>
                        <Run Text=" loaded  â€¢  "/>
                        <Run Text="â–² Show" Foreground="{DynamicResource AccentPrimary}"/>
                    </TextBlock>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</UserControl>
