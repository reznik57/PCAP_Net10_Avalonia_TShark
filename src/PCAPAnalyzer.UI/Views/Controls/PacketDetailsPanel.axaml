<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels.Components"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="400"
             x:Class="PCAPAnalyzer.UI.Views.Controls.PacketDetailsPanel"
             x:DataType="vm:PacketDetailsViewModel">

    <!-- Packet Details Panel - 2 Tabs: Packet Analysis, Stream Context -->
    <Border Classes="modern-card-unified" Padding="0">
        <Grid RowDefinitions="Auto,Auto">

            <!-- Header -->
            <Border Grid.Row="0" Classes="table-header-unified">
                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <Border Classes="accent-bar" Background="{DynamicResource AccentSecondary}"/>
                        <TextBlock Text="Packet Details" Classes="section-title-unified" Margin="0"/>
                        <Border Classes="badge-unified" IsVisible="{Binding HasPacket}">
                            <TextBlock Text="{Binding CurrentPacket.FrameNumber, StringFormat='Frame #{0:N0}'}" Foreground="{DynamicResource AccentSecondary}"/>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Tab Content -->
            <TabControl Grid.Row="1" Background="Transparent" Padding="0">

                <!-- Tab 1: Packet Analysis (merged Protocol Details + Deep Dive) - SLACK STYLE -->
                <TabItem Header="Packet Analysis">
                    <Border Background="{DynamicResource BackgroundDark}" Padding="16">
                        <Grid>
                            <!-- Empty state when no packet selected -->
                            <StackPanel IsVisible="{Binding !HasPacket}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="12">
                                <TextBlock Text="ðŸ“¦" FontSize="{StaticResource FontSizeDisplay}" HorizontalAlignment="Center" Opacity="0.3"/>
                                <TextBlock Text="{Binding EmptyStateMessage}"
                                           FontSize="{StaticResource FontSizeInput}"
                                           Foreground="{DynamicResource TextMutedBrush}"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Packet Analysis when packet is selected -->
                            <ScrollViewer IsVisible="{Binding HasPacket}"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled">
                                <StackPanel Spacing="12" MaxWidth="900">

                                    <!-- SECTION 1: Quick Summary (Instant from PacketInfo) - SLACK STYLE -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <StackPanel Spacing="10">
                                            <TextBlock Text="Quick Summary"
                                                       FontSize="{StaticResource FontSizeMedium}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource AccentPrimary}"
                                                       Margin="0,0,0,4"/>

                                            <!-- Connection Flow -->
                                            <Border Background="{DynamicResource BackgroundDark}" CornerRadius="8" Padding="12,10" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                                    <TextBlock Text="{Binding CurrentPacket.SourceIP}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="{StaticResource FontSizeMedium}"
                                                               Foreground="{DynamicResource SlackSuccess}"
                                                               FontWeight="SemiBold"/>
                                                    <TextBlock Text=":" Foreground="{DynamicResource TextMutedBrush}" FontSize="{StaticResource FontSizeMedium}"/>
                                                    <TextBlock Text="{Binding CurrentPacket.SourcePort}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="{StaticResource FontSizeMedium}"
                                                               Foreground="{DynamicResource SlackSuccess}"/>
                                                    <TextBlock Text="â†’" Foreground="{DynamicResource AccentPrimary}" FontSize="{StaticResource FontSizeLarge}" FontWeight="Bold" Margin="8,0"/>
                                                    <TextBlock Text="{Binding CurrentPacket.DestinationIP}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="{StaticResource FontSizeMedium}"
                                                               Foreground="{DynamicResource SlackInfo}"
                                                               FontWeight="SemiBold"/>
                                                    <TextBlock Text=":" Foreground="{DynamicResource TextMutedBrush}" FontSize="{StaticResource FontSizeMedium}"/>
                                                    <TextBlock Text="{Binding CurrentPacket.DestinationPort}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="{StaticResource FontSizeMedium}"
                                                               Foreground="{DynamicResource SlackInfo}"/>
                                                </StackPanel>
                                            </Border>

                                            <!-- Key Metrics Grid -->
                                            <Grid ColumnDefinitions="*,*,*,*" RowDefinitions="Auto">
                                                <!-- Protocol -->
                                                <Border Grid.Column="0" Background="{DynamicResource BackgroundCard}" CornerRadius="8" Padding="10,8" Margin="0,0,4,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Protocol" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.Protocol}"
                                                                   FontSize="{StaticResource FontSizeInput}"
                                                                   FontWeight="Bold"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- L7 Protocol -->
                                                <Border Grid.Column="1" Background="{DynamicResource BackgroundCard}" CornerRadius="8" Padding="10,8" Margin="2,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Service" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.L7Protocol, TargetNullValue='--'}"
                                                                   FontSize="{StaticResource FontSizeInput}"
                                                                   FontWeight="Bold"
                                                                   Foreground="{DynamicResource AccentPurpleBrush}"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Size -->
                                                <Border Grid.Column="2" Background="{DynamicResource BackgroundCard}" CornerRadius="8" Padding="10,8" Margin="2,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Size" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.Length, StringFormat='{}{0} B'}"
                                                                   FontSize="{StaticResource FontSizeInput}"
                                                                   FontWeight="Bold"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Frame -->
                                                <Border Grid.Column="3" Background="{DynamicResource BackgroundCard}" CornerRadius="8" Padding="10,8" Margin="4,0,0,0" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Frame" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.FrameNumber, StringFormat='#{0:N0}'}"
                                                                   FontSize="{StaticResource FontSizeInput}"
                                                                   FontWeight="Bold"
                                                                   Foreground="{DynamicResource AccentPrimary}"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>

                                            <!-- Timestamp and Info -->
                                            <Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto" Margin="0,4,0,0">
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Timestamp:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1"
                                                           Text="{Binding CurrentPacket.Timestamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss.ffffff}'}"
                                                           FontSize="{StaticResource FontSizeSmall}"
                                                           FontFamily="Consolas, monospace"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Info:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,4,0,0"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1"
                                                           Text="{Binding CurrentPacket.Info, TargetNullValue='--'}"
                                                           FontSize="{StaticResource FontSizeSmall}"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                           TextWrapping="Wrap"
                                                           Margin="0,4,0,0"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- SECTION 2: Cleartext Credentials (CRITICAL - shown prominently if detected) -->
                                    <Border IsVisible="{Binding HasCleartextCredentials}"
                                            Background="{StaticResource SecurityCriticalBg}"
                                            CornerRadius="8"
                                            Padding="16"
                                            BorderBrush="{StaticResource ThreatCritical}"
                                            BorderThickness="2">
                                        <StackPanel Spacing="12">
                                            <!-- Warning Header -->
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <TextBlock Text="âš ï¸" FontSize="{StaticResource FontSizeHeading}"/>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding CleartextSeverityText}"
                                                               FontSize="{StaticResource FontSizeLarge}"
                                                               FontWeight="Bold"
                                                               Foreground="{Binding CleartextSeverityColor}"/>
                                                    <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{StaticResource SecurityCriticalTextLight}">
                                                        <TextBlock.Text>
                                                            <MultiBinding StringFormat="{}Detected {0} credential(s) in cleartext">
                                                                <Binding Path="TotalCredentialsCount"/>
                                                            </MultiBinding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </StackPanel>
                                            </StackPanel>

                                            <!-- Cleartext Content Items -->
                                            <ItemsControl ItemsSource="{Binding CleartextContents}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="vm:CleartextContentViewModel">
                                                        <Border Background="{Binding HeaderColor}"
                                                                CornerRadius="6"
                                                                Padding="12"
                                                                Margin="0,4"
                                                                BorderBrush="{Binding SeverityColor}"
                                                                BorderThickness="1">
                                                            <StackPanel Spacing="8">
                                                                <!-- Content Header -->
                                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                                    <TextBlock Text="{Binding SeverityIcon}" FontSize="{StaticResource FontSizeInput}"/>
                                                                    <TextBlock Text="{Binding Protocol}"
                                                                               FontSize="{StaticResource FontSizeMedium}"
                                                                               FontWeight="Bold"
                                                                               Foreground="{DynamicResource PopupTextBrush}"/>
                                                                    <TextBlock Text="-" Foreground="{DynamicResource PopupTextSecondaryBrush}" FontSize="{StaticResource FontSizeMedium}"/>
                                                                    <TextBlock Text="{Binding Description}"
                                                                               FontSize="{StaticResource FontSizeBase}"
                                                                               Foreground="{DynamicResource PopupTextBrush}"/>
                                                                </StackPanel>

                                                                <!-- Credentials List -->
                                                                <ItemsControl ItemsSource="{Binding Credentials}"
                                                                              IsVisible="{Binding HasCredentials}">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="vm:CleartextCredentialViewModel">
                                                                            <Border Background="{DynamicResource PopupBgBrush}"
                                                                                    CornerRadius="4"
                                                                                    Padding="10,6"
                                                                                    Margin="0,2">
                                                                                <Grid ColumnDefinitions="20,100,*">
                                                                                    <TextBlock Grid.Column="0"
                                                                                               Text="{Binding Icon}"
                                                                                               FontSize="{StaticResource FontSizeBase}"/>
                                                                                    <TextBlock Grid.Column="1"
                                                                                               Text="{Binding FieldName}"
                                                                                               FontFamily="Consolas, monospace"
                                                                                               FontSize="{StaticResource FontSizeSmall}"
                                                                                               FontWeight="SemiBold"
                                                                                               Foreground="{Binding FieldColor}"/>
                                                                                    <TextBlock Grid.Column="2"
                                                                                               Text="{Binding Value}"
                                                                                               FontFamily="Consolas, monospace"
                                                                                               FontSize="{StaticResource FontSizeSmall}"
                                                                                               Foreground="{Binding ValueColor}"
                                                                                               TextWrapping="Wrap"/>
                                                                                </Grid>
                                                                            </Border>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>

                                                                <!-- Raw Content Preview -->
                                                                <Border IsVisible="{Binding RawContent.Length}"
                                                                        Background="{DynamicResource PopupBgBrush}"
                                                                        CornerRadius="4"
                                                                        Padding="8"
                                                                        Margin="0,4,0,0">
                                                                    <TextBlock Text="{Binding RawContent}"
                                                                               FontFamily="Consolas, monospace"
                                                                               FontSize="{StaticResource FontSizeXS}"
                                                                               Foreground="{DynamicResource PopupTextSecondaryBrush}"
                                                                               TextWrapping="Wrap"
                                                                               MaxLines="5"/>
                                                                </Border>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- Security Warning -->
                                            <Border Background="{StaticResource SecurityCriticalBgDark}" CornerRadius="4" Padding="10,8">
                                                <TextBlock Text="ðŸ” Security Alert: These credentials were transmitted in cleartext and may have been intercepted. Consider rotating any exposed passwords or tokens."
                                                           FontSize="{StaticResource FontSizeSmall}"
                                                           Foreground="{StaticResource SecurityCriticalText}"
                                                           TextWrapping="Wrap"/>
                                            </Border>
                                        </StackPanel>
                                    </Border>

                                    <!-- SECTION 3: Protocol Deep Dive (TShark Details) - SLACK STYLE -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <StackPanel Spacing="12">

                                            <!-- Header with Load Button -->
                                            <Grid ColumnDefinitions="*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                                    <TextBlock Text="ðŸ”¬" FontSize="{StaticResource FontSizeLarge}"/>
                                                    <TextBlock Text="Protocol Layers"
                                                               FontSize="{StaticResource FontSizeMedium}"
                                                               FontWeight="SemiBold"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="(TShark dissection)"
                                                               FontSize="{StaticResource FontSizeSmall}"
                                                               Foreground="{DynamicResource TextMutedBrush}"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>

                                                <!-- Load Button (shown when not loaded) -->
                                                <Button Grid.Column="1"
                                                        Command="{Binding LoadDeepDiveCommand}"
                                                        IsEnabled="{Binding !DeepDiveLoading}"
                                                        IsVisible="{Binding !DeepDiveAvailable}"
                                                        Background="{DynamicResource AccentPrimary}"
                                                        Foreground="White"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        FontWeight="SemiBold"
                                                        Padding="12,6"
                                                        CornerRadius="6">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <TextBlock Text="â³" IsVisible="{Binding DeepDiveLoading}"/>
                                                        <TextBlock Text="Load Details" IsVisible="{Binding !DeepDiveLoading}"/>
                                                        <TextBlock Text="Loading..." IsVisible="{Binding DeepDiveLoading}"/>
                                                    </StackPanel>
                                                </Button>

                                                <!-- Loaded indicator -->
                                                <Border Grid.Column="1"
                                                        IsVisible="{Binding DeepDiveAvailable}"
                                                        Background="{DynamicResource SlackSuccess}"
                                                        CornerRadius="6"
                                                        Padding="8,4">
                                                    <TextBlock Text="âœ“ Loaded" FontSize="{StaticResource FontSizeXS}" Foreground="White" FontWeight="SemiBold"/>
                                                </Border>
                                            </Grid>

                                            <!-- Not loaded placeholder -->
                                            <Border IsVisible="{Binding !DeepDiveAvailable}"
                                                    Background="{DynamicResource BackgroundDark}"
                                                    CornerRadius="8"
                                                    Padding="16"
                                                    BorderBrush="{DynamicResource BorderSubtleBrush}"
                                                    BorderThickness="1">
                                                <TextBlock Text="Click 'Load Details' to extract full protocol dissection using TShark.&#x0a;This provides accurate field values, payload content, and credential detection."
                                                           FontSize="{StaticResource FontSizeSmall}"
                                                           Foreground="{DynamicResource TextMutedBrush}"
                                                           TextWrapping="Wrap"
                                                           TextAlignment="Center"
                                                           LineHeight="16"/>
                                            </Border>

                                            <!-- Protocol Summary (when loaded) -->
                                            <Border IsVisible="{Binding DeepDiveAvailable}"
                                                    Background="{DynamicResource BackgroundDark}"
                                                    CornerRadius="8"
                                                    Padding="12"
                                                    BorderBrush="{DynamicResource BorderSubtleBrush}"
                                                    BorderThickness="1">
                                                <StackPanel Spacing="8">
                                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                                        <TextBlock Text="{Binding DeepDiveIcon}" FontSize="{StaticResource FontSizeXL}"/>
                                                        <TextBlock Text="{Binding DeepDiveProtocol}"
                                                                   FontSize="{StaticResource FontSizeInput}"
                                                                   FontWeight="Bold"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>

                                                    <!-- Key-Value Summary -->
                                                    <ItemsControl ItemsSource="{Binding DeepDiveSummary}"
                                                                  IsVisible="{Binding DeepDiveSummary.Count}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate DataType="vm:ProtocolSummaryItem">
                                                                <Grid ColumnDefinitions="120,*" Margin="0,2">
                                                                    <TextBlock Grid.Column="0"
                                                                               Text="{Binding Key, StringFormat='{}{0}:'}"
                                                                               FontSize="{StaticResource FontSizeSmall}"
                                                                               FontWeight="SemiBold"
                                                                               Foreground="{DynamicResource AccentPrimary}"/>
                                                                    <TextBlock Grid.Column="1"
                                                                               Text="{Binding Value}"
                                                                               FontSize="{StaticResource FontSizeSmall}"
                                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                                               TextWrapping="Wrap"/>
                                                                </Grid>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </StackPanel>
                                            </Border>

                                            <!-- Protocol Layers (when loaded) -->
                                            <ItemsControl ItemsSource="{Binding DeepDiveLayers}"
                                                          IsVisible="{Binding DeepDiveAvailable}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="vm:ProtocolLayerViewModel">
                                                        <Border Background="{DynamicResource BackgroundDark}" CornerRadius="8" Padding="12,10" Margin="0,4" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                            <StackPanel Spacing="6">
                                                                <!-- Layer header -->
                                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                                    <TextBlock Text="â–¸" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource AccentPrimary}" VerticalAlignment="Center"
                                                                               IsVisible="{Binding HasFields}"/>
                                                                    <TextBlock Text="{Binding Name}"
                                                                               FontFamily="Consolas, Courier New, monospace"
                                                                               FontSize="{StaticResource FontSizeBase}"
                                                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                                                               FontWeight="SemiBold"/>
                                                                </StackPanel>

                                                                <!-- Fields -->
                                                                <ItemsControl ItemsSource="{Binding Fields}"
                                                                              IsVisible="{Binding HasFields}"
                                                                              Margin="8,4,0,0">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="vm:ProtocolFieldViewModel">
                                                                            <Border Margin="{Binding IndentPixels, StringFormat='{}{0},2,0,2'}"
                                                                                    Background="Transparent"
                                                                                    Padding="0,1">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="{Binding Name, StringFormat='{}{0}:'}"
                                                                                               FontFamily="Consolas, Courier New, monospace"
                                                                                               FontSize="{StaticResource FontSizeXS}"
                                                                                               Foreground="{Binding NameColor}"/>
                                                                                    <TextBlock Text="{Binding Value}"
                                                                                               FontFamily="Consolas, Courier New, monospace"
                                                                                               FontSize="{StaticResource FontSizeXS}"
                                                                                               Foreground="{Binding ValueColor}"
                                                                                               TextWrapping="Wrap"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>

                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </TabItem>

                <!-- Tab 2: Stream Context (renamed from Stream Info) - SLACK STYLE -->
                <TabItem Header="Stream Context">
                    <Border Background="{DynamicResource BackgroundDark}" Padding="16">
                        <Grid>
                            <!-- Empty state when no packet selected -->
                            <StackPanel IsVisible="{Binding !HasPacket}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="12">
                                <TextBlock Text="ðŸŒŠ" FontSize="{StaticResource FontSizeDisplay}" HorizontalAlignment="Center" Opacity="0.3"/>
                                <TextBlock Text="{Binding EmptyStateMessage}"
                                           FontSize="{StaticResource FontSizeInput}"
                                           Foreground="{DynamicResource TextMutedBrush}"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Stream context when packet is selected -->
                            <ScrollViewer IsVisible="{Binding HasPacket}"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled">
                                <StackPanel Spacing="16" MaxWidth="800">

                                    <!-- Stream ID with Filter Button - SLACK STYLE -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <Grid RowDefinitions="Auto" ColumnDefinitions="180,*,Auto">
                                            <TextBlock Grid.Column="0"
                                                       Text="TCP/UDP Stream:"
                                                       FontSize="{StaticResource FontSizeBase}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding FlowStreamId}"
                                                       FontSize="{StaticResource FontSizeBase}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource AccentPrimary}"
                                                       VerticalAlignment="Center"/>
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                                <Button Content="ðŸ” Search"
                                                        Command="{Binding SearchByStreamCommand}"
                                                        IsVisible="{Binding CanFilterByStream}"
                                                        Background="{DynamicResource SlackSuccess}"
                                                        Foreground="White"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        FontWeight="SemiBold"
                                                        Padding="12,6"
                                                        CornerRadius="6"
                                                        ToolTip.Tip="Highlight all packets from this stream (keeps all packets visible)"/>
                                                <Button Content="ðŸ”’ Filter"
                                                        Command="{Binding FilterByStreamCommand}"
                                                        IsVisible="{Binding CanFilterByStream}"
                                                        Background="{DynamicResource AccentPrimary}"
                                                        Foreground="White"
                                                        FontSize="{StaticResource FontSizeSmall}"
                                                        FontWeight="SemiBold"
                                                        Padding="12,6"
                                                        CornerRadius="6"
                                                        ToolTip.Tip="Show ONLY packets from this stream (hides other packets)"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>

                                    <!-- Conversation -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <Grid RowDefinitions="Auto" ColumnDefinitions="180,*">
                                            <TextBlock Grid.Row="0" Grid.Column="0"
                                                       Text="Conversation:"
                                                       FontSize="{StaticResource FontSizeBase}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1"
                                                       Text="{Binding FlowConversation}"
                                                       FontSize="{StaticResource FontSizeBase}"
                                                       FontFamily="Consolas, Courier New, monospace"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       TextWrapping="Wrap"/>
                                        </Grid>
                                    </Border>

                                    <!-- Stream Navigation -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="ðŸ§­ Stream Navigation"
                                                       FontSize="{StaticResource FontSizeMedium}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       Margin="0,0,0,8"/>

                                            <Grid RowDefinitions="Auto" ColumnDefinitions="180,*">
                                                <TextBlock Grid.Row="0" Grid.Column="0"
                                                           Text="Packets in Stream:"
                                                           FontSize="{StaticResource FontSizeBase}"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1"
                                                           Text="{Binding FlowPacketCount}"
                                                           FontSize="{StaticResource FontSizeBase}"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </Grid>

                                            <!-- Navigation Buttons -->
                                            <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,8,0,0">
                                                <Button Command="{Binding NavigateToPreviousInStreamCommand}"
                                                        IsEnabled="{Binding CanNavigatePrevious}"
                                                        Background="{DynamicResource BackgroundCard}"
                                                        Foreground="{DynamicResource TextSecondaryBrush}"
                                                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                                                        BorderThickness="1"
                                                        Padding="12,8"
                                                        CornerRadius="6">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <TextBlock Text="â—€" FontSize="{StaticResource FontSizeBase}"/>
                                                        <TextBlock Text="Previous" FontSize="{StaticResource FontSizeSmall}"/>
                                                        <TextBlock Text="{Binding PreviousPacketInStream, StringFormat='#{0}'}"
                                                                   FontSize="{StaticResource FontSizeSmall}"
                                                                   Foreground="{DynamicResource AccentPrimary}"
                                                                   IsVisible="{Binding CanNavigatePrevious}"/>
                                                    </StackPanel>
                                                </Button>

                                                <Button Command="{Binding NavigateToNextInStreamCommand}"
                                                        IsEnabled="{Binding CanNavigateNext}"
                                                        Background="{DynamicResource BackgroundCard}"
                                                        Foreground="{DynamicResource TextSecondaryBrush}"
                                                        BorderBrush="{DynamicResource BorderSubtleBrush}"
                                                        BorderThickness="1"
                                                        Padding="12,8"
                                                        CornerRadius="6">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <TextBlock Text="Next" FontSize="{StaticResource FontSizeSmall}"/>
                                                        <TextBlock Text="{Binding NextPacketInStream, StringFormat='#{0}'}"
                                                                   FontSize="{StaticResource FontSizeSmall}"
                                                                   Foreground="{DynamicResource AccentPrimary}"
                                                                   IsVisible="{Binding CanNavigateNext}"/>
                                                        <TextBlock Text="â–¶" FontSize="{StaticResource FontSizeBase}"/>
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>

                                    <!-- Stream Statistics -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <StackPanel Spacing="8">
                                            <TextBlock Text="ðŸ“Š Stream Statistics"
                                                       FontSize="{StaticResource FontSizeMedium}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       Margin="0,0,0,8"/>

                                            <TextBlock Text="{Binding FlowStatistics}"
                                                       FontSize="{StaticResource FontSizeSmall}"
                                                       FontFamily="Consolas, monospace"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       TextWrapping="Wrap"
                                                       LineHeight="16"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Security Analysis -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <StackPanel Spacing="12">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="ðŸ”’ Security Analysis"
                                                           FontSize="{StaticResource FontSizeMedium}"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <Border Background="{Binding SecurityRiskColor}"
                                                        CornerRadius="6"
                                                        Padding="8,2">
                                                    <TextBlock Text="{Binding SecurityRiskLevel}"
                                                               FontSize="{StaticResource FontSizeSmall}"
                                                               FontWeight="SemiBold"
                                                               Foreground="White"/>
                                                </Border>
                                            </StackPanel>

                                            <!-- Enhanced Security Metrics (Risk Score, Encryption, Beaconing, Exfiltration) -->
                                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8"
                                                  IsVisible="{Binding HasEnhancedSecurityAnalysis}">
                                                <!-- Risk Score -->
                                                <Border Grid.Row="0" Grid.Column="0" Background="{DynamicResource BackgroundDark}" CornerRadius="8" Padding="10" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="RISK SCORE" FontSize="{StaticResource FontSizeXS}" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <TextBlock Text="{Binding StreamRiskScoreDisplay}" FontSize="{StaticResource FontSizeXL}" FontWeight="Bold" Foreground="{Binding SecurityRiskColor}"/>
                                                            <TextBlock Text="/100" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" VerticalAlignment="Bottom" Margin="0,0,0,2"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Encryption Status -->
                                                <Border Grid.Row="0" Grid.Column="1" Background="{DynamicResource BackgroundDark}" CornerRadius="8" Padding="10" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="ENCRYPTION" FontSize="{StaticResource FontSizeXS}" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}"/>
                                                        <TextBlock Text="{Binding EncryptionStatus}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{Binding EncryptionStatusColor}"/>
                                                        <TextBlock Text="{Binding EncryptionProtocol}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"
                                                                   IsVisible="{Binding EncryptionProtocol.Length}"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Beaconing Detection -->
                                                <Border Grid.Row="1" Grid.Column="0" Background="{DynamicResource BackgroundDark}" CornerRadius="8" Padding="10" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="BEACONING" FontSize="{StaticResource FontSizeXS}" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <TextBlock Text="{Binding BeaconingInterval}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{Binding BeaconingColor}"/>
                                                            <TextBlock Text="{Binding BeaconingConfidence}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Bottom"
                                                                       IsVisible="{Binding BeaconingDetected}"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Data Transfer Ratio -->
                                                <Border Grid.Row="1" Grid.Column="1" Background="{DynamicResource BackgroundDark}" CornerRadius="8" Padding="10" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="UPLOAD/DOWNLOAD" FontSize="{StaticResource FontSizeXS}" FontWeight="SemiBold" Foreground="{DynamicResource TextMutedBrush}"/>
                                                        <TextBlock Text="{Binding UploadDownloadRatio}" FontSize="{StaticResource FontSizeBase}" FontWeight="SemiBold" Foreground="{Binding ExfiltrationColor}"/>
                                                        <TextBlock Text="âš  Exfiltration indicator" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource SlackWarning}"
                                                                   IsVisible="{Binding DataExfiltrationIndicator}"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>

                                            <!-- Port and Location Info -->
                                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="180,*">
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Source Port:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SourcePortSecurity}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}"/>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Destination Port:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding DestinationPortSecurity}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Source Location:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SourceGeoInfo}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Destination Location:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding DestinationGeoInfo}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,6,0,0"/>
                                            </Grid>

                                            <!-- Security Warnings -->
                                            <ItemsControl ItemsSource="{Binding SecurityWarnings}"
                                                          IsVisible="{Binding HasSecurityWarnings}"
                                                          Margin="0,8,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="{StaticResource SecurityWarningBg}"
                                                                BorderBrush="{StaticResource SecurityWarningBorder}"
                                                                BorderThickness="1"
                                                                CornerRadius="6"
                                                                Padding="8,4"
                                                                Margin="0,2">
                                                            <TextBlock Text="{Binding}"
                                                                       FontSize="{StaticResource FontSizeSmall}"
                                                                       Foreground="{DynamicResource SlackWarning}"
                                                                       TextWrapping="Wrap"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>

                                    <!-- Traffic Direction -->
                                    <Border Background="{DynamicResource BackgroundPanel}" CornerRadius="12" Padding="16" BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="1">
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="â†”ï¸ Traffic Direction"
                                                       FontSize="{StaticResource FontSizeMedium}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       Margin="0,0,0,8"/>

                                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="180,*">
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Client (Initiator):" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ClientTraffic}"
                                                           FontSize="{StaticResource FontSizeSmall}" FontFamily="Consolas, monospace" Foreground="{DynamicResource SlackSuccess}"/>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Server (Responder):" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ServerTraffic}"
                                                           FontSize="{StaticResource FontSizeSmall}" FontFamily="Consolas, monospace" Foreground="{DynamicResource SlackInfo}" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Dominant Direction:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TrafficDirection}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Stream Position:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding StreamPosition}"
                                                           FontSize="{StaticResource FontSizeSmall}" FontWeight="SemiBold" Foreground="{DynamicResource AccentPrimary}" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="4" Grid.Column="0" Text="Connection Age:" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding ConnectionAge}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,6,0,0"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </TabItem>

            </TabControl>
        </Grid>
    </Border>
</UserControl>
