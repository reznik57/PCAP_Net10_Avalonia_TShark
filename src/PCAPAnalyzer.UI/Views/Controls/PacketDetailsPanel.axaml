<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels.Components"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="400"
             x:Class="PCAPAnalyzer.UI.Views.Controls.PacketDetailsPanel"
             x:DataType="vm:PacketDetailsViewModel">

    <!-- Packet Details Panel - 2 Tabs: Packet Analysis, Stream Context -->
    <Border Classes="modern-card-unified" Padding="0">
        <Grid RowDefinitions="Auto,Auto">

            <!-- Header -->
            <Border Grid.Row="0" Classes="table-header-unified">
                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <Border Classes="accent-bar" Background="#8B5CF6"/>
                        <TextBlock Text="Packet Details" Classes="section-title-unified" Margin="0"/>
                        <Border Classes="badge-unified" IsVisible="{Binding HasPacket}">
                            <TextBlock Text="{Binding CurrentPacket.FrameNumber, StringFormat='Frame #{0:N0}'}" Foreground="#8B5CF6"/>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Tab Content -->
            <TabControl Grid.Row="1" Background="Transparent" Padding="0">

                <!-- Tab 1: Packet Analysis (merged Protocol Details + Deep Dive) -->
                <TabItem Header="Packet Analysis">
                    <Border Background="#0D1117" Padding="16">
                        <Grid>
                            <!-- Empty state when no packet selected -->
                            <StackPanel IsVisible="{Binding !HasPacket}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="12">
                                <TextBlock Text="ðŸ“¦" FontSize="48" HorizontalAlignment="Center" Opacity="0.3"/>
                                <TextBlock Text="{Binding EmptyStateMessage}"
                                           FontSize="14"
                                           Foreground="#6E7681"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Packet Analysis when packet is selected -->
                            <ScrollViewer IsVisible="{Binding HasPacket}"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled">
                                <StackPanel Spacing="12" MaxWidth="900">

                                    <!-- SECTION 1: Quick Summary (Instant from PacketInfo) -->
                                    <Border Background="#161B22" CornerRadius="8" Padding="16">
                                        <StackPanel Spacing="10">
                                            <TextBlock Text="Quick Summary"
                                                       FontSize="13"
                                                       FontWeight="SemiBold"
                                                       Foreground="#8B5CF6"
                                                       Margin="0,0,0,4"/>

                                            <!-- Connection Flow -->
                                            <Border Background="#0D1117" CornerRadius="6" Padding="12,10">
                                                <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                                    <TextBlock Text="{Binding CurrentPacket.SourceIP}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="13"
                                                               Foreground="#22C55E"
                                                               FontWeight="SemiBold"/>
                                                    <TextBlock Text=":" Foreground="#6E7681" FontSize="13"/>
                                                    <TextBlock Text="{Binding CurrentPacket.SourcePort}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="13"
                                                               Foreground="#22C55E"/>
                                                    <TextBlock Text="â†’" Foreground="#8B5CF6" FontSize="16" FontWeight="Bold" Margin="8,0"/>
                                                    <TextBlock Text="{Binding CurrentPacket.DestinationIP}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="13"
                                                               Foreground="#3B82F6"
                                                               FontWeight="SemiBold"/>
                                                    <TextBlock Text=":" Foreground="#6E7681" FontSize="13"/>
                                                    <TextBlock Text="{Binding CurrentPacket.DestinationPort}"
                                                               FontFamily="Consolas, monospace"
                                                               FontSize="13"
                                                               Foreground="#3B82F6"/>
                                                </StackPanel>
                                            </Border>

                                            <!-- Key Metrics Grid -->
                                            <Grid ColumnDefinitions="*,*,*,*" RowDefinitions="Auto">
                                                <!-- Protocol -->
                                                <Border Grid.Column="0" Background="#1C2128" CornerRadius="4" Padding="10,8" Margin="0,0,4,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Protocol" FontSize="10" Foreground="#6E7681" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.Protocol}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="#F0F6FC"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- L7 Protocol -->
                                                <Border Grid.Column="1" Background="#1C2128" CornerRadius="4" Padding="10,8" Margin="2,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Service" FontSize="10" Foreground="#6E7681" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.L7Protocol, TargetNullValue='--'}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="#A78BFA"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Size -->
                                                <Border Grid.Column="2" Background="#1C2128" CornerRadius="4" Padding="10,8" Margin="2,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Size" FontSize="10" Foreground="#6E7681" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.Length, StringFormat='{}{0} B'}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="#F0F6FC"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Frame -->
                                                <Border Grid.Column="3" Background="#1C2128" CornerRadius="4" Padding="10,8" Margin="4,0,0,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="Frame" FontSize="10" Foreground="#6E7681" HorizontalAlignment="Center"/>
                                                        <TextBlock Text="{Binding CurrentPacket.FrameNumber, StringFormat='#{0:N0}'}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="#58A6FF"
                                                                   HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>

                                            <!-- Timestamp and Info -->
                                            <Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto" Margin="0,4,0,0">
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Timestamp:" FontSize="11" Foreground="#6E7681"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1"
                                                           Text="{Binding CurrentPacket.Timestamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss.ffffff}'}"
                                                           FontSize="11"
                                                           FontFamily="Consolas, monospace"
                                                           Foreground="#C9D1D9"/>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Info:" FontSize="11" Foreground="#6E7681" Margin="0,4,0,0"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1"
                                                           Text="{Binding CurrentPacket.Info, TargetNullValue='--'}"
                                                           FontSize="11"
                                                           Foreground="#8B949E"
                                                           TextWrapping="Wrap"
                                                           Margin="0,4,0,0"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- SECTION 2: Cleartext Credentials (CRITICAL - shown prominently if detected) -->
                                    <Border IsVisible="{Binding HasCleartextCredentials}"
                                            Background="#7F1D1D"
                                            CornerRadius="8"
                                            Padding="16"
                                            BorderBrush="#EF4444"
                                            BorderThickness="2">
                                        <StackPanel Spacing="12">
                                            <!-- Warning Header -->
                                            <StackPanel Orientation="Horizontal" Spacing="12">
                                                <TextBlock Text="âš ï¸" FontSize="24"/>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding CleartextSeverityText}"
                                                               FontSize="16"
                                                               FontWeight="Bold"
                                                               Foreground="{Binding CleartextSeverityColor}"/>
                                                    <TextBlock FontSize="11" Foreground="#FCA5A5">
                                                        <TextBlock.Text>
                                                            <MultiBinding StringFormat="{}Detected {0} credential(s) in cleartext">
                                                                <Binding Path="TotalCredentialsCount"/>
                                                            </MultiBinding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </StackPanel>
                                            </StackPanel>

                                            <!-- Cleartext Content Items -->
                                            <ItemsControl ItemsSource="{Binding CleartextContents}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="vm:CleartextContentViewModel">
                                                        <Border Background="{Binding HeaderColor}"
                                                                CornerRadius="6"
                                                                Padding="12"
                                                                Margin="0,4"
                                                                BorderBrush="{Binding SeverityColor}"
                                                                BorderThickness="1">
                                                            <StackPanel Spacing="8">
                                                                <!-- Content Header -->
                                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                                    <TextBlock Text="{Binding SeverityIcon}" FontSize="14"/>
                                                                    <TextBlock Text="{Binding Protocol}"
                                                                               FontSize="13"
                                                                               FontWeight="Bold"
                                                                               Foreground="#F0F6FC"/>
                                                                    <TextBlock Text="-" Foreground="#6E7681" FontSize="13"/>
                                                                    <TextBlock Text="{Binding Description}"
                                                                               FontSize="12"
                                                                               Foreground="#C9D1D9"/>
                                                                </StackPanel>

                                                                <!-- Credentials List -->
                                                                <ItemsControl ItemsSource="{Binding Credentials}"
                                                                              IsVisible="{Binding HasCredentials}">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="vm:CleartextCredentialViewModel">
                                                                            <Border Background="#1C1C1C"
                                                                                    CornerRadius="4"
                                                                                    Padding="10,6"
                                                                                    Margin="0,2">
                                                                                <Grid ColumnDefinitions="20,100,*">
                                                                                    <TextBlock Grid.Column="0"
                                                                                               Text="{Binding Icon}"
                                                                                               FontSize="12"/>
                                                                                    <TextBlock Grid.Column="1"
                                                                                               Text="{Binding FieldName}"
                                                                                               FontFamily="Consolas, monospace"
                                                                                               FontSize="11"
                                                                                               FontWeight="SemiBold"
                                                                                               Foreground="{Binding FieldColor}"/>
                                                                                    <TextBlock Grid.Column="2"
                                                                                               Text="{Binding Value}"
                                                                                               FontFamily="Consolas, monospace"
                                                                                               FontSize="11"
                                                                                               Foreground="{Binding ValueColor}"
                                                                                               TextWrapping="Wrap"/>
                                                                                </Grid>
                                                                            </Border>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>

                                                                <!-- Raw Content Preview -->
                                                                <Border IsVisible="{Binding RawContent.Length}"
                                                                        Background="#0D1117"
                                                                        CornerRadius="4"
                                                                        Padding="8"
                                                                        Margin="0,4,0,0">
                                                                    <TextBlock Text="{Binding RawContent}"
                                                                               FontFamily="Consolas, monospace"
                                                                               FontSize="10"
                                                                               Foreground="#8B949E"
                                                                               TextWrapping="Wrap"
                                                                               MaxLines="5"/>
                                                                </Border>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- Security Warning -->
                                            <Border Background="#450A0A" CornerRadius="4" Padding="10,8">
                                                <TextBlock Text="ðŸ” Security Alert: These credentials were transmitted in cleartext and may have been intercepted. Consider rotating any exposed passwords or tokens."
                                                           FontSize="11"
                                                           Foreground="#FECACA"
                                                           TextWrapping="Wrap"/>
                                            </Border>
                                        </StackPanel>
                                    </Border>

                                    <!-- SECTION 3: Protocol Deep Dive (TShark Details) -->
                                    <Border Background="#161B22" CornerRadius="8" Padding="16">
                                        <StackPanel Spacing="12">

                                            <!-- Header with Load Button -->
                                            <Grid ColumnDefinitions="*,Auto">
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                                    <TextBlock Text="ðŸ”¬" FontSize="16"/>
                                                    <TextBlock Text="Protocol Layers"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="#F0F6FC"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="(TShark dissection)"
                                                               FontSize="11"
                                                               Foreground="#6E7681"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>

                                                <!-- Load Button (shown when not loaded) -->
                                                <Button Grid.Column="1"
                                                        Command="{Binding LoadDeepDiveCommand}"
                                                        IsEnabled="{Binding !DeepDiveLoading}"
                                                        IsVisible="{Binding !DeepDiveAvailable}"
                                                        Background="#238636"
                                                        Foreground="White"
                                                        FontSize="11"
                                                        FontWeight="SemiBold"
                                                        Padding="12,6"
                                                        CornerRadius="4">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <TextBlock Text="â³" IsVisible="{Binding DeepDiveLoading}"/>
                                                        <TextBlock Text="Load Details" IsVisible="{Binding !DeepDiveLoading}"/>
                                                        <TextBlock Text="Loading..." IsVisible="{Binding DeepDiveLoading}"/>
                                                    </StackPanel>
                                                </Button>

                                                <!-- Loaded indicator -->
                                                <Border Grid.Column="1"
                                                        IsVisible="{Binding DeepDiveAvailable}"
                                                        Background="#22C55E"
                                                        CornerRadius="4"
                                                        Padding="8,4">
                                                    <TextBlock Text="âœ“ Loaded" FontSize="10" Foreground="White" FontWeight="SemiBold"/>
                                                </Border>
                                            </Grid>

                                            <!-- Not loaded placeholder -->
                                            <Border IsVisible="{Binding !DeepDiveAvailable}"
                                                    Background="#0D1117"
                                                    CornerRadius="6"
                                                    Padding="16">
                                                <TextBlock Text="Click 'Load Details' to extract full protocol dissection using TShark.&#x0a;This provides accurate field values, payload content, and credential detection."
                                                           FontSize="11"
                                                           Foreground="#6E7681"
                                                           TextWrapping="Wrap"
                                                           TextAlignment="Center"
                                                           LineHeight="16"/>
                                            </Border>

                                            <!-- Protocol Summary (when loaded) -->
                                            <Border IsVisible="{Binding DeepDiveAvailable}"
                                                    Background="#0D1117"
                                                    CornerRadius="6"
                                                    Padding="12">
                                                <StackPanel Spacing="8">
                                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                                        <TextBlock Text="{Binding DeepDiveIcon}" FontSize="20"/>
                                                        <TextBlock Text="{Binding DeepDiveProtocol}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="#F0F6FC"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>

                                                    <!-- Key-Value Summary -->
                                                    <ItemsControl ItemsSource="{Binding DeepDiveSummary}"
                                                                  IsVisible="{Binding DeepDiveSummary.Count}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate DataType="vm:ProtocolSummaryItem">
                                                                <Grid ColumnDefinitions="120,*" Margin="0,2">
                                                                    <TextBlock Grid.Column="0"
                                                                               Text="{Binding Key, StringFormat='{}{0}:'}"
                                                                               FontSize="11"
                                                                               FontWeight="SemiBold"
                                                                               Foreground="#8B5CF6"/>
                                                                    <TextBlock Grid.Column="1"
                                                                               Text="{Binding Value}"
                                                                               FontSize="11"
                                                                               Foreground="#C9D1D9"
                                                                               TextWrapping="Wrap"/>
                                                                </Grid>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </StackPanel>
                                            </Border>

                                            <!-- Protocol Layers (when loaded) -->
                                            <ItemsControl ItemsSource="{Binding DeepDiveLayers}"
                                                          IsVisible="{Binding DeepDiveAvailable}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="vm:ProtocolLayerViewModel">
                                                        <Border Background="#0D1117" CornerRadius="6" Padding="12,10" Margin="0,4">
                                                            <StackPanel Spacing="6">
                                                                <!-- Layer header -->
                                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                                    <TextBlock Text="â–¸" FontSize="12" Foreground="#8B5CF6" VerticalAlignment="Center"
                                                                               IsVisible="{Binding HasFields}"/>
                                                                    <TextBlock Text="{Binding Name}"
                                                                               FontFamily="Consolas, Courier New, monospace"
                                                                               FontSize="12"
                                                                               Foreground="#F0F6FC"
                                                                               FontWeight="SemiBold"/>
                                                                </StackPanel>

                                                                <!-- Fields -->
                                                                <ItemsControl ItemsSource="{Binding Fields}"
                                                                              IsVisible="{Binding HasFields}"
                                                                              Margin="8,4,0,0">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate DataType="vm:ProtocolFieldViewModel">
                                                                            <Border Margin="{Binding IndentPixels, StringFormat='{}{0},2,0,2'}"
                                                                                    Background="Transparent"
                                                                                    Padding="0,1">
                                                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                                                    <TextBlock Text="{Binding Name, StringFormat='{}{0}:'}"
                                                                                               FontFamily="Consolas, Courier New, monospace"
                                                                                               FontSize="10"
                                                                                               Foreground="{Binding NameColor}"/>
                                                                                    <TextBlock Text="{Binding Value}"
                                                                                               FontFamily="Consolas, Courier New, monospace"
                                                                                               FontSize="10"
                                                                                               Foreground="{Binding ValueColor}"
                                                                                               TextWrapping="Wrap"/>
                                                                                </StackPanel>
                                                                            </Border>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>

                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </TabItem>

                <!-- Tab 2: Stream Context (renamed from Stream Info) -->
                <TabItem Header="Stream Context">
                    <Border Background="#0D1117" Padding="16">
                        <Grid>
                            <!-- Empty state when no packet selected -->
                            <StackPanel IsVisible="{Binding !HasPacket}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="12">
                                <TextBlock Text="ðŸŒŠ" FontSize="48" HorizontalAlignment="Center" Opacity="0.3"/>
                                <TextBlock Text="{Binding EmptyStateMessage}"
                                           FontSize="14"
                                           Foreground="#6E7681"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Stream context when packet is selected -->
                            <ScrollViewer IsVisible="{Binding HasPacket}"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled">
                                <StackPanel Spacing="16" MaxWidth="800">

                                    <!-- Stream ID with Filter Button -->
                                    <Border Classes="modern-card-unified" Padding="16" Background="#161B22">
                                        <Grid RowDefinitions="Auto" ColumnDefinitions="180,*,Auto">
                                            <TextBlock Grid.Column="0"
                                                       Text="TCP/UDP Stream:"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="#8B949E"
                                                       VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding FlowStreamId}"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="#58A6FF"
                                                       VerticalAlignment="Center"/>
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                                <Button Content="ðŸ” Search"
                                                        Command="{Binding SearchByStreamCommand}"
                                                        IsVisible="{Binding CanFilterByStream}"
                                                        Background="#22C55E"
                                                        Foreground="White"
                                                        FontSize="11"
                                                        FontWeight="SemiBold"
                                                        Padding="12,6"
                                                        CornerRadius="4"
                                                        ToolTip.Tip="Highlight all packets from this stream (keeps all packets visible)"/>
                                                <Button Content="ðŸ”’ Filter"
                                                        Command="{Binding FilterByStreamCommand}"
                                                        IsVisible="{Binding CanFilterByStream}"
                                                        Background="#8B5CF6"
                                                        Foreground="White"
                                                        FontSize="11"
                                                        FontWeight="SemiBold"
                                                        Padding="12,6"
                                                        CornerRadius="4"
                                                        ToolTip.Tip="Show ONLY packets from this stream (hides other packets)"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>

                                    <!-- Conversation -->
                                    <Border Classes="modern-card-unified" Padding="16" Background="#161B22">
                                        <Grid RowDefinitions="Auto" ColumnDefinitions="180,*">
                                            <TextBlock Grid.Row="0" Grid.Column="0"
                                                       Text="Conversation:"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="#8B949E"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1"
                                                       Text="{Binding FlowConversation}"
                                                       FontSize="12"
                                                       FontFamily="Consolas, Courier New, monospace"
                                                       Foreground="#C9D1D9"
                                                       TextWrapping="Wrap"/>
                                        </Grid>
                                    </Border>

                                    <!-- Stream Navigation -->
                                    <Border Classes="modern-card-unified" Padding="16" Background="#161B22">
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="ðŸ§­ Stream Navigation"
                                                       FontSize="13"
                                                       FontWeight="SemiBold"
                                                       Foreground="#F0F6FC"
                                                       Margin="0,0,0,8"/>

                                            <Grid RowDefinitions="Auto" ColumnDefinitions="180,*">
                                                <TextBlock Grid.Row="0" Grid.Column="0"
                                                           Text="Packets in Stream:"
                                                           FontSize="12"
                                                           Foreground="#8B949E"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1"
                                                           Text="{Binding FlowPacketCount}"
                                                           FontSize="12"
                                                           Foreground="#C9D1D9"/>
                                            </Grid>

                                            <!-- Navigation Buttons -->
                                            <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,8,0,0">
                                                <Button Command="{Binding NavigateToPreviousInStreamCommand}"
                                                        IsEnabled="{Binding CanNavigatePrevious}"
                                                        Background="#1C2128"
                                                        Foreground="#C9D1D9"
                                                        BorderBrush="#30363D"
                                                        BorderThickness="1"
                                                        Padding="12,8"
                                                        CornerRadius="4">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <TextBlock Text="â—€" FontSize="12"/>
                                                        <TextBlock Text="Previous" FontSize="11"/>
                                                        <TextBlock Text="{Binding PreviousPacketInStream, StringFormat='#{0}'}"
                                                                   FontSize="11"
                                                                   Foreground="#8B5CF6"
                                                                   IsVisible="{Binding CanNavigatePrevious}"/>
                                                    </StackPanel>
                                                </Button>

                                                <Button Command="{Binding NavigateToNextInStreamCommand}"
                                                        IsEnabled="{Binding CanNavigateNext}"
                                                        Background="#1C2128"
                                                        Foreground="#C9D1D9"
                                                        BorderBrush="#30363D"
                                                        BorderThickness="1"
                                                        Padding="12,8"
                                                        CornerRadius="4">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <TextBlock Text="Next" FontSize="11"/>
                                                        <TextBlock Text="{Binding NextPacketInStream, StringFormat='#{0}'}"
                                                                   FontSize="11"
                                                                   Foreground="#8B5CF6"
                                                                   IsVisible="{Binding CanNavigateNext}"/>
                                                        <TextBlock Text="â–¶" FontSize="12"/>
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>

                                    <!-- Stream Statistics -->
                                    <Border Classes="modern-card-unified" Padding="16" Background="#161B22">
                                        <StackPanel Spacing="8">
                                            <TextBlock Text="ðŸ“Š Stream Statistics"
                                                       FontSize="13"
                                                       FontWeight="SemiBold"
                                                       Foreground="#F0F6FC"
                                                       Margin="0,0,0,8"/>

                                            <TextBlock Text="{Binding FlowStatistics}"
                                                       FontSize="11"
                                                       FontFamily="Consolas, monospace"
                                                       Foreground="#8B949E"
                                                       TextWrapping="Wrap"
                                                       LineHeight="16"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Security Analysis -->
                                    <Border Classes="modern-card-unified" Padding="16" Background="#161B22">
                                        <StackPanel Spacing="12">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="ðŸ”’ Security Analysis"
                                                           FontSize="13"
                                                           FontWeight="SemiBold"
                                                           Foreground="#F0F6FC"/>
                                                <Border Background="{Binding SecurityRiskColor}"
                                                        CornerRadius="4"
                                                        Padding="8,2">
                                                    <TextBlock Text="{Binding SecurityRiskLevel}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="White"/>
                                                </Border>
                                            </StackPanel>

                                            <!-- Enhanced Security Metrics (Risk Score, Encryption, Beaconing, Exfiltration) -->
                                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8"
                                                  IsVisible="{Binding HasEnhancedSecurityAnalysis}">
                                                <!-- Risk Score -->
                                                <Border Grid.Row="0" Grid.Column="0" Background="#0D1117" CornerRadius="6" Padding="10">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="RISK SCORE" FontSize="10" FontWeight="SemiBold" Foreground="#6E7681"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <TextBlock Text="{Binding StreamRiskScoreDisplay}" FontSize="18" FontWeight="Bold" Foreground="{Binding SecurityRiskColor}"/>
                                                            <TextBlock Text="/100" FontSize="11" Foreground="#6E7681" VerticalAlignment="Bottom" Margin="0,0,0,2"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Encryption Status -->
                                                <Border Grid.Row="0" Grid.Column="1" Background="#0D1117" CornerRadius="6" Padding="10">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="ENCRYPTION" FontSize="10" FontWeight="SemiBold" Foreground="#6E7681"/>
                                                        <TextBlock Text="{Binding EncryptionStatus}" FontSize="12" FontWeight="SemiBold" Foreground="{Binding EncryptionStatusColor}"/>
                                                        <TextBlock Text="{Binding EncryptionProtocol}" FontSize="10" Foreground="#8B949E"
                                                                   IsVisible="{Binding EncryptionProtocol.Length}"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Beaconing Detection -->
                                                <Border Grid.Row="1" Grid.Column="0" Background="#0D1117" CornerRadius="6" Padding="10">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="BEACONING" FontSize="10" FontWeight="SemiBold" Foreground="#6E7681"/>
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <TextBlock Text="{Binding BeaconingInterval}" FontSize="12" FontWeight="SemiBold" Foreground="{Binding BeaconingColor}"/>
                                                            <TextBlock Text="{Binding BeaconingConfidence}" FontSize="10" Foreground="#8B949E" VerticalAlignment="Bottom"
                                                                       IsVisible="{Binding BeaconingDetected}"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Data Transfer Ratio -->
                                                <Border Grid.Row="1" Grid.Column="1" Background="#0D1117" CornerRadius="6" Padding="10">
                                                    <StackPanel Spacing="4">
                                                        <TextBlock Text="UPLOAD/DOWNLOAD" FontSize="10" FontWeight="SemiBold" Foreground="#6E7681"/>
                                                        <TextBlock Text="{Binding UploadDownloadRatio}" FontSize="12" FontWeight="SemiBold" Foreground="{Binding ExfiltrationColor}"/>
                                                        <TextBlock Text="âš  Exfiltration indicator" FontSize="10" Foreground="#FFA726"
                                                                   IsVisible="{Binding DataExfiltrationIndicator}"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>

                                            <!-- Port and Location Info -->
                                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="180,*">
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Source Port:" FontSize="11" Foreground="#6E7681"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SourcePortSecurity}" FontSize="11" Foreground="#C9D1D9"/>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Destination Port:" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding DestinationPortSecurity}" FontSize="11" Foreground="#C9D1D9" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Source Location:" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SourceGeoInfo}" FontSize="11" Foreground="#C9D1D9" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Destination Location:" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding DestinationGeoInfo}" FontSize="11" Foreground="#C9D1D9" Margin="0,6,0,0"/>
                                            </Grid>

                                            <!-- Security Warnings -->
                                            <ItemsControl ItemsSource="{Binding SecurityWarnings}"
                                                          IsVisible="{Binding HasSecurityWarnings}"
                                                          Margin="0,8,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="#1C1917"
                                                                BorderBrush="#78350F"
                                                                BorderThickness="1"
                                                                CornerRadius="4"
                                                                Padding="8,4"
                                                                Margin="0,2">
                                                            <TextBlock Text="{Binding}"
                                                                       FontSize="11"
                                                                       Foreground="#FCD34D"
                                                                       TextWrapping="Wrap"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>

                                    <!-- Traffic Direction -->
                                    <Border Classes="modern-card-unified" Padding="16" Background="#161B22">
                                        <StackPanel Spacing="12">
                                            <TextBlock Text="â†”ï¸ Traffic Direction"
                                                       FontSize="13"
                                                       FontWeight="SemiBold"
                                                       Foreground="#F0F6FC"
                                                       Margin="0,0,0,8"/>

                                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="180,*">
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Client (Initiator):" FontSize="11" Foreground="#6E7681"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ClientTraffic}"
                                                           FontSize="11" FontFamily="Consolas, monospace" Foreground="#22C55E"/>

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Server (Responder):" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ServerTraffic}"
                                                           FontSize="11" FontFamily="Consolas, monospace" Foreground="#3B82F6" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Dominant Direction:" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TrafficDirection}" FontSize="11" Foreground="#C9D1D9" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Stream Position:" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding StreamPosition}"
                                                           FontSize="11" FontWeight="SemiBold" Foreground="#8B5CF6" Margin="0,6,0,0"/>

                                                <TextBlock Grid.Row="4" Grid.Column="0" Text="Connection Age:" FontSize="11" Foreground="#6E7681" Margin="0,6,0,0"/>
                                                <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding ConnectionAge}" FontSize="11" Foreground="#C9D1D9" Margin="0,6,0,0"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </TabItem>

            </TabControl>
        </Grid>
    </Border>
</UserControl>
