<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="PCAPAnalyzer.UI.Views.Controls.FilterPanelControl">

    <Border Classes="modern-card-unified" Padding="20,16" Margin="0,0,0,20" BorderThickness="2" BorderBrush="#30363D">
        <StackPanel Spacing="16">

            <!-- INCLUDE FILTERS Section -->
            <Border Background="#0A1628" BorderBrush="#3B82F6" BorderThickness="2"
                    CornerRadius="8" Padding="16,14">
                <Grid RowDefinitions="Auto,14,Auto">
                    <!-- Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="INCLUDE FILTERS" FontSize="13" FontWeight="Bold" Foreground="#3B82F6" VerticalAlignment="Center"/>
                        <Border Background="#1C2128" BorderBrush="#3B82F6" BorderThickness="1"
                                CornerRadius="4" Padding="6,2" VerticalAlignment="Center"
                                ToolTip.Tip="Show packets matching these criteria. Use comma for OR (80,443 = port 80 OR 443). Different fields use AND logic.">
                            <TextBlock Text="â„¹ï¸ Different fields = AND â€¢ Same field values = OR" FontSize="9" Foreground="#58A6FF"/>
                        </Border>
                    </StackPanel>

                    <!-- Filter Inputs -->
                    <Grid Grid.Row="2" ColumnDefinitions="180,12,180,12,140,12,160">
                        <!-- Source IP -->
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="Source IP" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding SourceIPFilter}" Watermark="e.g. 192.168.1.1,10.0.0.1" FontSize="12" KeyDown="FilterTextBox_KeyDown"
                                     BorderBrush="{Binding SourceIPFilter, Converter={StaticResource IPValidationConverter}}"
                                     ToolTip.Tip="Enter IP, comma-separated IPs, CIDR (192.168.0.0/24), or wildcard (192.168.*.*)"/>
                        </StackPanel>

                        <!-- Destination IP -->
                        <StackPanel Grid.Column="2" Spacing="6">
                            <TextBlock Text="Destination IP" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding DestinationIPFilter}" Watermark="e.g. 10.0.0.1" FontSize="12" KeyDown="FilterTextBox_KeyDown"
                                     BorderBrush="{Binding DestinationIPFilter, Converter={StaticResource IPValidationConverter}}"
                                     ToolTip.Tip="Enter IP, comma-separated IPs, CIDR (10.0.0.0/8), or wildcard (10.*.*.*)"/>
                        </StackPanel>

                        <!-- Port Range -->
                        <StackPanel Grid.Column="4" Spacing="6">
                            <TextBlock Text="Port Range" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding PortRangeFilter}" Watermark="e.g. 80,443,137-139" FontSize="12" KeyDown="FilterTextBox_KeyDown"
                                     BorderBrush="{Binding PortRangeFilter, Converter={StaticResource PortValidationConverter}}"
                                     ToolTip.Tip="Enter port, comma-separated ports, or range (8000-8100)"/>
                        </StackPanel>

                        <!-- Protocol Type -->
                        <StackPanel Grid.Column="6" Spacing="6">
                            <TextBlock Text="Protocol Type (L4 / L7)" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding ProtocolFilter}" Watermark="e.g. TCP, HTTP" FontSize="12" KeyDown="FilterTextBox_KeyDown"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>

            <!-- EXCLUDE FILTERS Section -->
            <Border Background="#1A0A0A" BorderBrush="#EF4444" BorderThickness="2"
                    CornerRadius="8" Padding="16,14">
                <Grid RowDefinitions="Auto,14,Auto">
                    <!-- Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="EXCLUDE FILTERS (NOT)" FontSize="13" FontWeight="Bold" Foreground="#EF4444" VerticalAlignment="Center"/>
                        <Border Background="#1C2128" BorderBrush="#EF4444" BorderThickness="1"
                                CornerRadius="4" Padding="6,2" VerticalAlignment="Center"
                                ToolTip.Tip="Always takes precedence. Removes packets even if they match INCLUDE filters. Use comma for OR (22,23 = exclude SSH OR Telnet).">
                            <TextBlock Text="â„¹ï¸ Always takes precedence" FontSize="9" Foreground="#F87171"/>
                        </Border>
                    </StackPanel>

                    <!-- NOT Filter Inputs -->
                    <Grid Grid.Row="2" ColumnDefinitions="180,12,180,12,140,12,160">
                        <!-- NOT Source IP -->
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="NOT Source IP" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding NotSourceIPFilter}" Watermark="e.g. 192.168.1.0/24" FontSize="12" KeyDown="FilterTextBox_KeyDown"
                                     BorderBrush="{Binding NotSourceIPFilter, Converter={StaticResource IPValidationConverter}}"
                                     ToolTip.Tip="Exclude IP, comma-separated IPs, CIDR, or wildcard"/>
                        </StackPanel>

                        <!-- NOT Destination IP -->
                        <StackPanel Grid.Column="2" Spacing="6">
                            <TextBlock Text="NOT Destination IP" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding NotDestinationIPFilter}" Watermark="e.g. 10.0.0.0/8" FontSize="12" KeyDown="FilterTextBox_KeyDown"
                                     BorderBrush="{Binding NotDestinationIPFilter, Converter={StaticResource IPValidationConverter}}"
                                     ToolTip.Tip="Exclude IP, comma-separated IPs, CIDR, or wildcard"/>
                        </StackPanel>

                        <!-- NOT Port Range -->
                        <StackPanel Grid.Column="4" Spacing="6">
                            <TextBlock Text="NOT Port Range" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding NotPortRangeFilter}" Watermark="e.g. 137-139" FontSize="12" KeyDown="FilterTextBox_KeyDown"
                                     BorderBrush="{Binding NotPortRangeFilter, Converter={StaticResource PortValidationConverter}}"
                                     ToolTip.Tip="Exclude port, comma-separated ports, or range"/>
                        </StackPanel>

                        <!-- NOT Protocol Type -->
                        <StackPanel Grid.Column="6" Spacing="6">
                            <TextBlock Text="NOT Protocol Type (L4 / L7)" FontSize="11" FontWeight="SemiBold" Foreground="#8B949E"/>
                            <TextBox Text="{Binding NotProtocolFilter}" Watermark="e.g. ICMP" FontSize="12" KeyDown="FilterTextBox_KeyDown"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>

            <!-- Action Buttons -->
            <Grid ColumnDefinitions="*,12,Auto,12,Auto,12,Auto">
                <Button Grid.Column="2" Command="{Binding ApplyFiltersCommand}"
                        IsEnabled="{Binding Statistics.CanApplyFilters}"
                        Classes="primary-action" Height="32" Padding="20,0"
                        HotKey="Ctrl+Enter" ToolTip.Tip="Apply Filters (Ctrl+Enter)">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="âš¡" FontSize="14"/>
                        <TextBlock Text="Apply" FontSize="12" FontWeight="SemiBold"/>
                    </StackPanel>
                </Button>
                <Button Grid.Column="4" Command="{Binding ClearFiltersCommand}"
                        Classes="secondary-action" Height="32" Padding="16,0"
                        HotKey="Ctrl+Shift+R" ToolTip.Tip="Clear All Filters">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”„" FontSize="13"/>
                        <TextBlock Text="Clear" FontSize="12"/>
                    </StackPanel>
                </Button>
                <Button Grid.Column="6" Classes="secondary-action" Height="32"
                        Padding="16,0" x:Name="PacketCopyFiltersButton">
                    <Button.Flyout>
                        <MenuFlyout Placement="Bottom">
                            <MenuItem Header="ðŸ“‹ Copy to Dashboard" Command="{Binding CopyFiltersToDashboardCommand}"/>
                            <MenuItem Header="ðŸ“‹ Copy to Security Threats" Command="{Binding CopyFiltersToThreatsCommand}"/>
                            <MenuItem Header="ðŸ“‹ Copy to Voice/QoS" Command="{Binding CopyFiltersToVoiceQoSCommand}"/>
                            <MenuItem Header="ðŸ“‹ Copy to Country Traffic" Command="{Binding CopyFiltersToCountryTrafficCommand}"/>
                        </MenuFlyout>
                    </Button.Flyout>
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ“‹" FontSize="13"/>
                        <TextBlock Text="Copy" FontSize="12"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Stream Filter Active Banner -->
            <Border Background="#1A1A0A" BorderBrush="#F59E0B" BorderThickness="2"
                    CornerRadius="6" Padding="12,10" IsVisible="{Binding PacketManager.HasStreamFilter}"
                    BoxShadow="0 0 12 #F59E0B60">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸ”—" FontSize="14"/>
                        <TextBlock Text="STREAM FILTER ACTIVE" FontSize="12" FontWeight="Bold" Foreground="#F59E0B" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="{Binding UIState.StreamSearchStatus}" FontSize="11" Foreground="#FCD34D"
                               VerticalAlignment="Center" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                    <Button Grid.Column="2" Command="{Binding ClearStreamSearchCommand}"
                            Background="#0D1117" BorderBrush="#EF4444" BorderThickness="1"
                            Padding="8,4" CornerRadius="4" ToolTip.Tip="Clear stream filter">
                        <TextBlock Text="âœ• Clear" FontSize="10" Foreground="#EF4444"/>
                    </Button>
                </Grid>
            </Border>

            <!-- Active INCLUDE Filter Groups (AND groups) -->
            <Border Background="#0D1117" BorderBrush="#3B82F6" BorderThickness="2"
                    CornerRadius="6" Padding="12,8" IsVisible="{Binding IncludeFilterGroups.Count}"
                    BoxShadow="0 0 12 #3B82F660">
                <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="âœ…" FontSize="11"/>
                        <TextBlock Text="ACTIVE Filter Groups (OR logic between groups):" FontSize="11" FontWeight="Bold" Foreground="#3FB950"/>
                    </StackPanel>
                    <ItemsControl ItemsSource="{Binding IncludeFilterGroups}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#1C2128" BorderBrush="#3FB950" BorderThickness="2"
                                        CornerRadius="8" Padding="10,6" Margin="0,0,8,8"
                                        BoxShadow="0 0 10 #3FB95060">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ”¹ ACTIVE GROUP" FontSize="9" FontWeight="Bold" Foreground="#3FB950" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DisplayLabel}" FontSize="10" Foreground="#C9D1D9" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        <Button Command="{Binding RemoveCommand}"
                                                Background="#0D1117" BorderBrush="#EF4444" BorderThickness="1"
                                                Padding="6,2" CornerRadius="4"
                                                ToolTip.Tip="Remove this group">
                                            <TextBlock Text="âœ•" Foreground="#EF4444" FontSize="10" FontWeight="Bold"/>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Active INCLUDE Individual Chips (OR chips) -->
            <Border Background="#0D1117" BorderBrush="#3B82F6" BorderThickness="2"
                    CornerRadius="6" Padding="12,8" IsVisible="{Binding IncludeIndividualChips.Count}"
                    BoxShadow="0 0 12 #3B82F660">
                <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="âœ…" FontSize="11"/>
                        <TextBlock Text="ACTIVE Individual Filters (OR logic):" FontSize="11" FontWeight="Bold" Foreground="#3FB950"/>
                    </StackPanel>
                    <ItemsControl ItemsSource="{Binding IncludeIndividualChips}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#1C2128" BorderBrush="#3FB950" BorderThickness="2"
                                        CornerRadius="12" Padding="8,4" Margin="0,0,6,6"
                                        BoxShadow="0 0 8 #3FB95040">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="{Binding DisplayLabel}" FontSize="10" Foreground="#C9D1D9" FontWeight="SemiBold"/>
                                        <Button Command="{Binding RemoveCommand}"
                                                Background="Transparent" BorderThickness="0"
                                                Padding="4,0" Height="16" Width="16"
                                                ToolTip.Tip="Remove this filter">
                                            <TextBlock Text="âœ•" Foreground="#EF4444" FontSize="10" FontWeight="Bold"/>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Active EXCLUDE Filter Groups (NOT groups) -->
            <Border Background="#0D1117" BorderBrush="#EF4444" BorderThickness="2"
                    CornerRadius="6" Padding="12,8" IsVisible="{Binding ExcludeFilterGroups.Count}"
                    BoxShadow="0 0 12 #EF444460">
                <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸš«" FontSize="11"/>
                        <TextBlock Text="ACTIVE Exclusion Groups (NOT):" FontSize="11" FontWeight="Bold" Foreground="#EF4444"/>
                    </StackPanel>
                    <ItemsControl ItemsSource="{Binding ExcludeFilterGroups}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#1C2128" BorderBrush="#EF4444" BorderThickness="2"
                                        CornerRadius="8" Padding="10,6" Margin="0,0,8,8"
                                        BoxShadow="0 0 10 #EF444460">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ”¹ ACTIVE NOT GROUP" FontSize="9" FontWeight="Bold" Foreground="#F87171" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DisplayLabel}" FontSize="10" Foreground="#C9D1D9" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        <Button Command="{Binding RemoveCommand}"
                                                Background="#0D1117" BorderBrush="#EF4444" BorderThickness="1"
                                                Padding="6,2" CornerRadius="4"
                                                ToolTip.Tip="Remove this NOT group">
                                            <TextBlock Text="âœ•" Foreground="#EF4444" FontSize="10" FontWeight="Bold"/>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Active EXCLUDE Individual Chips -->
            <Border Background="#0D1117" BorderBrush="#EF4444" BorderThickness="2"
                    CornerRadius="6" Padding="12,8" IsVisible="{Binding ExcludeIndividualChips.Count}"
                    BoxShadow="0 0 12 #EF444460">
                <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸš«" FontSize="11"/>
                        <TextBlock Text="ACTIVE Individual Exclusions (NOT):" FontSize="11" FontWeight="Bold" Foreground="#EF4444"/>
                    </StackPanel>
                    <ItemsControl ItemsSource="{Binding ExcludeIndividualChips}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#1C2128" BorderBrush="#EF4444" BorderThickness="2"
                                        CornerRadius="12" Padding="8,4" Margin="0,0,6,6"
                                        BoxShadow="0 0 8 #EF444440">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="{Binding DisplayLabel}" FontSize="10" Foreground="#C9D1D9" FontWeight="SemiBold"/>
                                        <Button Command="{Binding RemoveCommand}"
                                                Background="Transparent" BorderThickness="0"
                                                Padding="4,0" Height="16" Width="16"
                                                ToolTip.Tip="Remove this exclusion">
                                            <TextBlock Text="âœ•" Foreground="#EF4444" FontSize="10" FontWeight="Bold"/>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

        </StackPanel>
    </Border>
</UserControl>
