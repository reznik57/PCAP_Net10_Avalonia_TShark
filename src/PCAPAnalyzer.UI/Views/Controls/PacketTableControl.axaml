<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="using:PCAPAnalyzer.UI.Views.Controls"
             xmlns:converters="using:PCAPAnalyzer.UI.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="PCAPAnalyzer.UI.Views.Controls.PacketTableControl">

    <UserControl.Resources>
        <converters:SimpleProtocolToColorConverter x:Key="ProtocolColorConverter"/>
        <converters:StreamHighlightConverter x:Key="StreamHighlightConverter"/>
        <converters:SelectedPacketConverter x:Key="SelectedPacketConverter"/>
        <converters:TimeDeltaConverter x:Key="TimeDeltaConverter"/>
        <converters:BookmarkVisibilityConverter x:Key="BookmarkVisibilityConverter"/>
        <converters:PortToServiceWithRiskConverter x:Key="PortToServiceConverter"/>
        <converters:PortRiskToColorConverter x:Key="PortRiskColorConverter"/>
        <converters:PortToTooltipConverter x:Key="PortTooltipConverter"/>
    </UserControl.Resources>

    <!-- Split-Pane Layout: Top = Packet Table, Bottom = Packet Details Panel -->
    <!-- Auto = Details panel auto-sizes to fit content, * = Packet table takes remaining space -->
    <Grid RowDefinitions="*,8,Auto">

        <!-- Top Pane: Packet Table -->
        <Border Grid.Row="0" Classes="modern-card-unified" Margin="0,0,0,0" MinHeight="300" Padding="0">
        <Grid RowDefinitions="Auto,Auto,Auto,*">
            <Border Grid.Row="0" Classes="table-header-unified">
                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <Border Classes="accent-bar" Background="#3B82F6"/>
                        <TextBlock Text="Packet Analysis" Classes="section-title-unified" Margin="0"/>
                        <Border Classes="badge-unified">
                            <TextBlock Text="{Binding TotalFilteredPackets, StringFormat='{}{0:N0}'}" Foreground="#3B82F6"/>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Pagination Controls -->
            <Border Grid.Row="1" Classes="pagination-controls">
                <Grid ColumnDefinitions="*,Auto,*">
                    <!-- Left side: Empty spacer -->
                    <Border Grid.Column="0"/>

                    <!-- Center: Page info + Go To navigation -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                        <TextBlock VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextSecondary}">
                            <Run Text="Page"/><Run Text="{Binding CurrentPage}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/><Run Text="of"/><Run Text="{Binding TotalPages}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/>
                            <Run Text="(30 per page)" FontSize="10" Foreground="{DynamicResource TextMuted}"/>
                        </TextBlock>

                        <!-- Go To Packet input -->
                        <Border Background="#161B22" BorderBrush="#30363D" BorderThickness="1" CornerRadius="6" Padding="8,4">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Frame:" FontSize="11" Foreground="#8B5CF6" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                <TextBox Width="80" Height="26" FontSize="11"
                                         Text="{Binding UIState.GoToPacketText}"
                                         Watermark="#"
                                         Background="#0D1117" BorderBrush="#8B5CF6" BorderThickness="1" Foreground="#C9D1D9"
                                         VerticalContentAlignment="Center" Padding="6,0"
                                         KeyDown="GoToPacketTextBox_KeyDown"/>
                                <Button Content="Go" Command="{Binding UIState.GoToPacketCommand}"
                                        FontSize="11" Padding="8,4" MinWidth="35" Classes="secondary-action"
                                        Background="#8B5CF6" Foreground="White"
                                        ToolTip.Tip="Jump to specific packet by frame number"/>
                            </StackPanel>
                        </Border>

                        <!-- Search Stream input -->
                        <Border Background="#161B22" BorderBrush="#30363D" BorderThickness="1" CornerRadius="6" Padding="8,4">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Stream:" FontSize="11" Foreground="#22C55E" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                <TextBox Width="140" Height="26" FontSize="11"
                                         Text="{Binding UIState.SearchStreamText}"
                                         Watermark="IP or IP:Port"
                                         Background="#0D1117" BorderBrush="#22C55E" BorderThickness="1" Foreground="#C9D1D9"
                                         VerticalContentAlignment="Center" Padding="6,0"
                                         KeyDown="SearchStreamTextBox_KeyDown"
                                         ToolTip.Tip="Search: 192.168.1.1 or 192.168.1.1:443 or 10.0.0.1:80-192.168.1.1:443"/>
                                <Button Content="ðŸ”" Command="{Binding UIState.SearchStreamCommand}"
                                        FontSize="11" Padding="8,4" MinWidth="30"
                                        Background="#22C55E" Foreground="White"
                                        ToolTip.Tip="Search for packets in stream"/>
                                <Button Content="âœ•" Command="{Binding UIState.ClearStreamSearchCommand}"
                                        FontSize="11" Padding="8,4" MinWidth="30"
                                        IsVisible="{Binding PacketManager.HasStreamFilter}"
                                        Background="#EF4444" Foreground="White"
                                        ToolTip.Tip="Clear stream filter"/>
                                <TextBlock Text="{Binding UIState.StreamSearchStatus}"
                                           FontSize="10" Foreground="#22C55E" VerticalAlignment="Center"
                                           IsVisible="{Binding PacketManager.HasStreamFilter}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Right: Navigation buttons -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Right">
                        <Button Content="â® First" FontSize="11" Padding="8,4" MinWidth="55" Classes="secondary-action" Command="{Binding GoToFirstPageCommand}" ToolTip.Tip="Go to first page"/>
                        <Button Content="â—€ Prev" FontSize="11" Padding="8,4" MinWidth="55" Classes="secondary-action" Command="{Binding GoToPreviousPageCommand}" ToolTip.Tip="Previous page"/>
                        <Button Content="Next â–¶" FontSize="11" Padding="8,4" MinWidth="55" Classes="secondary-action" Command="{Binding GoToNextPageCommand}" ToolTip.Tip="Next page"/>
                        <Button Content="Last â­" FontSize="11" Padding="8,4" MinWidth="55" Classes="secondary-action" Command="{Binding GoToLastPageCommand}" ToolTip.Tip="Go to last page"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Column Headers -->
            <Border Grid.Row="2" Background="#0D1117" BorderBrush="#21262D" BorderThickness="0,0,0,1" Padding="20,8,20,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="110"/>  <!-- Frame Number -->
                        <ColumnDefinition Width="110"/>  <!-- Timestamp -->
                        <ColumnDefinition Width="75"/>   <!-- Delta Time -->
                        <ColumnDefinition Width="140"/>  <!-- Source IP -->
                        <ColumnDefinition Width="70"/>   <!-- Src Port -->
                        <ColumnDefinition Width="140"/>  <!-- Dest IP -->
                        <ColumnDefinition Width="70"/>   <!-- Dst Port -->
                        <ColumnDefinition Width="80"/>   <!-- L4 Protocol -->
                        <ColumnDefinition Width="100"/>  <!-- L7 Protocol -->
                        <ColumnDefinition Width="70"/>   <!-- Length -->
                        <ColumnDefinition Width="*"/>    <!-- Info -->
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="FRAME #" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="TIME" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="2" Text="DELTA" FontSize="10" FontWeight="SemiBold" Foreground="#22C55E" HorizontalAlignment="Left" VerticalAlignment="Center" ToolTip.Tip="Time since first packet in filter"/>
                    <TextBlock Grid.Column="3" Text="SOURCE IP" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="4" Text="SRC PORT" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="5" Text="DESTINATION IP" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="6" Text="DST PORT" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="7" Text="L4 PROTO" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="8" Text="SERVICE" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center" ToolTip.Tip="Service detected via L7 protocol or port number (hover for details)"/>
                    <TextBlock Grid.Column="9" Text="SIZE" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="10" Text="INFO" FontSize="10" FontWeight="SemiBold" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                </Grid>
            </Border>

            <!-- Packet List (ItemsControl) with keyboard navigation -->
            <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" MaxHeight="600"
                          Focusable="True" x:Name="PacketScrollViewer" KeyDown="PacketList_KeyDown">
                <ItemsControl ItemsSource="{Binding Packets}" Margin="0,8,0,8">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Classes="ranked-table-row" PointerPressed="PacketRow_PointerPressed" Cursor="Hand">
                                <!-- Stream Highlight Background -->
                                <Border.Background>
                                    <MultiBinding Converter="{StaticResource StreamHighlightConverter}">
                                        <Binding Path="."/>
                                        <Binding Path="DataContext.PacketManager.SelectedStreamKey" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                    </MultiBinding>
                                </Border.Background>
                                <!-- Right-click Context Menu -->
                                <Border.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="â­ Toggle Bookmark" Click="ToggleBookmark_Click"/>
                                        <Separator/>
                                        <MenuItem Header="ðŸ“‹ Copy Row Summary" Click="CopyRowSummary_Click"/>
                                        <MenuItem Header="ðŸ“ Copy Source IP" Click="CopySourceIP_Click"/>
                                        <MenuItem Header="ðŸ“ Copy Destination IP" Click="CopyDestIP_Click"/>
                                        <MenuItem Header="ðŸ”— Copy Conversation" Click="CopyConversation_Click"/>
                                        <MenuItem Header="ðŸ“Œ Copy Frame Number" Click="CopyFrameNumber_Click"/>
                                        <Separator/>
                                        <MenuItem Header="ðŸ” Filter by Stream" Click="FilterByStream_Click"/>
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <Grid ColumnDefinitions="4,*">
                                    <!-- Protocol Color Accent Bar -->
                                    <Border Grid.Column="0"
                                            Background="{Binding Protocol, Converter={StaticResource ProtocolColorConverter}}"
                                            CornerRadius="2,0,0,2"
                                            Margin="0,2,0,2"/>

                                    <!-- Packet Data Columns -->
                                    <Grid Grid.Column="1" Margin="8,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="106"/>  <!-- Frame Number -->
                                            <ColumnDefinition Width="110"/>  <!-- Timestamp -->
                                            <ColumnDefinition Width="75"/>   <!-- Delta Time -->
                                            <ColumnDefinition Width="140"/>  <!-- Source IP -->
                                            <ColumnDefinition Width="70"/>   <!-- Src Port -->
                                            <ColumnDefinition Width="140"/>  <!-- Dest IP -->
                                            <ColumnDefinition Width="70"/>   <!-- Dst Port -->
                                            <ColumnDefinition Width="80"/>   <!-- L4 Protocol -->
                                            <ColumnDefinition Width="100"/>  <!-- L7 Protocol -->
                                            <ColumnDefinition Width="70"/>   <!-- Length -->
                                            <ColumnDefinition Width="*"/>    <!-- Info -->
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                            <TextBlock Text="â­" FontSize="10" Foreground="#FCD34D">
                                                <TextBlock.IsVisible>
                                                    <MultiBinding Converter="{StaticResource BookmarkVisibilityConverter}">
                                                        <Binding Path="FrameNumber"/>
                                                        <Binding Path="DataContext.PacketManager.BookmarkedFrames" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                    </MultiBinding>
                                                </TextBlock.IsVisible>
                                            </TextBlock>
                                            <TextBlock Text="{Binding FrameNumber, StringFormat='{}{0:N0}'}" FontSize="11" FontWeight="Medium" Foreground="#8B949E"/>
                                        </StackPanel>
                                        <TextBlock Grid.Column="1" Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss.fff}'}" FontSize="12" Foreground="#C9D1D9" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        <!-- Delta Time Column (relative to first packet in dataset) -->
                                        <TextBlock Grid.Column="2" FontSize="11" Foreground="#22C55E" HorizontalAlignment="Left" VerticalAlignment="Center">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource TimeDeltaConverter}">
                                                    <Binding Path="Timestamp"/>
                                                    <Binding Path="DataContext.PacketManager.FirstPacketTimestamp" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                        <TextBlock Grid.Column="3" Text="{Binding SourceIP}" FontSize="13" FontWeight="SemiBold" Foreground="#F0F6FC" TextTrimming="CharacterEllipsis" HorizontalAlignment="Left" VerticalAlignment="Center" ToolTip.Tip="{Binding SourceIP}"/>
                                        <TextBlock Grid.Column="4" Text="{Binding SourcePort}" FontSize="12" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="5" Text="{Binding DestinationIP}" FontSize="13" FontWeight="SemiBold" Foreground="#F0F6FC" TextTrimming="CharacterEllipsis" HorizontalAlignment="Left" VerticalAlignment="Center" ToolTip.Tip="{Binding DestinationIP}"/>
                                        <TextBlock Grid.Column="6" Text="{Binding DestinationPort}" FontSize="12" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        <!-- Protocol column with color -->
                                        <TextBlock Grid.Column="7" Text="{Binding Protocol}" FontSize="11" FontWeight="SemiBold"
                                                   Foreground="{Binding Protocol, Converter={StaticResource ProtocolColorConverter}}"
                                                   HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        <!-- L7/Service column - uses PortDatabase for service name when L7 not detected -->
                                        <TextBlock Grid.Column="8"
                                                   Text="{Binding ., Converter={StaticResource PortToServiceConverter}}"
                                                   FontSize="11"
                                                   Foreground="{Binding ., Converter={StaticResource PortRiskColorConverter}}"
                                                   FontWeight="SemiBold"
                                                   TextTrimming="CharacterEllipsis"
                                                   HorizontalAlignment="Left"
                                                   VerticalAlignment="Center"
                                                   ToolTip.Tip="{Binding ., Converter={StaticResource PortTooltipConverter}}"/>
                                        <TextBlock Grid.Column="9" Text="{Binding Length, StringFormat='{}{0:N0}'}" FontSize="12" Foreground="#8B949E" HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="10" Text="{Binding Info}" FontSize="11" Foreground="#C9D1D9" TextTrimming="CharacterEllipsis" HorizontalAlignment="Left" VerticalAlignment="Center" ToolTip.Tip="{Binding Info}"/>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
    </Border>

    <!-- Grid Splitter for resizing (drag to resize packet table vs details) -->
    <GridSplitter Grid.Row="1"
                  Background="#8B5CF6"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  ResizeDirection="Rows"
                  Cursor="SizeNorthSouth"
                  MinHeight="8">
        <!-- Visual grip indicator -->
        <GridSplitter.Template>
            <ControlTemplate>
                <Border Background="#30363D" CornerRadius="2">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="3">
                        <Ellipse Width="4" Height="4" Fill="#8B949E"/>
                        <Ellipse Width="4" Height="4" Fill="#8B949E"/>
                        <Ellipse Width="4" Height="4" Fill="#8B949E"/>
                    </StackPanel>
                </Border>
            </ControlTemplate>
        </GridSplitter.Template>
    </GridSplitter>

    <!-- Bottom Pane: Packet Details Panel -->
    <controls:PacketDetailsPanel Grid.Row="2"
                                 x:Name="PacketDetailsPanel"
                                 DataContext="{Binding PacketManager.PacketDetails}"/>

    </Grid>
</UserControl>
