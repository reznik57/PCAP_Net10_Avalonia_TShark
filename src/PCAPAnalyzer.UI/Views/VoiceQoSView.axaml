<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             xmlns:converters="using:PCAPAnalyzer.UI.Converters"
             xmlns:ctrl="using:PCAPAnalyzer.UI.Views.Controls"
             x:Class="PCAPAnalyzer.UI.Views.VoiceQoSView"
             x:DataType="vm:VoiceQoSViewModel"
             Background="{DynamicResource BackgroundDarkest}">

    <UserControl.Resources>
        <converters:TrafficIntensityGradientConverter x:Key="TrafficIntensityGradientConverter"/>
        <converters:PercentageToWidthConverter x:Key="PercentageToWidthConverter"/>

        <!-- Reusable Endpoint Row Template (used by 6 sections) -->
        <DataTemplate x:Key="EndpointRowTemplate">
            <Border Classes="ranked-table-row">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="30"/>
                        <ColumnDefinition Width="140"/>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="100"/>
                        <ColumnDefinition Width="60"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="{Binding Rank}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextMutedBrush}" TextAlignment="Right" Margin="0,0,8,0"/>
                    <TextBlock Grid.Column="1" Text="{Binding IPAddress}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding IPAddress}"/>
                    <Border Grid.Column="2" Classes="service-badge"><TextBlock Text="{Binding Badge}" FontSize="{DynamicResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>

                    <Grid Grid.Column="3" Margin="8,0">
                        <Border Classes="percentage-track">
                            <Grid>
                                <Border Background="{Binding Percentage, Converter={StaticResource TrafficIntensityGradientConverter}}" CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Percentage, Converter={StaticResource PercentageToWidthConverter}, ConverterParameter=130}"/>
                                <TextBlock Text="{Binding Percentage, StringFormat='{}{0:F1}%'}" Classes="percentage-text"/>
                            </Grid>
                        </Border>
                    </Grid>

                    <TextBlock Grid.Column="4" Text="{Binding PacketCount, StringFormat='{}{0:N0} pkts'}" FontSize="{DynamicResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{Binding DataContext.EndpointColor, RelativeSource={RelativeSource AncestorType=Border}}" HorizontalAlignment="Right"/>
                    <Button Grid.Column="5" Command="{Binding $parent[UserControl].DataContext.ShowTopEndpointDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <!-- SLACK STYLE -->
    <UserControl.Styles>
        <!-- Export Button Style - SLACK STYLE -->
        <Style Selector="Button.export-csv">
            <Setter Property="Background" Value="{DynamicResource AccentPrimary}"/>
            <Setter Property="BorderBrush" Value="{StaticResource ColorPrimaryHover}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style Selector="ScrollViewer.fixed-height-table">
            <Setter Property="Height" Value="440"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
        </Style>

        <!-- Pagination Controls Template -->
        <Style Selector="Border.pagination-controls">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
            <Setter Property="BorderThickness" Value="0,1,0,0"/>
            <Setter Property="Padding" Value="20,12"/>
        </Style>
    </UserControl.Styles>

    <Panel>
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <Grid Margin="24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- UnifiedFilterPanelControl with VoiceQoS tab auto-selected (index 2) -->
            <ctrl:UnifiedFilterPanelControl Grid.Row="0" DefaultTabIndex="2" Margin="0,0,0,10" />

            <!-- Quality Statistics - Using unified StatsBarControl -->
            <ctrl:StatsBarControl Grid.Row="2" DataContext="{Binding VoiceQoSStatsBar}" Margin="0,0,0,20"/>

            <!-- Timeline Chart Section -->
            <Border Grid.Row="3" Classes="modern-card-unified" Padding="24" Margin="0,0,0,24">
                <StackPanel Spacing="16">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                            <TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeXL}" VerticalAlignment="Center"/>
                            <TextBlock Text="QoS Metrics Timeline" FontSize="{DynamicResource FontSizeXL}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}" VerticalAlignment="Center"/>
                            <Border Classes="badge badge-purple" VerticalAlignment="Center" Margin="8,0,0,0"><TextBlock Text="{Binding ChartsViewModel.TimeRange}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                        </StackPanel>
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                            <CheckBox Content="QoS" IsChecked="{Binding ChartsViewModel.ShowQoSPackets}" Foreground="{DynamicResource SlackSuccess}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <Separator Width="1" Height="16" Background="{DynamicResource BorderSubtleBrush}" Margin="4,0"/>
                            <CheckBox Content="Lat All" IsChecked="{Binding ChartsViewModel.ShowLatencyAll}" Foreground="{DynamicResource AccentPrimary}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Bold"/>
                            <CheckBox Content="Lat Min" IsChecked="{Binding ChartsViewModel.ShowLatencyMin}" Foreground="{DynamicResource SlackInfo}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Lat P5" IsChecked="{Binding ChartsViewModel.ShowLatencyP5}" Foreground="{StaticResource MetricLatencyP5}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Lat Avg" IsChecked="{Binding ChartsViewModel.ShowLatencyAvg}" Foreground="{StaticResource MetricLatencyAvg}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Lat P95" IsChecked="{Binding ChartsViewModel.ShowLatencyP95}" Foreground="{StaticResource MetricLatencyP95}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Lat Max" IsChecked="{Binding ChartsViewModel.ShowLatencyMax}" Foreground="{StaticResource MetricLatencyMax}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <Separator Width="1" Height="16" Background="{DynamicResource BorderSubtleBrush}" Margin="4,0"/>
                            <CheckBox Content="Jit All" IsChecked="{Binding ChartsViewModel.ShowJitterAll}" Foreground="{StaticResource MetricJitterAll}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Bold"/>
                            <CheckBox Content="Jit Min" IsChecked="{Binding ChartsViewModel.ShowJitterMin}" Foreground="{StaticResource MetricJitterMin}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Jit P5" IsChecked="{Binding ChartsViewModel.ShowJitterP5}" Foreground="{StaticResource MetricJitterP5}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Jit Avg" IsChecked="{Binding ChartsViewModel.ShowJitterAvg}" Foreground="{StaticResource MetricJitterAvg}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Jit P95" IsChecked="{Binding ChartsViewModel.ShowJitterP95}" Foreground="{StaticResource MetricJitterP95}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                            <CheckBox Content="Jit Max" IsChecked="{Binding ChartsViewModel.ShowJitterMax}" Foreground="{StaticResource MetricJitterMax}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium"/>
                        </StackPanel>
                    </Grid>
                    <lvc:CartesianChart Series="{Binding ChartsViewModel.TimelineSeries}" XAxes="{Binding ChartsViewModel.XAxes}" YAxes="{Binding ChartsViewModel.YAxes}" Height="320" Margin="20,20,20,10" ZoomMode="None" TooltipPosition="Hidden" AnimationsSpeed="00:00:00.5" Background="{DynamicResource BackgroundMedium}" PointerMoved="OnTimelineChartPointerMoved" PointerExited="OnTimelineChartPointerExited"/>
                    <!-- Hover Tooltip -->
                    <Border Background="{DynamicResource BackgroundMedium}" CornerRadius="6" Padding="12,8" Margin="20,4,20,0" HorizontalAlignment="Center">
                        <TextBlock x:Name="TimelineTooltipText" FontSize="{DynamicResource FontSizeInput}" Foreground="{DynamicResource TextPrimary}" TextWrapping="NoWrap" TextAlignment="Center"/>
                    </Border>
                </StackPanel>
            </Border>

            <!-- QoS Traffic Section -->
            <Border Grid.Row="4" Classes="modern-card-unified" Margin="0,0,0,20" MinHeight="300">
                <Grid RowDefinitions="Auto,*,Auto">
                    <Border Grid.Row="0" Classes="table-header-unified">
                        <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <Border Width="3" Height="20" Background="{DynamicResource SlackSuccess}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                <TextBlock Text="QoS-Marked Traffic" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <Border Classes="badge badge-blue" Margin="12,0,0,0"><TextBlock Text="{Binding QosTrafficTotalItems, StringFormat='{}{0:N0} total'}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                                <Border Classes="badge badge-gray" Margin="6,0,0,0"><TextBlock Text="{Binding QosTraffic.Count, StringFormat='Showing {0:N0}'}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                            </StackPanel>
                            <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export QoS traffic to CSV">
                                <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                            </Button>
                        </Grid>
                    </Border>

                    <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                        <ItemsControl ItemsSource="{Binding QosTraffic}" Margin="0,8,0,8">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Classes="ranked-table-row">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/><ColumnDefinition Width="140"/><ColumnDefinition Width="140"/><ColumnDefinition Width="80"/><ColumnDefinition Width="120"/><ColumnDefinition Width="90"/><ColumnDefinition Width="100"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="60"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding RowNumber}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium" Foreground="{DynamicResource TextMuted}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="{Binding SourceIP}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding SourceIP}"/>
                                            <TextBlock Grid.Column="2" Text="{Binding DestinationIP}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding DestinationIP}"/>
                                            <Border Grid.Column="3" Classes="service-badge"><TextBlock Text="{Binding Protocol}" FontSize="{DynamicResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                            <TextBlock Grid.Column="4" Text="{Binding QoSType}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource SlackSuccess}" FontWeight="Medium" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding QoSType}"/>
                                            <TextBlock Grid.Column="5" Text="{Binding DscpDisplay}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="6" Text="{Binding PacketCount, StringFormat='{}{0:N0}'}" FontSize="{DynamicResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource SlackSuccess}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="7" Text="{Binding BytesFormatted}" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="8" Text="{Binding Duration}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="9" Text="{Binding PortRange}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                            <Button Grid.Column="10" Command="{Binding $parent[UserControl].DataContext.ShowQoSDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <Border Grid.Row="2" Classes="pagination-controls">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <TextBlock Text="Per page:" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Button Content="30" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="40" Classes="secondary-action" Click="QosPageSize30_Click"/>
                                    <Button Content="100" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="40" Classes="secondary-action" Click="QosPageSize100_Click"/>
                                </StackPanel>
                            </StackPanel>
                            <TextBlock Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondary}">
                                <Run Text="Page"/><Run Text="{Binding QosTrafficCurrentPage}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/><Run Text="of"/><Run Text="{Binding QosTrafficTotalPages}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/>
                            </TextBlock>
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                                <Button Content="â® First" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="QosFirstPage_Click" ToolTip.Tip="Go to first page"/>
                                <Button Content="â—€â—€ -10" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="QosJumpBack10_Click" ToolTip.Tip="Jump back 10 pages"/>
                                <Button Content="â—€ Prev" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="QosPrevPage_Click" ToolTip.Tip="Previous page"/>
                                <Button Content="Next â–¶" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="QosNextPage_Click" ToolTip.Tip="Next page"/>
                                <Button Content="+10 â–¶â–¶" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="QosJumpForward10_Click" ToolTip.Tip="Jump forward 10 pages"/>
                                <Button Content="Last â­" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="QosLastPage_Click" ToolTip.Tip="Go to last page"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- Top QoS Endpoints (Sources + Destinations) -->
            <Grid Grid.Row="5" Margin="0,0,0,20" ColumnDefinitions="*,24,*">
                <Border Grid.Column="0" Classes="modern-card-unified">
                    <Border Classes="modern-card-inner">
                        <Grid RowDefinitions="Auto,*">
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Border Width="3" Height="20" Background="{DynamicResource SlackSuccess}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                        <TextBlock Text="Top QoS Sources" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export QoS sources to CSV">
                                        <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding StatisticsViewModel.TopQoSSourcesExtended}" Margin="0,8,0,8" ItemTemplate="{StaticResource EndpointRowTemplate}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Border>
                <Border Grid.Column="2" Classes="modern-card-unified">
                    <Border Classes="modern-card-inner">
                        <Grid RowDefinitions="Auto,*">
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Border Width="3" Height="20" Background="{DynamicResource SlackSuccess}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                        <TextBlock Text="Top QoS Destinations" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export QoS destinations to CSV">
                                        <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding StatisticsViewModel.TopQoSDestinationsExtended}" Margin="0,8,0,8" ItemTemplate="{StaticResource EndpointRowTemplate}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Border>
            </Grid>

            <!-- High Latency Section -->
            <Border Grid.Row="6" Classes="modern-card-unified" Margin="0,0,0,20" MinHeight="300">
                <Grid RowDefinitions="Auto,*,Auto">
                    <Border Grid.Row="0" Classes="table-header-unified">
                        <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <Border Width="3" Height="20" Background="{DynamicResource AccentPrimary}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                <TextBlock Text="High Latency Connections" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <Border Classes="badge badge-blue" Margin="12,0,0,0"><TextBlock Text="{Binding LatencyTotalItems, StringFormat='{}{0:N0} total'}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                                <Border Classes="badge badge-gray" Margin="6,0,0,0"><TextBlock Text="{Binding HighLatencyConnections.Count, StringFormat='Showing {0:N0}'}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                                <TextBlock Text="{Binding LatencyThreshold, StringFormat='â‰¥{0:F0} ms'}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondary}" Margin="12,0,0,0"/>
                            </StackPanel>
                            <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export latency connections to CSV">
                                <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                            </Button>
                        </Grid>
                    </Border>

                    <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                        <ItemsControl ItemsSource="{Binding HighLatencyConnections}" Margin="0,8,0,8">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Classes="ranked-table-row">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/><ColumnDefinition Width="140"/><ColumnDefinition Width="140"/><ColumnDefinition Width="80"/><ColumnDefinition Width="100"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="100"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="80"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="60"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding RowNumber}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium" Foreground="{DynamicResource TextMuted}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="{Binding SourceIP}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding SourceIP}"/>
                                            <TextBlock Grid.Column="2" Text="{Binding DestinationIP}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding DestinationIP}"/>
                                            <Border Grid.Column="3" Classes="service-badge"><TextBlock Text="{Binding Protocol}" FontSize="{DynamicResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                            <TextBlock Grid.Column="4" Text="{Binding PortRange}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="5" Text="{Binding MinLatencyFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="6" Text="{Binding P5LatencyFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{StaticResource FilterIncludeText}" HorizontalAlignment="Right" VerticalAlignment="Center" ToolTip.Tip="5th percentile"/>
                                            <TextBlock Grid.Column="7" Text="{Binding AverageLatencyFormatted}" FontSize="{DynamicResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource AccentPrimary}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="8" Text="{Binding P95LatencyFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{StaticResource MetricJitterAll}" HorizontalAlignment="Right" VerticalAlignment="Center" ToolTip.Tip="95th percentile"/>
                                            <TextBlock Grid.Column="9" Text="{Binding MaxLatencyFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource SlackWarning}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <Border Grid.Column="10" Background="{Binding SeverityColor}" CornerRadius="3" Padding="6,2" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding LatencySeverity}" FontSize="{DynamicResource FontSizeXS}" FontWeight="SemiBold" Foreground="White"/>
                                            </Border>
                                            <TextBlock Grid.Column="11" Text="{Binding PacketCount, StringFormat='{}{0:N0}'}" FontSize="{DynamicResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource AccentPrimary}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="12" Text="{Binding Duration}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <Button Grid.Column="13" Command="{Binding $parent[UserControl].DataContext.ShowLatencyDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <Border Grid.Row="2" Classes="pagination-controls">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <TextBlock Text="Per page:" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Button Content="30" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="40" Classes="secondary-action" Click="LatencyPageSize30_Click"/>
                                    <Button Content="100" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="40" Classes="secondary-action" Click="LatencyPageSize100_Click"/>
                                </StackPanel>
                            </StackPanel>
                            <TextBlock Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondary}">
                                <Run Text="Page"/><Run Text="{Binding LatencyCurrentPage}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/><Run Text="of"/><Run Text="{Binding LatencyTotalPages}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/>
                            </TextBlock>
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                                <Button Content="â® First" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="LatencyFirstPage_Click" ToolTip.Tip="Go to first page"/>
                                <Button Content="â—€â—€ -10" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="LatencyJumpBack10_Click" ToolTip.Tip="Jump back 10 pages"/>
                                <Button Content="â—€ Prev" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="LatencyPrevPage_Click" ToolTip.Tip="Previous page"/>
                                <Button Content="Next â–¶" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="LatencyNextPage_Click" ToolTip.Tip="Next page"/>
                                <Button Content="+10 â–¶â–¶" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="LatencyJumpForward10_Click" ToolTip.Tip="Jump forward 10 pages"/>
                                <Button Content="Last â­" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="LatencyLastPage_Click" ToolTip.Tip="Go to last page"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- Top Latency Endpoints -->
            <Grid Grid.Row="6" Margin="0,0,0,20" ColumnDefinitions="*,24,*">
                <Border Grid.Column="0" Classes="modern-card-unified">
                    <Border Classes="modern-card-inner">
                        <Grid RowDefinitions="Auto,*">
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Border Width="3" Height="20" Background="{DynamicResource AccentPrimary}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                        <TextBlock Text="Top Latency Sources" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export latency sources to CSV">
                                        <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding StatisticsViewModel.TopLatencySourcesExtended}" Margin="0,8,0,8" ItemTemplate="{StaticResource EndpointRowTemplate}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Border>
                <Border Grid.Column="2" Classes="modern-card-unified">
                    <Border Classes="modern-card-inner">
                        <Grid RowDefinitions="Auto,*">
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Border Width="3" Height="20" Background="{DynamicResource AccentPrimary}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                        <TextBlock Text="Top Latency Destinations" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export latency destinations to CSV">
                                        <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding StatisticsViewModel.TopLatencyDestinationsExtended}" Margin="0,8,0,8" ItemTemplate="{StaticResource EndpointRowTemplate}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Border>
            </Grid>

            <!-- High Jitter Section -->
            <Border Grid.Row="7" Classes="modern-card-unified" MinHeight="300">
                <Grid RowDefinitions="Auto,*,Auto">
                    <Border Grid.Row="0" Classes="table-header-unified">
                        <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <Border Width="3" Height="20" Background="{DynamicResource SlackWarning}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                <TextBlock Text="High Jitter Connections" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <Border Classes="badge badge-blue" Margin="12,0,0,0"><TextBlock Text="{Binding JitterTotalItems, StringFormat='{}{0:N0} total'}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                                <Border Classes="badge badge-gray" Margin="6,0,0,0"><TextBlock Text="{Binding HighJitterConnections.Count, StringFormat='Showing {0:N0}'}" FontSize="{DynamicResource FontSizeSmall}"/></Border>
                                <TextBlock Text="{Binding JitterThreshold, StringFormat='â‰¥{0:F0} ms'}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondary}" Margin="12,0,0,0"/>
                            </StackPanel>
                            <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export jitter connections to CSV">
                                <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                            </Button>
                        </Grid>
                    </Border>

                    <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                        <ItemsControl ItemsSource="{Binding HighJitterConnections}" Margin="0,8,0,8">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Classes="ranked-table-row">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/><ColumnDefinition Width="140"/><ColumnDefinition Width="140"/><ColumnDefinition Width="80"/><ColumnDefinition Width="100"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="100"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="80"/><ColumnDefinition Width="90"/><ColumnDefinition Width="90"/><ColumnDefinition Width="60"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding RowNumber}" FontSize="{DynamicResource FontSizeSmall}" FontWeight="Medium" Foreground="{DynamicResource TextMuted}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="{Binding SourceIP}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding SourceIP}"/>
                                            <TextBlock Grid.Column="2" Text="{Binding DestinationIP}" FontSize="{DynamicResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip.Tip="{Binding DestinationIP}"/>
                                            <Border Grid.Column="3" Classes="service-badge"><TextBlock Text="{Binding Protocol}" FontSize="{DynamicResource FontSizeXS}" Foreground="{DynamicResource TextMutedBrush}"/></Border>
                                            <TextBlock Grid.Column="4" Text="{Binding PortRange}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="5" Text="{Binding MinJitterFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="6" Text="{Binding P5JitterFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{StaticResource MetricJitterAll}" HorizontalAlignment="Right" VerticalAlignment="Center" ToolTip.Tip="5th percentile"/>
                                            <TextBlock Grid.Column="7" Text="{Binding AverageJitterFormatted}" FontSize="{DynamicResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource SlackWarning}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="8" Text="{Binding P95JitterFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{StaticResource FilterExcludeText}" HorizontalAlignment="Right" VerticalAlignment="Center" ToolTip.Tip="95th percentile"/>
                                            <TextBlock Grid.Column="9" Text="{Binding MaxJitterFormatted}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource SlackDanger}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <Border Grid.Column="10" Background="{Binding SeverityColor}" CornerRadius="3" Padding="6,2" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding JitterSeverity}" FontSize="{DynamicResource FontSizeXS}" FontWeight="SemiBold" Foreground="White"/>
                                            </Border>
                                            <TextBlock Grid.Column="11" Text="{Binding PacketCount, StringFormat='{}{0:N0}'}" FontSize="{DynamicResource FontSizeMedium}" FontWeight="SemiBold" Foreground="{DynamicResource SlackWarning}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="12" Text="{Binding Duration}" FontSize="{DynamicResource FontSizeSmall}" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            <Button Grid.Column="13" Command="{Binding $parent[UserControl].DataContext.ShowJitterDetailsCommand}" CommandParameter="{Binding}" Classes="details-btn"><TextBlock Text="Details"/></Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <Border Grid.Row="2" Classes="pagination-controls">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <TextBlock Text="Per page:" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Button Content="30" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="40" Classes="secondary-action" Click="JitterPageSize30_Click"/>
                                    <Button Content="100" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="40" Classes="secondary-action" Click="JitterPageSize100_Click"/>
                                </StackPanel>
                            </StackPanel>
                            <TextBlock Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="{DynamicResource FontSizeMedium}" Foreground="{DynamicResource TextSecondary}">
                                <Run Text="Page"/><Run Text="{Binding JitterCurrentPage}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/><Run Text="of"/><Run Text="{Binding JitterTotalPages}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/>
                            </TextBlock>
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                                <Button Content="â® First" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="JitterFirstPage_Click" ToolTip.Tip="Go to first page"/>
                                <Button Content="â—€â—€ -10" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="JitterJumpBack10_Click" ToolTip.Tip="Jump back 10 pages"/>
                                <Button Content="â—€ Prev" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="JitterPrevPage_Click" ToolTip.Tip="Previous page"/>
                                <Button Content="Next â–¶" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="JitterNextPage_Click" ToolTip.Tip="Next page"/>
                                <Button Content="+10 â–¶â–¶" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="JitterJumpForward10_Click" ToolTip.Tip="Jump forward 10 pages"/>
                                <Button Content="Last â­" FontSize="{DynamicResource FontSizeSmall}" Padding="8,4" MinWidth="55" Classes="secondary-action" Click="JitterLastPage_Click" ToolTip.Tip="Go to last page"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- Top Jitter Endpoints -->
            <Grid Grid.Row="8" Margin="0,0,0,20" ColumnDefinitions="*,24,*">
                <Border Grid.Column="0" Classes="modern-card-unified">
                    <Border Classes="modern-card-inner">
                        <Grid RowDefinitions="Auto,*">
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Border Width="3" Height="20" Background="{DynamicResource SlackWarning}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                        <TextBlock Text="Top Jitter Sources" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export jitter sources to CSV">
                                        <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding StatisticsViewModel.TopJitterSourcesExtended}" Margin="0,8,0,8" ItemTemplate="{StaticResource EndpointRowTemplate}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Border>
                <Border Grid.Column="2" Classes="modern-card-unified">
                    <Border Classes="modern-card-inner">
                        <Grid RowDefinitions="Auto,*">
                            <Border Grid.Row="0" Classes="table-header-unified">
                                <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Border Width="3" Height="20" Background="{DynamicResource SlackWarning}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                        <TextBlock Text="Top Jitter Destinations" FontSize="{DynamicResource FontSizeLarge}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Classes="export-csv" ToolTip.Tip="Export jitter destinations to CSV">
                                        <StackPanel Orientation="Horizontal" Spacing="6"><TextBlock Text="ðŸ“Š" FontSize="{DynamicResource FontSizeLarge}"/><TextBlock Text="Export CSV" FontSize="{DynamicResource FontSizeMedium}" FontWeight="Medium" Foreground="White"/></StackPanel>
                                    </Button>
                                </Grid>
                            </Border>
                            <ScrollViewer Grid.Row="1" Classes="fixed-height-table">
                                <ItemsControl ItemsSource="{Binding StatisticsViewModel.TopJitterDestinationsExtended}" Margin="0,8,0,8" ItemTemplate="{StaticResource EndpointRowTemplate}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Border>
            </Grid>
            </Grid>
        </ScrollViewer>

        <!-- Packet Details Modal Dialog Overlay -->
        <Border IsVisible="{Binding PopupViewModel.IsDetailDialogOpen}" Background="{StaticResource OverlayBlack70}" ZIndex="100">
            <Border Width="1200" Height="700" Background="{DynamicResource BackgroundDark}" CornerRadius="12" BoxShadow="0 8 32 #40000000" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Grid RowDefinitions="Auto,*,Auto" Margin="0">
                    <Border Grid.Row="0" Background="{DynamicResource BackgroundMedium}" Padding="24,16" CornerRadius="12,12,0,0" BorderBrush="{DynamicResource BorderPrimary}" BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="ðŸ“¦ Packet Details" FontSize="{DynamicResource FontSizeXL}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimary}"/>
                                <TextBlock Text="{Binding PopupViewModel.DetailTitle}" FontSize="{DynamicResource FontSizeInput}" Foreground="{DynamicResource TextMuted}" Margin="0,4,0,0" TextWrapping="Wrap"/>
                            </StackPanel>
                            <Button Grid.Column="1" Command="{Binding CloseDetailDialogCommand}" Classes="secondary-action" Padding="12,8" VerticalAlignment="Top">
                                <TextBlock Text="âœ– Close" FontSize="{DynamicResource FontSizeInput}"/>
                            </Button>
                        </Grid>
                    </Border>
                    <Border Grid.Row="1" Margin="24,16">
                        <DataGrid ItemsSource="{Binding PopupViewModel.DetailPackets}" AutoGenerateColumns="False" CanUserSortColumns="True" CanUserResizeColumns="True" Classes="modern-grid" IsReadOnly="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="FRAME #" Binding="{Binding FrameNumber}" Width="80" MinWidth="60"/>
                                <DataGridTextColumn Header="TIMESTAMP" Binding="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss.fff}'}" Width="120" MinWidth="100"/>
                                <DataGridTextColumn Header="SOURCE IP" Binding="{Binding SourceIP}" Width="150" MinWidth="120"/>
                                <DataGridTextColumn Header="SRC PORT" Binding="{Binding SourcePort}" Width="90" MinWidth="70"/>
                                <DataGridTextColumn Header="DEST IP" Binding="{Binding DestinationIP}" Width="150" MinWidth="120"/>
                                <DataGridTextColumn Header="DST PORT" Binding="{Binding DestinationPort}" Width="90" MinWidth="70"/>
                                <DataGridTextColumn Header="PROTOCOL" Binding="{Binding Protocol}" Width="100" MinWidth="80"/>
                                <DataGridTextColumn Header="L7 PROTOCOL" Binding="{Binding L7Protocol}" Width="120" MinWidth="100"/>
                                <DataGridTextColumn Header="LENGTH" Binding="{Binding Length, StringFormat='{}{0:N0}'}" Width="90" MinWidth="70"/>
                                <DataGridTextColumn Header="INFO" Binding="{Binding Info}" Width="*" MinWidth="200"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>
                    <Border Grid.Row="2" Background="{DynamicResource BackgroundMedium}" Padding="24,12" CornerRadius="0,0,12,12" BorderBrush="{DynamicResource BorderPrimary}" BorderThickness="0,1,0,0">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="{Binding PopupViewModel.DetailPackets.Count, StringFormat='Total Packets: {0:N0}'}" FontSize="{DynamicResource FontSizeInput}" Foreground="{DynamicResource TextSecondary}" VerticalAlignment="Center"/>
                            <Button Grid.Column="1" Command="{Binding CloseDetailDialogCommand}" Classes="primary-action" Padding="20,10">
                                <TextBlock Text="Close" FontSize="{DynamicResource FontSizeInput}" FontWeight="Medium"/>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Border>
    </Panel>
</UserControl>
