<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels"
             xmlns:local="using:PCAPAnalyzer.UI.ViewModels.Components"
             xmlns:converters="using:PCAPAnalyzer.UI.Converters"
             x:Class="PCAPAnalyzer.UI.Views.FileManagerView"
             x:DataType="vm:FileManagerViewModel">

    <UserControl.Resources>
        <converters:EnumEqualsConverter x:Key="EnumEqualsConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Section Header Styles -->
        <Style Selector="TextBlock.SectionHeader">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#F0F6FC"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>

        <!-- Card Container Styles -->
        <Style Selector="Border.Card">
            <Setter Property="Background" Value="#161B22"/>
            <Setter Property="BorderBrush" Value="#30363D"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="BoxShadow" Value="0 2 8 2 #00000040"/>
        </Style>

        <!-- Info Label Styles -->
        <Style Selector="TextBlock.InfoLabel">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Foreground" Value="#8B949E"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
        </Style>

        <!-- Info Value Styles -->
        <Style Selector="TextBlock.InfoValue">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="#C9D1D9"/>
        </Style>

        <!-- Stat Card Styles -->
        <Style Selector="Border.StatCard">
            <Setter Property="Background" Value="#0D1117"/>
            <Setter Property="BorderBrush" Value="#30363D"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="MinWidth" Value="150"/>
        </Style>

        <!-- Stat Icon Styles -->
        <Style Selector="TextBlock.StatIcon">
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>

        <!-- Stat Value Styles -->
        <Style Selector="TextBlock.StatValue">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#F0F6FC"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>

        <!-- Stat Label Styles -->
        <Style Selector="TextBlock.StatLabel">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="#8B949E"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>

        <!-- Action Button Styles -->
        <Style Selector="Button.ActionButton">
            <Setter Property="Height" Value="36"/>
            <Setter Property="Padding" Value="16,8"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.15"/>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.15"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Button.ActionButton:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.02)"/>
        </Style>

        <Style Selector="Button.ActionButton.Primary">
            <Setter Property="Background" Value="#238636"/>
            <Setter Property="BorderBrush" Value="#2EA043"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <Style Selector="Button.ActionButton.Primary:pointerover">
            <Setter Property="Background" Value="#2EA043"/>
            <Setter Property="BorderBrush" Value="#3FB950"/>
        </Style>

        <Style Selector="Button.ActionButton.Secondary">
            <Setter Property="Background" Value="#21262D"/>
            <Setter Property="BorderBrush" Value="#30363D"/>
            <Setter Property="Foreground" Value="#C9D1D9"/>
        </Style>

        <Style Selector="Button.ActionButton.Secondary:pointerover">
            <Setter Property="Background" Value="#30363D"/>
            <Setter Property="BorderBrush" Value="#484F58"/>
        </Style>

        <Style Selector="Button.ActionButton.Danger">
            <Setter Property="Background" Value="#DA3633"/>
            <Setter Property="BorderBrush" Value="#F85149"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <Style Selector="Button.ActionButton.Danger:pointerover">
            <Setter Property="Background" Value="#F85149"/>
            <Setter Property="BorderBrush" Value="#FF7B72"/>
        </Style>

        <!-- Status Badge Styles -->
        <Style Selector="Border.StatusBadge">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <Style Selector="Border.StatusBadge.Success">
            <Setter Property="Background" Value="#238636"/>
            <Setter Property="BorderBrush" Value="#2EA043"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <Style Selector="Border.StatusBadge.Info">
            <Setter Property="Background" Value="#1F4788"/>
            <Setter Property="BorderBrush" Value="#58A6FF"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- Progress Panel Animations -->
        <Style Selector="Border.ProgressPanel">
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.3" Easing="CubicEaseInOut"/>
                    <ThicknessTransition Property="Margin" Duration="0:0:0.3" Easing="CubicEaseInOut"/>
                </Transitions>
            </Setter>
        </Style>

        <!-- Progress Bar Animation -->
        <Style Selector="ProgressBar">
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Value" Duration="0:0:0.5" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>

        <!-- Stage Item Animations -->
        <Style Selector="TextBlock.StageIcon">
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Foreground" Duration="0:0:0.3"/>
                </Transitions>
            </Setter>
        </Style>

        <!-- Active Stage Pulsing Animation -->
        <Style Selector="TextBlock.ActiveStageIcon">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.5"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>

    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  Background="#0D1117">
        <StackPanel Margin="24" Spacing="24">

            <!-- File Upload Section (Full Width & Clickable) -->
            <Border Classes="Card">
                <StackPanel Spacing="20">
                    <TextBlock Text="ðŸ“‚ File Upload &amp; Analysis" Classes="SectionHeader" HorizontalAlignment="Center"/>

                    <!-- Clickable File Upload Area with Drag & Drop Support -->
                    <!-- Command switches between Browse and Cancel based on countdown state -->
                    <Button Command="{Binding BrowseOrCancelCommand}"
                            Background="{Binding IsCountdownActive, Converter={x:Static converters:BoolToColorConverter.CountdownBackground}}"
                            BorderBrush="{Binding IsCountdownActive, Converter={x:Static converters:BoolToColorConverter.CountdownBorder}}"
                            BorderThickness="2"
                            CornerRadius="8"
                            Padding="32,24"
                            HorizontalAlignment="Stretch"
                            Cursor="Hand"
                            HorizontalContentAlignment="Stretch"
                            DragDrop.AllowDrop="True"
                            DragDrop.DragOver="OnDragOver"
                            DragDrop.Drop="OnDrop">
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.25"/>
                                        <BrushTransition Property="BorderBrush" Duration="0:0:0.25"/>
                                        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="Button:pointerover">
                                <Setter Property="Background" Value="#161B22"/>
                                <Setter Property="BorderBrush" Value="#79C0FF"/>
                                <Setter Property="RenderTransform" Value="scale(1.01)"/>
                            </Style>
                            <Style Selector="Button:pressed">
                                <Setter Property="Background" Value="#0D1117"/>
                                <Setter Property="RenderTransform" Value="scale(0.99)"/>
                            </Style>
                        </Button.Styles>

                        <Grid RowDefinitions="Auto,Auto">
                            <!-- COUNTDOWN OVERLAY - shown when countdown active -->
                            <StackPanel Grid.Row="0"
                                        Grid.RowSpan="2"
                                        IsVisible="{Binding IsCountdownActive}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="8">
                                <!-- Large countdown number with pulsing opacity animation -->
                                <TextBlock Text="{Binding CountdownDisplay}"
                                          FontSize="72"
                                          FontWeight="Bold"
                                          Foreground="White"
                                          HorizontalAlignment="Center">
                                    <TextBlock.Styles>
                                        <Style Selector="TextBlock">
                                            <Style.Animations>
                                                <Animation Duration="0:0:1" IterationCount="Infinite">
                                                    <KeyFrame Cue="0%">
                                                        <Setter Property="Opacity" Value="1.0"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="50%">
                                                        <Setter Property="Opacity" Value="0.5"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="100%">
                                                        <Setter Property="Opacity" Value="1.0"/>
                                                    </KeyFrame>
                                                </Animation>
                                            </Style.Animations>
                                        </Style>
                                    </TextBlock.Styles>
                                </TextBlock>
                                <TextBlock Text="Starting analysis..."
                                          FontSize="16"
                                          FontWeight="SemiBold"
                                          Foreground="#FFC9C9"
                                          HorizontalAlignment="Center"/>
                                <TextBlock Text="Click anywhere to cancel"
                                          FontSize="12"
                                          Foreground="#FF9999"
                                          HorizontalAlignment="Center"
                                          Margin="0,8,0,0"/>
                            </StackPanel>

                            <!-- Browse Icon & Message (when no file AND no countdown) -->
                            <StackPanel Grid.Row="0"
                                       Spacing="12"
                                       HorizontalAlignment="Center"
                                       IsVisible="{Binding ShowBrowseMessage}">
                                <TextBlock Text="ðŸ“"
                                          FontSize="48"
                                          HorizontalAlignment="Center"
                                          Opacity="0.8"/>
                                <TextBlock Text="Click to browse or drag &amp; drop PCAP file"
                                          FontSize="16"
                                          FontWeight="Medium"
                                          Foreground="#58A6FF"
                                          HorizontalAlignment="Center"/>
                                <TextBlock Text="Supported formats: .pcap, .pcapng, .cap"
                                          FontSize="12"
                                          Foreground="#8B949E"
                                          HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- âœ… REDESIGNED: Selected File Info (centered, harmonized layout) -->
                            <!-- Hidden during countdown to show countdown overlay instead -->
                            <StackPanel Grid.Row="0"
                                        IsVisible="{Binding ShowFileInfo}"
                                        HorizontalAlignment="Center"
                                        MaxWidth="700">

                                <!-- Primary: Filename (large, prominent) -->
                                <StackPanel Orientation="Horizontal"
                                            HorizontalAlignment="Center"
                                            Spacing="12"
                                            Margin="0,0,0,16">
                                    <TextBlock Text="ðŸ“„"
                                              FontSize="24"
                                              VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding FileName}"
                                              FontSize="18"
                                              FontWeight="Bold"
                                              Foreground="#F0F6FC"
                                              VerticalAlignment="Center"/>
                                </StackPanel>

                                <!-- Secondary: File size (medium prominence) -->
                                <TextBlock HorizontalAlignment="Center"
                                          Margin="0,0,0,8">
                                    <Run Text="ðŸ’¾"
                                         FontSize="14"/>
                                    <Run Text="{Binding FileSizeFormatted}"
                                         FontSize="15"
                                         FontWeight="SemiBold"
                                         Foreground="#58A6FF"/>
                                </TextBlock>

                                <!-- Capture Time Range (prominent, own line) -->
                                <TextBlock HorizontalAlignment="Center"
                                          Margin="0,0,0,12"
                                          IsVisible="{Binding CaptureTimeRange, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                    <Run Text="ðŸ“¡" FontSize="16"/>
                                    <Run Text=" "/>
                                    <Run Text="{Binding CaptureTimeRange}"
                                         FontSize="16"
                                         FontWeight="SemiBold"
                                         Foreground="#58A6FF"/>
                                </TextBlock>

                                <!-- Tertiary: Metadata row (file timestamps) -->
                                <StackPanel Orientation="Horizontal"
                                            HorizontalAlignment="Center"
                                            Spacing="24">

                                    <!-- File Created timestamp (European format) -->
                                    <StackPanel Orientation="Horizontal"
                                                Spacing="6">
                                        <TextBlock Text="ðŸ“…"
                                                  FontSize="12"
                                                  Foreground="#2EA043"
                                                  VerticalAlignment="Center"/>
                                        <TextBlock FontSize="12"
                                                  Foreground="#8B949E"
                                                  VerticalAlignment="Center">
                                            <Run Text="Created:"/>
                                            <Run Text="{Binding FileCreatedDate, StringFormat='{}{0:dd.MM.yyyy HH:mm:ss}'}"
                                                 Foreground="#2EA043"
                                                 FontWeight="Medium"/>
                                        </TextBlock>
                                    </StackPanel>

                                    <!-- File Modified timestamp (European format) -->
                                    <StackPanel Orientation="Horizontal"
                                                Spacing="6">
                                        <TextBlock Text="ðŸ•"
                                                  FontSize="12"
                                                  Foreground="#F78166"
                                                  VerticalAlignment="Center"/>
                                        <TextBlock FontSize="12"
                                                  Foreground="#8B949E"
                                                  VerticalAlignment="Center">
                                            <Run Text="Modified:"/>
                                            <Run Text="{Binding FileModifiedDate, StringFormat='{}{0:dd.MM.yyyy HH:mm:ss}'}"
                                                 Foreground="#F78166"
                                                 FontWeight="Medium"/>
                                        </TextBlock>
                                    </StackPanel>

                                    <!-- Status Badge -->
                                    <Border Classes="StatusBadge"
                                            Classes.Success="{Binding IsAnalysisComplete}"
                                            Classes.Info="{Binding !IsAnalysisComplete}"
                                            VerticalAlignment="Center">
                                        <TextBlock Text="{Binding StatusText}"
                                                  FontSize="11"
                                                  FontWeight="SemiBold"
                                                  Foreground="White"/>
                                    </Border>
                                </StackPanel>

                                <!-- Quaternary: Full path (subtle, truncated) -->
                                <TextBlock Text="{Binding FilePath}"
                                          FontSize="11"
                                          Foreground="#6E7681"
                                          HorizontalAlignment="Center"
                                          TextTrimming="CharacterEllipsis"
                                          MaxWidth="650"
                                          Margin="0,8,0,0"
                                          ToolTip.Tip="{Binding FilePath}"/>
                            </StackPanel>
                        </Grid>
                    </Button>

                    <!-- Analysis Control Buttons (merged into upload section) -->
                    <StackPanel Orientation="Horizontal"
                               Spacing="12"
                               HorizontalAlignment="Center"
                               IsVisible="{Binding HasFile}">
                        <Button Content="âš¡ Analyze"
                                Command="{Binding AnalyzeCommand}"
                                Classes="ActionButton Primary"
                                IsEnabled="{Binding CanAnalyze}"
                                IsVisible="{Binding !IsCountdownActive}"
                                MinWidth="120"/>
                        <Button Content="ðŸ—‘ï¸ Clear"
                                Command="{Binding ClearCommand}"
                                Classes="ActionButton Secondary"
                                IsEnabled="{Binding HasFile}"
                                MinWidth="100"/>
                        <!-- Export Report button removed per user request -->
                    </StackPanel>

                    <!-- Last Analysis Info -->
                    <TextBlock Text="{Binding LastAnalysisText}"
                              FontSize="12"
                              Foreground="#8B949E"
                              HorizontalAlignment="Center"
                              IsVisible="{Binding IsAnalysisComplete}"/>
                </StackPanel>
            </Border>

            <!-- Analysis Progress Section (only visible during analysis) -->
            <Border Classes="Card ProgressPanel" IsVisible="{Binding IsAnalyzing}">
                <StackPanel Spacing="16">
                    <TextBlock Text="âš¡ Analysis Progress" Classes="SectionHeader"/>

                    <!-- Overall Progress Bar -->
                    <Border Background="#0D1117"
                            BorderBrush="#30363D"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="16">
                        <StackPanel Spacing="12">
                            <!-- Progress Header -->
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="{Binding CurrentPhase}"
                                              FontSize="14"
                                              FontWeight="SemiBold"
                                              Foreground="#58A6FF"
                                              VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding AnalysisProgress, StringFormat='{}{0:F1}%'}"
                                              FontSize="18"
                                              FontWeight="Bold"
                                              Foreground="#F0F6FC"
                                              VerticalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                                    <StackPanel Spacing="2">
                                        <TextBlock Text="Elapsed" FontSize="10" Foreground="#8B949E" HorizontalAlignment="Center"/>
                                        <TextBlock Text="{Binding ElapsedTimeFormatted}"
                                                  FontSize="12"
                                                  FontWeight="Medium"
                                                  Foreground="#C9D1D9"
                                                  HorizontalAlignment="Center"/>
                                    </StackPanel>

                                    <TextBlock Text="â€¢" Foreground="#8B949E" VerticalAlignment="Center"/>

                                    <StackPanel Spacing="2">
                                        <TextBlock Text="Rate" FontSize="10" Foreground="#8B949E" HorizontalAlignment="Center"/>
                                        <TextBlock Text="{Binding ProcessingRateFormatted}"
                                                  FontSize="12"
                                                  FontWeight="Medium"
                                                  Foreground="#C9D1D9"
                                                  HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            <!-- Main Progress Bar -->
                            <ProgressBar Value="{Binding AnalysisProgress}"
                                        Minimum="0"
                                        Maximum="100"
                                        Height="8"
                                        CornerRadius="4"
                                        Background="#161B22"
                                        Foreground="#58A6FF"/>

                            <!-- Current Packet Count -->
                            <TextBlock FontSize="12"
                                      Foreground="#8B949E"
                                      HorizontalAlignment="Center">
                                <Run Text="{Binding CurrentPacketCount, StringFormat='{}{0:N0}'}"/>
                                <Run Text="packets processed"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>

                    <!-- âœ… Stage Breakdown removed - now shown in compact grid below after overlay dismisses -->
                </StackPanel>
            </Border>

            <!-- Analysis Statistics Section (only show after analysis) -->
            <Border Classes="Card" IsVisible="{Binding IsAnalysisComplete}">
                <StackPanel Spacing="16">
                    <TextBlock Text="ðŸ“Š Analysis Statistics" Classes="SectionHeader"/>

                    <!-- File-Specific Stats Grid (2x3) -->
                    <Grid ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto" RowSpacing="12" ColumnSpacing="12">
                        <!-- Packet Count -->
                        <Border Grid.Row="0" Grid.Column="0" Classes="StatCard">
                            <StackPanel>
                                <TextBlock Text="ðŸ“¦" Classes="StatIcon" Foreground="#58A6FF"/>
                                <TextBlock Text="{Binding PacketCount}" Classes="StatValue" Foreground="#F0F6FC"/>
                                <TextBlock Text="total packets" Classes="StatLabel" Foreground="#8B949E"/>
                            </StackPanel>
                        </Border>

                        <!-- File Size -->
                        <Border Grid.Row="0" Grid.Column="1" Classes="StatCard">
                            <StackPanel>
                                <TextBlock Text="ðŸ’¾" Classes="StatIcon" Foreground="#58A6FF"/>
                                <TextBlock Text="{Binding CaptureFileSize}" Classes="StatValue" Foreground="#58A6FF"/>
                                <TextBlock Text="file size" Classes="StatLabel" Foreground="#8B949E"/>
                            </StackPanel>
                        </Border>

                        <!-- Capture Duration -->
                        <Border Grid.Row="0" Grid.Column="2" Classes="StatCard">
                            <StackPanel>
                                <TextBlock Text="â±ï¸" Classes="StatIcon" Foreground="#F78166"/>
                                <TextBlock Text="{Binding Duration}" Classes="StatValue" Foreground="#F78166"/>
                                <TextBlock Text="capture duration" Classes="StatLabel" Foreground="#8B949E"/>
                            </StackPanel>
                        </Border>

                        <!-- Processing Rate -->
                        <Border Grid.Row="1" Grid.Column="0" Classes="StatCard">
                            <StackPanel>
                                <TextBlock Text="âš¡" Classes="StatIcon" Foreground="#F0E68C"/>
                                <TextBlock Text="{Binding ProcessingRate}" Classes="StatValue" Foreground="#F0E68C"/>
                                <TextBlock Text="pkts/sec rate" Classes="StatLabel" Foreground="#8B949E"/>
                            </StackPanel>
                        </Border>

                        <!-- Analysis Time -->
                        <Border Grid.Row="1" Grid.Column="1" Classes="StatCard">
                            <StackPanel>
                                <TextBlock Text="â²ï¸" Classes="StatIcon" Foreground="#2EA043"/>
                                <TextBlock Text="{Binding AnalysisTime}" Classes="StatValue" Foreground="#2EA043"/>
                                <TextBlock Text="analysis time" Classes="StatLabel" Foreground="#8B949E"/>
                            </StackPanel>
                        </Border>

                        <!-- Completion Status -->
                        <Border Grid.Row="1" Grid.Column="2" Classes="StatCard">
                            <StackPanel>
                                <TextBlock Text="âœ…" Classes="StatIcon" Foreground="#2EA043"/>
                                <TextBlock Text="Complete" Classes="StatValue" FontSize="18" Foreground="#2EA043"/>
                                <TextBlock Text="analysis status" Classes="StatLabel" Foreground="#8B949E"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- âœ… COMPACT GRID: Analysis Stages - 3-column responsive layout -->
            <!-- âœ… FIX: Visible when file loaded OR analysis complete (OR logic in ShouldShowStages property) -->
            <Border Classes="Card" IsVisible="{Binding ShouldShowStages}">
                <StackPanel Spacing="12">
                    <!-- Header with optional capture time range -->
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0" Text="ðŸ“Š Analysis Stages" Classes="SectionHeader"/>
                        <!-- PCAP Capture Time Period (shown when available) -->
                        <TextBlock Grid.Column="1"
                                  IsVisible="{Binding CaptureTimeRange, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                  VerticalAlignment="Center"
                                  Margin="0,0,0,12">
                            <Run Text="ðŸ“¡" FontSize="14"/>
                            <Run Text=" "/>
                            <Run Text="{Binding CaptureTimeRange}"
                                 FontSize="14"
                                 FontWeight="SemiBold"
                                 Foreground="#58A6FF"/>
                        </TextBlock>
                    </Grid>

                    <!-- âœ… FIX: Added ScrollViewer to ensure all 7 stages are visible -->
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollBarVisibility="Auto"
                                  MaxHeight="600">
                        <!-- 3-Column Grid with WrapPanel for responsive layout -->
                        <ItemsControl ItemsSource="{Binding AnalysisStages}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" ItemWidth="450"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="local:AnalysisProgressStage">
                                <!-- âœ… ENHANCED Stage Card: 75px height with 2 separate text rows -->
                                <Border Background="#0D1117"
                                        BorderBrush="#30363D"
                                        BorderThickness="1"
                                        CornerRadius="4"
                                        Padding="12,10"
                                        Margin="0,0,12,10"
                                        MinHeight="75">
                                    <!-- Grid: Icon + Content Grid + Time/Progress -->
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <!-- Icon with pulsing animation for active stages -->
                                        <TextBlock Grid.Column="0"
                                                  Text="{Binding StateIcon}"
                                                  FontSize="18"
                                                  Foreground="{Binding StateColor}"
                                                  Classes="StageIcon"
                                                  Classes.ActiveStageIcon="{Binding State, Converter={StaticResource EnumEqualsConverter}, ConverterParameter={x:Static local:AnalysisStageState.Active}}"
                                                  VerticalAlignment="Top"
                                                  Margin="0,2,12,0"/>

                                        <!-- Content: Name and Description in SEPARATE ROWS -->
                                        <Grid Grid.Column="1" RowDefinitions="Auto,Auto" VerticalAlignment="Center">
                                            <!-- Row 1: Stage Name -->
                                            <TextBlock Grid.Row="0"
                                                      Text="{Binding Name}"
                                                      FontSize="13"
                                                      FontWeight="SemiBold"
                                                      Foreground="#F0F6FC"
                                                      TextWrapping="NoWrap"
                                                      TextTrimming="None"
                                                      Margin="0,0,0,4"/>

                                            <!-- Row 2: Stage Detail/Description (shows "Waiting..." for pending) -->
                                            <TextBlock Grid.Row="1"
                                                      Text="{Binding DisplayDetail}"
                                                      FontSize="11"
                                                      Foreground="#8B949E"
                                                      TextWrapping="Wrap"
                                                      TextTrimming="CharacterEllipsis"
                                                      MaxLines="2"/>
                                        </Grid>

                                        <!-- Elapsed Time + Mini Progress (right-aligned) -->
                                        <StackPanel Grid.Column="2"
                                                   Orientation="Vertical"
                                                   Spacing="6"
                                                   VerticalAlignment="Center"
                                                   MinWidth="80">
                                            <!-- Elapsed Time (bold, visible always) -->
                                            <TextBlock Text="{Binding ElapsedTime}"
                                                      FontSize="12"
                                                      FontWeight="Bold"
                                                      Foreground="#58A6FF"
                                                      HorizontalAlignment="Right"/>

                                            <!-- Mini Progress Bar (only during analysis) -->
                                            <ProgressBar Value="{Binding PercentComplete}"
                                                        Minimum="0"
                                                        Maximum="100"
                                                        Height="5"
                                                        CornerRadius="2"
                                                        Background="#161B22"
                                                        Foreground="{Binding StateColor}"
                                                        IsVisible="{Binding ShowProgressBar}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    </ScrollViewer>
                </StackPanel>
            </Border>

            <!-- Help Text (when no file selected) -->
            <Border Classes="Card" IsVisible="{Binding !HasFile}">
                <StackPanel Spacing="12">
                    <TextBlock Text="Getting Started"
                              FontSize="16"
                              FontWeight="SemiBold"
                              Foreground="#58A6FF"/>
                    <TextBlock TextWrapping="Wrap"
                              Foreground="#8B949E"
                              LineHeight="20">
                        <Run Text="1. Click "/>
                        <Run Text="Browse" FontWeight="Bold"/>
                        <Run Text=" to select a PCAP file (.pcap, .pcapng, .cap)"/>
                        <LineBreak/>
                        <Run Text="2. Click "/>
                        <Run Text="Analyze" FontWeight="Bold"/>
                        <Run Text=" to start processing the file"/>
                        <LineBreak/>
                        <Run Text="3. View results in other tabs: Dashboard, Security Threats, etc."/>
                    </TextBlock>
                </StackPanel>
            </Border>

        </StackPanel>
    </ScrollViewer>
</UserControl>
