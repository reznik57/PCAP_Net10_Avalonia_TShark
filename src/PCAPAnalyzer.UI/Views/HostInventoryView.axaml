<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:PCAPAnalyzer.UI.ViewModels"
             xmlns:ctrl="using:PCAPAnalyzer.UI.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="1400" d:DesignHeight="900"
             x:Class="PCAPAnalyzer.UI.Views.HostInventoryView"
             x:DataType="vm:HostInventoryViewModel">

    <!-- SLACK STYLE -->
    <UserControl.Styles>
        <Style Selector="Border.modern-card">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BackgroundElevated}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="ClipToBounds" Value="True"/>
        </Style>
        <Style Selector="Border.table-header">
            <Setter Property="Background" Value="{DynamicResource BackgroundPanel}"/>
            <Setter Property="Height" Value="48"/>
        </Style>
        <Style Selector="Border.stat-card">
            <Setter Property="Background" Value="{DynamicResource BackgroundPanel}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BackgroundElevated}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="MinHeight" Value="80"/>
        </Style>
        <Style Selector="TextBox.search-box">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BackgroundElevated}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="10,0"/>
        </Style>
        <Style Selector="ComboBox.filter-combo">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BackgroundElevated}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="CornerRadius" Value="6"/>
        </Style>
        <Style Selector="DataGrid">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BackgroundElevated}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{DynamicResource BackgroundElevated}"/>
        </Style>
        <Style Selector="DataGridRow">
            <Setter Property="Background" Value="{DynamicResource BackgroundDark}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        </Style>
        <Style Selector="DataGridRow:pointerover">
            <Setter Property="Background" Value="{StaticResource BackgroundPanel}"/>
        </Style>
        <Style Selector="DataGridRow:selected">
            <Setter Property="Background" Value="{StaticResource BackgroundCard}"/>
        </Style>
        <Style Selector="DataGridColumnHeader">
            <Setter Property="Background" Value="{DynamicResource BackgroundPanel}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="Padding" Value="12,0"/>
        </Style>
        <Style Selector="DataGridCell">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="12,8"/>
        </Style>
        <Style Selector="Button.clear-btn">
            <Setter Property="Background" Value="{DynamicResource BackgroundElevated}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderStrongBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
        </Style>
        <Style Selector="Button.clear-btn:pointerover">
            <Setter Property="Background" Value="{StaticResource BorderStrongBrush}"/>
        </Style>
        <Style Selector="CheckBox">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
    </UserControl.Styles>

    <Grid Background="{DynamicResource BackgroundDark}" Margin="24">
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Spacing="20">

                <!-- Header -->
                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                        <TextBlock Text="ðŸ–¥ï¸" FontSize="{StaticResource FontSizeHeading}" VerticalAlignment="Center"/>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Host Inventory" FontSize="{StaticResource FontSizeXL}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            <TextBlock Text="Passive OS fingerprinting and device detection" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        </StackPanel>
                    </StackPanel>
                    <!-- Total Packets Badge (shows when filtering) -->
                    <Border Grid.Column="2" Background="{DynamicResource BackgroundElevated}" CornerRadius="6" Padding="12,6" Margin="0,0,12,0" VerticalAlignment="Center" IsVisible="{Binding IsFilterActive}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="ðŸ”" FontSize="{StaticResource FontSizeSmall}"/>
                            <TextBlock FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0:N0} of {1:N0} packets ({2:F1}%)">
                                        <Binding Path="FilteredTotalPackets"/>
                                        <Binding Path="UnfilteredTotalPackets"/>
                                        <Binding Path="FilteredPacketsPercentage"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="8">
                        <Button Command="{Binding ExportToCsvCommand}" Classes="clear-btn">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="ðŸ“¥" FontSize="{StaticResource FontSizeBase}"/>
                                <TextBlock Text="Export CSV" FontSize="{StaticResource FontSizeSmall}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>

                <!-- UnifiedFilterPanelControl - General tab (index 0) for HostInventory -->
                <ctrl:UnifiedFilterPanelControl DefaultTabIndex="0" Margin="0,0,0,10" />

                <!-- Host Inventory Stats - Using unified StatsBarControl -->
                <ctrl:StatsBarControl DataContext="{Binding HostStatsBar}" Margin="0,0,0,20"/>

                <!-- Filters -->
                <Border Classes="modern-card" Padding="16">
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto" RowDefinitions="Auto">
                        <TextBox Grid.Column="0" Classes="search-box"
                                 Text="{Binding SearchFilter}"
                                 Watermark="ðŸ” Search by IP, MAC, hostname, or OS..."
                                 Margin="0,0,12,0"/>
                        <ComboBox Grid.Column="1" Classes="filter-combo"
                                  ItemsSource="{Binding OsFilterOptions}"
                                  SelectedItem="{Binding OsFilter}"
                                  Width="150" Margin="0,0,8,0"/>
                        <ComboBox Grid.Column="2" Classes="filter-combo"
                                  ItemsSource="{Binding DeviceTypeFilterOptions}"
                                  SelectedItem="{Binding DeviceTypeFilter}"
                                  Width="150" Margin="0,0,8,0"/>
                        <CheckBox Grid.Column="3" Content="JA3 Verified Only"
                                  IsChecked="{Binding ShowVerifiedOnly}"
                                  VerticalAlignment="Center" Margin="0,0,12,0"/>
                        <Button Grid.Column="4" Command="{Binding ClearFiltersCommand}" Classes="clear-btn">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="ðŸ”„" FontSize="{StaticResource FontSizeSmall}"/>
                                <TextBlock Text="Clear Filters" FontSize="{StaticResource FontSizeSmall}"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>

                <!-- Host Table -->
                <Border Classes="modern-card" MinHeight="500">
                    <Grid RowDefinitions="Auto,*">
                        <!-- Header -->
                        <Border Grid.Row="0" Classes="table-header">
                            <Grid Margin="20,0">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <Border Width="3" Height="20" Background="{DynamicResource AccentPrimary}" CornerRadius="1.5" Margin="0,0,12,0"/>
                                    <TextBlock Text="Detected Hosts" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock Text="{Binding Hosts.Count, StringFormat=' ({0} hosts)'}" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="8,0,0,0" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- DataGrid -->
                        <DataGrid Grid.Row="1"
                                  ItemsSource="{Binding Hosts}"
                                  SelectedItem="{Binding SelectedHost}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  CanUserReorderColumns="True"
                                  CanUserResizeColumns="True"
                                  CanUserSortColumns="True"
                                  SelectionMode="Single"
                                  Margin="1">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="IP Address" Binding="{Binding IpAddress}" Width="130"/>
                                <DataGridTextColumn Header="Hostname" Binding="{Binding Hostname}" Width="150"/>
                                <DataGridTemplateColumn Header="OS" Width="180">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="vm:HostInventoryItem">
                                            <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding OsIcon}" FontSize="{StaticResource FontSizeInput}"/>
                                                <TextBlock Text="{Binding OsDisplayName}" FontSize="{StaticResource FontSizeBase}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Device Type" Binding="{Binding DeviceTypeDisplay}" Width="100"/>
                                <DataGridTemplateColumn Header="Confidence" Width="90">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="vm:HostInventoryItem">
                                            <Border Background="{Binding Confidence, Converter={x:Static vm:ConfidenceToBrushConverter.Instance}}"
                                                    CornerRadius="4" Padding="6,2">
                                                <TextBlock Text="{Binding ConfidenceDisplay}" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Detection" Binding="{Binding DetectionMethodDisplay}" Width="80"/>
                                <DataGridTemplateColumn Header="JA3" Width="50">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="vm:HostInventoryItem">
                                            <TextBlock Text="{Binding VerifiedIcon}" FontSize="{StaticResource FontSizeInput}" HorizontalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="MAC Vendor" Binding="{Binding MacVendor}" Width="140"/>
                                <DataGridTextColumn Header="MAC Address" Binding="{Binding MacAddress}" Width="140"/>
                                <DataGridTextColumn Header="Packets" Binding="{Binding PacketCountDisplay}" Width="80"/>
                                <DataGridTextColumn Header="First Seen" Binding="{Binding FirstSeenDisplay}" Width="140"/>
                                <DataGridTextColumn Header="Last Seen" Binding="{Binding LastSeenDisplay}" Width="140"/>
                                <DataGridTextColumn Header="Open Ports" Binding="{Binding OpenPorts}" Width="150"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <!-- Selected Host Details -->
                <Border Classes="modern-card" Padding="16" IsVisible="{Binding SelectedHost, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Grid RowDefinitions="Auto,Auto,Auto">
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12" Margin="0,0,0,12">
                            <TextBlock Text="ðŸ“‹" FontSize="{StaticResource FontSizeLarge}"/>
                            <TextBlock Text="Host Details" FontSize="{StaticResource FontSizeInput}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            <Button Command="{Binding CopyToClipboardCommand}" CommandParameter="{Binding SelectedHost}" Classes="clear-btn" Height="24" Padding="8,0">
                                <TextBlock Text="ðŸ“‹ Copy" FontSize="{StaticResource FontSizeXS}"/>
                            </Button>
                        </StackPanel>

                        <Grid Grid.Row="1" ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto">
                            <!-- Row 1 -->
                            <StackPanel Grid.Column="0" Grid.Row="0" Margin="0,0,16,12">
                                <TextBlock Text="TCP Fingerprint" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SelectedHost.TcpFingerprint}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Grid.Row="0" Margin="0,0,16,12">
                                <TextBlock Text="JA3 Hash" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SelectedHost.Ja3Hash}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Grid.Row="0" Margin="0,0,0,12">
                                <TextBlock Text="JA3 Application" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SelectedHost.Ja3Application}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </StackPanel>

                            <!-- Row 2 -->
                            <StackPanel Grid.Column="0" Grid.Row="1" Margin="0,0,16,0">
                                <TextBlock Text="Server Banners" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SelectedHost.ServerBanners}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Grid.Row="1" Margin="0,0,16,0">
                                <TextBlock Text="Open Ports" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SelectedHost.OpenPorts}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Grid.Row="1">
                                <TextBlock Text="Confidence Score" FontSize="{StaticResource FontSizeXS}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SelectedHost.ConfidencePercentage}" FontSize="{StaticResource FontSizeSmall}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
